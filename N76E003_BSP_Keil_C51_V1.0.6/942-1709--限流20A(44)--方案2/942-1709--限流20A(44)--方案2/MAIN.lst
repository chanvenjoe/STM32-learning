C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN MAIN.obj
COMPILER INVOKED BY: D:\Keil5 for ARM\C51\BIN\C51.EXE SOURCE\MAIN.c COMPACT OMF2 OPTIMIZE(8,SPEED) BROWSE DEBUG PRINT(.\
                    -MAIN.lst) TABS(2) OBJECT(MAIN.obj)

line level    source

   1          /*--------------------------------------------------------------------------------------------------------
             --*/
   2          /*                                                                                                        
             - */
   3          /* Copyright(c) 2017 Nuvoton Technology Corp. All rights reserved.                                        
             - */
   4          /*                                                                                                        
             - */
   5          /*--------------------------------------------------------------------------------------------------------
             --*/
   6           //升级记录
   7          
   8          ////20170619 G/S修改成低电平有效  .A-DET PORT功能取消 
   9          //20180327 修改为型号M92 1取消大电流增加PWM功能
  10          //2 G/S引脚功能取消，改为由P11采样霍尔控制车速1-2.5V对应高速15-98或低速15-60%   
  11          //20180505 增加刹车脚STOP，P00=STOP;内部上拉；低电平时，停止输出；
  12          //20180507   P00 POWER功能删除
  13          //20180508   P00加上拉
  14          //20181008  //IO改一下；
  15                     //速度开关改为用AD读，且把进退也放在这里检测；
  16                     //增加电压检测
  17                      //GS改为用霍尔
  18          //20181126 //1.三档PWM分别改为：低->40% 中->70% 高->97%;
  19                        //2.缓启动时间降低30%。
  20          //20181210     DelayOffTM=20;改成 DelayOffTM=2; PWM关了，延时拉低FC&BC输出低电平的时间 0.4S， 改成50MS
  21          //20181218   增加电流 18 20 25分别不同时间保护
  22                  //   1 18A，2分钟，
  23                 //    2 20A，5秒钟
  24                 //    3 25A，2秒钟 
  25          //20181219   M92客户 把慢启动时间加快至1.8秒
  26          //20181224 1.去掉P01的电源控制功能，改为控制LED;去掉P10脚功能；使用常闭式电源开关，不再管理电源通断；
  27                   //   2.P01为LED控制脚，可指示电源和故障； 
  28                    //  1高电平有效；
  29                    //  2开机电源灯常亮；
  30                   // 3过流，灯快闪（亮0.1秒，灭0.1秒，保护动作后，循环）；
  31                   //  4欠压，灯闪（亮1秒，灭1秒，保护动作后，循环）；
  32                  //  5充电中，灯亮0.1秒，灭0.5秒，循环；
  33                 // 6解除保护后，灯回复正常长亮；
  34                  // 3.过流检测值加大，
  35                  //   1 25A，2分钟，
  36                 //    2 30A，5秒钟
  37                 //    3 35A，2秒钟  
  38           
  39           //20190105 要三个版本刹车 0秒   慢启动 1.2秒;
  40                     //刹车 0秒   慢启动 1.5秒;
  41                      //刹车 0秒   慢启动 1.8秒;
  42          
  43           //20190225 按文档“功能修改9B20 M92.doc”修改
  44           
  45            //20190704  去掉档位板上的霍尔调节----ok
  46            //20190710  将刹车PWM由2%改为3%----ok
  47            //20190717 去掉PWM_EN  同时将PWN改为PWM互补模式（P00为下桥输出  P05为上桥输出）-----ok
  48            //20190725  加入看门狗程序------------ok
  49            //20190731  将倒档和一档在6A保护，保护时间由2min改为30s  且二档和三档任保持2min保护-----ok
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 2   

  50           //20190802  倒档电压是：0V--1V 改为：0V--0.5V ---------ok
  51           //          一档电压是：1V--2.5V 改为: 0.5V--2.5V--------ok
  52           //          将低电检测时间由： 2s改为：3s  -----ok     
  53            //20190807  更改每个档位占空比：倒档30% 一档30% 二档60% 三档100%-----------ok      //到这里是出货的版本 
             - 9fe7  600台
  54            //20190828   将死区时间由2us加大到6us-------ok
  55          
  56          //20190829 //1.本版增加MOS管短路检测；
  57                     //2.A_DET大电流检测--没有加检测延时
  58                     //3.脚踏板检测加防接抖，需连续10ms电平不变，才认为是脚踏板有效；
  59          //20190907  //过流保护、档位电流保护，档位板不连接保护时。将停止刹车占空比3%输出-----ok
  60          //20190908  //脚踏后，将延时由10ms加至到50ms生效-----ok
  61          //20190911  //加入测试模式------ok     //到这里是50块样板的出货版本
  62          //20190921   //脚踏板踩下那刻，要判断继电器，接着50ms后，再次判断继电器，无吸合后，才开始mos检测，检测正常
             -则才允许启动--ok         
  63          //20190924     //脚踏板松开时，要加防抖   连续检测到50ms低电平，这时才认为脚踏松开---ok
  64          
  65          //20200509   增加60A级别--过流--灯快闪     
  66          //20210405   油门脚踏变霍尔
  67          //20210416   慢启动时间改为2s
  68          //20210426   增加限流25A功能
  69          //20210508   将最小占空比由20%改至30%
  70          
  71          //20210528   1.限流由25A；2.各档位PWM更改；3.欠压值更改；4.油门故障保护设置大于4V;5.油门启动电压值由1V--1.
             -3V
  72          
  73          //20210806    脚踏快速重启（将继电器判断还在mos管检测前）
  74          
  75          //20210815    增加一二档堵转保护  23A   35A  ---1.5s保护
  76          
  77          //20210902    慢启动改为3s   最大占空比95   
  78           
  79          //20220117    1.堵转保护后 20s 关机
  80          //            2.二档堵转时间由2s减少至1.5s
  81          //            3.二档取消变速功能  和一档一样
  82          
  83          
  84          #include "N76E003.h"
  85          #include <string.h>
  86          #include "Common.h"
  87          #include "Delay.h"
  88          #include "SFR_Macro.h"
  89          
  90          #include "Function_define.h"
  91          #include "TIME_ISP.h"
  92           
  93          #define RELOAD_VALUE_H  (65536-8000)/256 //500US
  94          #define RELOAD_VALUE_L  (65536-8000)%256//500US
  95          
  96            //---------------------------------------------------------
  97          //funtion :Rx IR cortrol FANCAR
  98          //body    :N76E003
  99          //date    :2017 11 28
 100          //in/output:
 101          ////20170619 G/S????????  .A-DET PORT????
 102          //------------------------------------------
 103          
 104          #define  STOP_TM      50//10MS*50=500  刹车时间500MS ,单位10MS  50
 105          
 106          #define  Vol_5V       245 //255 
 107          #define  Vol_4_5V     244 //255    229=4.5
 108          
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 3   

 109          #define  Vol_3_5V   178//255*3.5/5            //档位板电压设置
 110          
 111          #define  Vol_2_5V    128//255*2.5/5
 112          #define  Vol_2V     102//255*2/5
 113          #define  Vol_1V     26//255*1/5  51=1V   26=0.5V
 114          
 115          
 116          #define  Vol_1_88V     96//255*1.88/5 19.2V时IO电压为1.88V
 117          
 118          #define  Vol16V       134//         //欠压检测  低于27V
 119          #define  Vol21_6V     161//     //32.7V  解除欠压   161
 120          
 121          #define     nun_n      6
 122          
 123          
 124          #define POWER_ON_TM     100
 125          
 126          #define  HALL_1000MV         66 //255*1/3.3=77     启动电压由1V改成1.3V
 127          
 128          #define  HALL_4200MV         193//193   //255*2.5/3.3=193
 129          #define  HALL_DV             (HALL_4200MV-HALL_1000MV) //116
 130          //#define  HALL_DV            66
 131          #define  PWM_15        25//255*0.15   38
 132          
 133          #define  HALL_4000MV         245  //255*1/3.3=77
 134          
 135          #define   HALL_0500MV    26
 136          
 137          #define  PWM_30       79//255*60
 138          #define  PWM_30_DV           (PWM_30-PWM_15)//115
 139          
 140          #define  PWM_40       104//255*60
 141          #define  PWM_40_DV           (PWM_40-PWM_15)//115
 142          
 143          #define  PWM_65        168//255*60
 144          #define  PWM_65_DV           (PWM_65-PWM_15)//115
 145          
 146          #define  PWM_98        243//255*98     255=100%     243=95%      248=97%
 147          #define  PWM_98_DV           (PWM_98-PWM_15)//212  
 148          
 149          
 150          #define  ELE10A         42//255*0.466v/5=  10A=33   19
 151          #define  ELE12A         50    //12.5A--5s保护      44
 152          #define  ELE15A         55//255*0.757v/5        52
 153          
 154          #define  ELE17_5A       61//255*0.886v/5         
 155          #define  ELE21A         71//255*0.886v/5         
 156          #define  ELE25A         82//255*1.255v/5        87
 157                                                      
 158                                      
 159          #define  ELE30A         78    //255*1.255v/5  98             27A---2min保护    28.5A--5S保护          99--
             -20200507
 160          #define  ELE32A         92                   //111
 161          #define  ELE35A         100       //255*1.781v/5               113---20200507
 162            
 163          #define  ELE60A        143//130//230   173---3.4V--60A     3.1V=55A=158    50A=2.81V=143
 164          
 165          
 166          #define  ELE_1A         4
 167          #define  ELE_2A         8//3A
 168          
 169          //#define  PWM_15         40 //255*15/100
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 4   

 170          
 171          #define  PWM_55         140 //255*55/100
 172          #define  PWM_80         204 //255*80/100
 173          
 174          
 175           #define  LED_IO               P12
 176           #define  LED_SET              P12_PushPull_Mode     //故障指示灯--已改
 177          
 178           #define  LED1_IO               P15
 179           #define  LED1_SET              P15_PushPull_Mode
 180          
 181          #define  A_0_IO                  P05
 182          #define  A_0_IO_SET              P05_Input_Mode     //电流检测口---ok
 183           
 184          #define  STOP_IO                  P02   /*充电脚*///    ---ok
 185          #define  STOP_IO_SET             P02_Quasi_Mode //P00_Input_Mode ---已改  P02_Quasi_Mode
 186            
 187            
 188          #define  G_S_IO                  P17
 189          #define  G_S_IO_SET              P17_Input_Mode   
 190            
 191            
 192          //#define  G_S_IO                  P10
 193          //#define  G_S_IO_SET              P10_Input_Mode   
 194          
 195          //#define  POWER_SW_IO          P10
 196          //#define  POWER_SW_IO_SET          P10_Quasi_Mode   
 197          
 198          //#define  PROT            P14
 199          //#define  PROT_SET        P14_Quasi_Mode
 200          #define  RELY            P07
 201          #define  RELY_SET        P07_PushPull_Mode     //不用到该IO口
 202          
 203          
 204          #define  BACK_CTRL         P10
 205          #define  BACK_CTRL_SET     P10_PushPull_Mode    //后退---已改
 206          
 207          
 208          #define  FRONT_CTRL        P00  
 209          #define  FRONT_CTRL_SET    P00_PushPull_Mode     //前进---ok
 210          
 211          
 212          #define PWMOUT            P03// FP23  //
 213          #define PWMOUT_SET         P03_PushPull_Mode //    ok
 214          
 215          #define PWMOUTt            P01// FP23  //
 216          #define PWMOUTt_SET        P01_PushPull_Mode //   ok
 217          
 218          
 219          #define  Vol_IO          P11
 220          #define  Vol_IO_SET      P11_Input_Mode     //电压检测---ok
 221          
 222           
 223          #define  A_DET_IO           P06              //短路电流检测---ok
 224          #define  A_DET_IO_SET       P06_Quasi_Mode
 225          
 226          
 227          #define  MOS_DET_IO           P04
 228          #define  MOS_DET_INPUT_SET      P04_Input_Mode
 229            #define  MOS_DET_OUTPUT_SET     P04_PushPull_Mode
 230          
 231          
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 5   

 232          #define  SW_IO           P13
 233          #define  SW_IO_SET      P13_Input_Mode
 234          
 235          #define  POWER_IO          P14
 236          #define  POWER_IO_SET     P14_PushPull_Mode
 237          
 238          
 239          
 240           unsigned char POWER_on_TM;
 241          
 242           unsigned char ELE_BIG_SET2;
 243           unsigned char ELE_BIG_SET1;
 244            unsigned char ELE_BIG_SET3;
 245            unsigned char VoltageLowWait;
 246           unsigned char  ShaCheTM;//2*20MS
 247            unsigned char LED_TM;  //调到闪的频率0.26MS
 248           unsigned char LED_pwm; //中间变量
 249           unsigned char LED_CT;//闪的次数X2
 250           unsigned char CurDanWei_AD;
 251           unsigned char  G_S_HighCT;
 252          unsigned char   ELE_InterruptDISP_TM;
 253          
 254           bit NO_Connet_FL;
 255          
 256          bit turn_zero_fl;
 257           bit  ELE40_BIG_FL;
 258           
 259           bit G_S_old_FL;
 260           bit  G_S_L2H_FL;
 261           
 262             bit  ELE60_BIG_FL;
 263             
 264           unsigned char ELE40_BIG_ct;
 265           unsigned char  ELE40_Small_ct;
 266          
 267           unsigned char  ELE60_BIG_TM;
 268          
 269           unsigned int NO_Connet_ct; 
 270          
 271            bit POWER_ON_IO ;
 272          
 273           unsigned char  ELE_Wait_5s;
 274           unsigned char  VoltageLowCT;
 275          bit  VoltageLowFL;
 276          unsigned char AD_CH,Voltage_AD,DanWei_AD;//PWM_HallSet;
 277          unsigned char ELE50_BIG_ct;
 278          unsigned char ELE50_Small_ct=0;
 279          bit ELE50_BIG_FL;
 280          
 281          unsigned char  DanWei_PWM;
 282          unsigned char PWM_Ele_Set;
 283          unsigned int Hall_Add,HallLowCT;            
 284          unsigned char   Hall_Add_ct;  
 285          unsigned char Cur_ResultNew;
 286          unsigned char  time_500ms;
 287          
 288          unsigned char DanWei;
 289          
 290            unsigned char ELE13_BIG_TM;
 291            unsigned char ELE13_Small_ct;
 292            unsigned char ELE13_BIG_ct;
 293          
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 6   

 294            bit ELE13_BIG_FL;
 295            
 296            bit ELE35_BIG_ERR_FL;
 297            
 298          bit ELE_ERR_FL;
 299           bit BIT_TMP;
 300           bit FRONT_FL;
 301           bit BACK_FL;
 302           bit HIGH_LOWS_PEED_FLold;
 303          
 304          bit TurnHighSpeed_FL;
 305          bit TurnHighSpeed_FL_New;
 306          
 307            bit CHANGE;
 308            bit LA;
 309            bit CHANGE_FL;
 310            bit HIGH_LOWS_PEED_FL;
 311            bit HIGH_LOWS_PEED;
 312          
 313            bit  ELE12_BIG_FL;
 314            bit ELE25_BIG_ERR_FL;//
 315            unsigned char   ELE12_BIG_TM;
 316            unsigned char ELE12_BIG_ct;
 317            unsigned char  ELE12_Small_ct;
 318          
 319          
 320            bit ELE30_BIG_ERR_FL;//
 321            unsigned char ELE30_BIG_TM;
 322          
 323              bit ELE20_BIG_ERR_FL;//
 324            unsigned char ELE20_BIG_TM;
 325          
 326          
 327          unsigned int     Stop_same;
 328          bit  Stop_FL;
 329          bit Stop_Old;
 330          unsigned char   ELE_BIG_TM;
 331           bit ELE_BIG_FL;
 332           bit G_S_Old;
 333           bit G_S_FL;
 334             unsigned char G_S_State;
 335           unsigned char  G_S_same;
 336          
 337          bit A_DET_FL;
 338          
 339           bit FRONT_BACK_FL;
 340          
 341          
 342          unsigned char   PWMADDTM;//
 343           
 344          unsigned char TIME_20MS_CT;//
 345            
 346          
 347          unsigned char  PWMold;//?????
 348          unsigned char count_500US_CT;//500us
 349          unsigned char PWM;
 350           
 351          unsigned char CHANGE_Off_TM;
 352          
 353           unsigned char  FrontOFFTime;
 354          unsigned char BackOFFTime; 
 355          
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 7   

 356          
 357          unsigned char  DelayOffTM;//50MS/20MS=3 /*刹车时间*/
 358          unsigned char  BeginMoveBackTM;
 359          unsigned char  BeginMoveFrontTM;
 360          unsigned char  PWM_MAX_Set;     
 361              
 362           unsigned char Count1S;
 363          
 364          
 365          unsigned char Count2_5MS;     
 366               
 367           unsigned char   G_S_FL_CT; 
 368          
 369           
 370           unsigned char  volHand_addct;
 371           unsigned int   volHand_add;   
 372          
 373            unsigned char  vol_addct;
 374           unsigned int   vol_add;  
 375          
 376           unsigned char ELE30_BIG_ct=0;
 377           unsigned char ELE30_Small_ct;       
 378            bit   ELE30_BIG_FL;
 379          
 380          
 381            unsigned char   RELYDelayTM ;
 382          
 383           unsigned char     ELE28_BIG_ct,ELE28_BIG_TM;
 384           unsigned char     ELE28_Small_ct;
 385          
 386             unsigned char MOS_Err;
 387          
 388           
 389            bit              ELE28_BIG_FL;
 390            bit      ELE28_BIG_ERR_FL;
 391          
 392            bit FLAG_IO_PWM;
 393          
 394          //-----------更改增加的变量
 395             bit qudiao_shache_FL;
 396             bit ceshi_zhengchang_FL;
 397            
 398             bit yunxun_FL;
 399             bit shangdian_yunxun_FL;
 400            unsigned char G_S_HighCT_fanjiao;
 401             
 402             unsigned char PWM_HallSet;
 403             
 404               bit PWM_xianzhi_fl;
 405             
 406             
 407             
 408                bit SW_FL;
 409            unsigned char guanji_timer,guangji_1stimer,guangji_1mintimer;
 410             unsigned char sw_timer,SW_yanshi;
 411             bit FLAG_NMS;
 412             
 413             bit NO_Connet_FL1;
 414                
 415             bit shache_4ms;
 416            
 417           bit  dang_23fl;
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 8   

 418              unsigned char     xiajiang_3dan_timer;
 419              unsigned char     xiajiang_2dan_timer;
 420          
 421          unsigned char PWM_HUAN;
 422          bit PWM_xianzhi_fl;
 423           unsigned int xianliu65_same;
 424          bit xianliu_fl;
 425          
 426          unsigned char jinxianliuTM;
 427          
 428          bit  duZ_close_fl;
 429          
 430          bit duanlu_sw_fl;
 431          
 432           //unsigned char deadtmphigh,deadtmplow;
 433          
 434          #define UINT16 unsigned int
 435          #define UINT8 unsigned char
 436            
 437          //unsigned char A_P_ResultNew;
 438          unsigned char  A_P_CT,A_P_CT1,A_P_CT2,A_P_CT3,A_P_CT4,A_P_CT5;
 439          bit ELEAP_BIG_ERR_FL,ELEAP_BIG_ERR_FL1,ELEAP_BIG_ERR_FL2,ELEAP_BIG_ERR_FL3,ELEAP_BIG_ERR_FL4,ELEAP_BIG_ERR
             -_FL5;
 440          
 441          //------------------------------------------------------------------------------------
 442            
 443          void time_dsp(void);
 444          
 445          
 446          void Delay3us()   //@16MHz
 447          {
 448   1        unsigned char i;
 449   1      
 450   1        _nop_();
 451   1        _nop_();
 452   1        i = 9;
 453   1        while (--i);
 454   1      }
 455          
 456          
 457          //----------------死区时间设置--------------------
 458          /*void PWM_DEAD_TIME_VALUE(UINT16 DeadTimeData)
 459          {
 460            UINT8 deadtmphigh,deadtmplow;
 461            deadtmplow = DeadTimeData;
 462            deadtmphigh = DeadTimeData>>8;
 463            BIT_TMP = EA;
 464            if (deadtmphigh==0x01)
 465            {
 466              EA = 0;
 467              TA = 0xAA;
 468              TA = 0x55;
 469              PDTEN|=0x10;
 470            }
 471            TA = 0xAA;
 472            TA = 0x55;
 473            PDTCNT = deadtmplow;
 474            EA = BIT_TMP;
 475          }*/
 476          
 477          void PWM_DEAD_TIME_VALUE()
 478          {
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 9   

 479   1        UINT8 deadtmphigh,deadtmplow;
 480   1        deadtmplow = 94;
 481   1        deadtmphigh = 11;
 482   1        BIT_TMP = EA;
 483   1        if (deadtmphigh==0x01)
 484   1        {
 485   2          EA = 0;
 486   2          TA = 0xAA;
 487   2          TA = 0x55;
 488   2          PDTEN|=0x10;
 489   2        }
 490   1        TA = 0xAA;
 491   1        TA = 0x55;
 492   1        PDTCNT = deadtmplow;
 493   1        EA = BIT_TMP;
 494   1      }
 495          
 496          
 497          //---------------------------------
 498          
 499          void init(void)
 500          { 
 501   1          BACK_CTRL=0;
 502   1          FRONT_CTRL=0;   
 503   1      
 504   1        SW_FL=0;
 505   1        
 506   1        SW_IO_SET;
 507   1        NO_Connet_FL1=0;
 508   1        PWM_xianzhi_fl=0;
 509   1        A_DET_IO_SET;
 510   1        
 511   1      PWM_xianzhi_fl=0;
 512   1       STOP_IO_SET;
 513   1       duZ_close_fl=0;      //堵转允许关机标志位
 514   1       A_0_IO_SET;                    
 515   1       RELY_SET;                    
 516   1       BACK_CTRL_SET;              
 517   1       FRONT_CTRL_SET;
 518   1        BACK_CTRL=0 ;
 519   1        FRONT_CTRL=0;   
 520   1       PWMOUT_SET;   
 521   1      PWMOUTt_SET;  
 522   1       STOP_IO_SET; 
 523   1       Vol_IO_SET;    
 524   1      // POWER_SW_IO_SET; 
 525   1       LED_SET;
 526   1       LED1_SET;   
 527   1      MOS_DET_INPUT_SET;  
 528   1      //  POWER_ON_SET;
 529   1        //  PWM_EN_IO_SET;
 530   1      
 531   1           PWM5_P03_OUTPUT_ENABLE;  
 532   1           PWM4_P01_OUTPUT_ENABLE;
 533   1           PWM_COMPLEMENTARY_MODE;       //设置为互补模式
 534   1           
 535   1        //PWM4_OUTPUT_INVERSE;  
 536   1          PWM5_OUTPUT_INVERSE;
 537   1      
 538   1          set_PDT45EN;    //使能死区
 539   1          PWM_CLOCK_DIV_32;//PWM_CLOCK_DIV_16=3.9k;   PWM_CLOCK_DIV_32=2k PWM_CLOCK_DIV_64=1k
 540   1          PWMPH = 0x00;
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 10  

 541   1          PWMPL = 0xFF;//F0=4.1K  FF=3.9K
 542   1          //PWM_DEAD_TIME_VALUE(94);   //死区时间设置   27=2us     81=5us     94=6us
 543   1          PWM_DEAD_TIME_VALUE();
 544   1      /**********************************************************************
 545   1        PWM frequency = Fpwm/((PWMPH,PWMPL) + 1) <Fpwm = Fsys/PWM_CLOCK_DIV> 
 546   1                      = (16MHz/8)/(0x7CF + 1)
 547   1                      = 1KHz (1ms)
 548   1      ***********************************************************************/  
 549   1          set_SFRPAGE;               //PWM4 and PWM5 duty seting is in SFP page 1
 550   1          PWM4H = 0x00;           
 551   1          PWM4L = 0x00;
 552   1          clr_SFRPAGE;                      
 553   1      
 554   1      //-------- PWM start run--------------
 555   1          set_LOAD;
 556   1          set_PWMRUN;
 557   1      ///////////////////////////////////
 558   1          RH3 = RELOAD_VALUE_H;                       //initial counter values 
 559   1          RL3 = RELOAD_VALUE_L;       
 560   1          set_ET3;                                    //enable Timer3 interrupt
 561   1          set_EA;                                     //enable interrupts
 562   1          set_TR3;
 563   1        /////////////////////////////////               
 564   1         Enable_ADC_BandGap; 
 565   1          Enable_ADC_AIN0;        //P17脚踏板油门
 566   1      
 567   1          AD_CH=5;
 568   1          clr_ADCF;
 569   1          set_ADCS; 
 570   1          EADC=0;                                                                                                 
             -                                      // Each time ADC start trig signal
 571   1         // while(ADCF == 0);
 572   1      //////////////////////////////
 573   1      P0=0XFe;
 574   1      //P1=0XDD;
 575   1      //POWER_SW_IO=1;
 576   1       PWM=0;
 577   1      CHANGE_Off_TM=0;
 578   1      PWM_MAX_Set=255;
 579   1      PWMold=1;
 580   1      POWER_ON_IO=1; 
 581   1      //PROT=0;
 582   1      //IO_1=0;
 583   1      //IO_2=0;
 584   1      STOP_IO=1;
 585   1      CHANGE_FL=1;
 586   1      A_DET_FL=1;
 587   1      //I_Err_LED_FL=0;
 588   1      PWM_Ele_Set=128;
 589   1      LED_IO=1;           //电源指示灯
 590   1      LED1_IO=0;        //进入测试模式--指示灯
 591   1      POWER_on_TM=0;
 592   1      
 593   1      qudiao_shache_FL=0;
 594   1      ceshi_zhengchang_FL=0;
 595   1      yunxun_FL=0;
 596   1      shangdian_yunxun_FL=1;
 597   1      
 598   1      POWER_IO_SET;
 599   1        
 600   1        POWER_IO=1;    //POWER 上电即是高电平
 601   1      dang_23fl=0;
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 11  

 602   1      xiajiang_3dan_timer=0;
 603   1      xiajiang_2dan_timer=0;
 604   1      xianliu_fl=0;
 605   1        LED1_IO=0;  
 606   1          jinxianliuTM=0;
 607   1          duanlu_sw_fl=0;    //允许电源开关关机
 608   1          ELEAP_BIG_ERR_FL=0;
 609   1          
 610   1      
 611   1       }
 612          
 613          
 614           void Timer3_ISR (void) interrupt 16 
 615          {
 616   1           clr_TF3;
 617   1          count_500US_CT++; 
 618   1      }
 619          
 620          
 621           void  MoveCtrl(void)
 622           {   
 623   1         
 624   1           if(FRONT_CTRL==0&&BACK_CTRL==0) 
 625   1           {
 626   2             if(G_S_State==1)
 627   2             {          
 628   3                  G_S_State=2;
 629   3                  MOS_Err=0;
 630   3                  LED1_IO=1;
 631   3                  MOS_DET_OUTPUT_SET;
 632   3                  MOS_DET_IO=0;//检测前先放电
 633   3                  count_500US_CT=0;
 634   3                  while(count_500US_CT<=40)//10MS=20
 635   3                  {
 636   4                   ;
 637   4                  }
 638   3                    MOS_DET_INPUT_SET;
 639   3                     count_500US_CT=0;
 640   3                   while(count_500US_CT<=3)         //1.5ms  转变输入检测
 641   3                     {
 642   4                       ;
 643   4                     }
 644   3                    count_500US_CT=0;
 645   3                   while(count_500US_CT<=2)     //1ms
 646   3                     {
 647   4                        if(MOS_DET_IO)              //如果检测到是高电平  
 648   4                        {                   
 649   5                             MOS_Err=1;                //则表明上桥是短路的   闪6下
 650   5                             G_S_State=0xff;
 651   5                        }
 652   4                     }
 653   3                                    
 654   3                     MOS_DET_OUTPUT_SET;      //强输出状态
 655   3                     MOS_DET_IO=1;           //充电
 656   3                    count_500US_CT=0;
 657   3                   while(count_500US_CT<=40)    //40*05=20ms
 658   3                     {           
 659   4                        ;
 660   4                     }
 661   3                     MOS_DET_INPUT_SET;       //这里转变IO口  不需要时间转变了？
 662   3                    count_500US_CT=0;
 663   3                   while(count_500US_CT<=2)    //检测1ms
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 12  

 664   3                     {
 665   4                        if(MOS_DET_IO==0)     // 如果检测是低电平
 666   4                        {                     
 667   5                           MOS_Err=2;          //则表示下桥短路故障     闪7下
 668   5                           G_S_State=0xff;
 669   5                        }
 670   4                     } 
 671   3                      LED1_IO=0;
 672   3                                     
 673   3          }
 674   2        }
 675   1           else
 676   1           {
 677   2                G_S_State=2;         
 678   2           }
 679   1      
 680   1            
 681   1        if(PWMold!=PWM)
 682   1        {
 683   2           PWMold=PWM;
 684   2      
 685   2          set_SFRPAGE;            //PWM4 and PWM5 duty seting is in SFP page 1
 686   2          PWM4H = 0x00;           
 687   2          PWM4L = (255-PWM);
 688   2          clr_SFRPAGE;        
 689   2           set_LOAD;
 690   2            // if(PWM==0)//>=0xfe)
 691   2           if(PWM>=0xfe)//==0)
 692   2           {
 693   3            PWM5_P03_OUTPUT_DISABLE;
 694   3            PWM4_P01_OUTPUT_DISABLE;
 695   3            FLAG_IO_PWM=1;
 696   3            P01=0;//换为IO
 697   3            P03=0;               //1
 698   3            // PWM_EN_IO=0;
 699   3           }
 700   2           else
 701   2           // if(PWM>=0xfe)//==0)
 702   2            if(PWM==0)//>=0xfe)
 703   2           {
 704   3            PWM5_P03_OUTPUT_DISABLE;
 705   3            PWM4_P01_OUTPUT_DISABLE;
 706   3            FLAG_IO_PWM=1;
 707   3            P01=0;//换为IO      //上桥
 708   3            P03=1;            // 下桥
 709   3            //PWM_EN_IO=0;
 710   3           }
 711   2          else
 712   2          {
 713   3                if(FLAG_IO_PWM)
 714   3                  {      
 715   4                     
 716   4            
 717   4                      PWM5_P03_OUTPUT_ENABLE;    //下桥
 718   4                        count_500US_CT=0;
 719   4                        
 720   4                  
 721   4                  
 722   4                      PWM4_P01_OUTPUT_ENABLE;     //上桥
 723   4            
 724   4      
 725   4                    FLAG_IO_PWM=0;   
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 13  

 726   4                  }                  
 727   3          }
 728   2      
 729   2        }
 730   1       }
 731          
 732          
 733          void time_dsp(void)
 734          {
 735   1        unsigned char temp;
 736   1        
 737   1         if(count_500US_CT)//;count_500US_CT>=10U;count_500US_CT-=10)//50*10=500US
 738   1           {
 739   2             count_500US_CT=0;
 740   2              
 741   2            
 742   2             if(G_S_HighCT<250)     //脚踏  放开清零  按下计数
 743   2             G_S_HighCT++;      //0.5ms
 744   2             
 745   2             if(G_S_HighCT_fanjiao<250)   //脚踏   按下清零   放开计数
 746   2             G_S_HighCT_fanjiao++;
 747   2      
 748   2      
 749   2              Count2_5MS++;
 750   2          if(Count2_5MS>=8)    //4ms自加一次
 751   2          {
 752   3            Count2_5MS=0;
 753   3            Count1S++;
 754   3              FLAG_NMS=1;
 755   3               shache_4ms=1;
 756   3          if(Count1S>250)
 757   3         {
 758   4              Count1S=0;
 759   4              
 760   4           if(ELE_InterruptDISP_TM)
 761   4             ELE_InterruptDISP_TM--;
 762   4           
 763   4             if(CHANGE_Off_TM)
 764   4           {
 765   5              CHANGE_Off_TM--;
 766   5          //  PROT=1;
 767   5            }
 768   4      
 769   4            }
 770   3          }
 771   2       ////////////////////////////////////////////////////           
 772   2                                                                                                  
 773   2       if((MOS_Err)||(A_DET_FL==0)/*(A_DET_IO==0)*/||ELE25_BIG_ERR_FL||ELE35_BIG_ERR_FL||ELE28_BIG_ERR_FL
 774   2         ||ELE30_BIG_ERR_FL||ELE20_BIG_ERR_FL||ELE40_BIG_FL||NO_Connet_FL||NO_Connet_FL1
 775   2       ||ELE_InterruptDISP_TM||ELEAP_BIG_ERR_FL||ELEAP_BIG_ERR_FL1||ELEAP_BIG_ERR_FL2||ELEAP_BIG_ERR_FL3||ELEAP_
             -BIG_ERR_FL4||ELEAP_BIG_ERR_FL5)
 776   2       {
 777   3        ELE_ERR_FL=1;   
 778   3        TurnHighSpeed_FL=0;
 779   3        TurnHighSpeed_FL_New=0;     
 780   3         qudiao_shache_FL=1;   //各保护起效后，允许--停止刹车占空比输出
 781   3       }
 782   2        else
 783   2       if(G_S_FL==0)
 784   2       {
 785   3          ELE_ERR_FL=0;
 786   3         TurnHighSpeed_FL=0;
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 14  

 787   3        TurnHighSpeed_FL_New=0;
 788   3        qudiao_shache_FL=0;      //再次重踩脚踏后，允许标志位-清零
 789   3       }
 790   2       //-------------------------------------
 791   2      
 792   2        
 793   2      //------------------------充电口--正常模式--测试模式入口----------------------
 794   2        
 795   2           if(STOP_IO)
 796   2           {
 797   3             shangdian_yunxun_FL=0;
 798   3            Stop_same=0;
 799   3            Stop_FL=0;          //解除充电保护
 800   3           }  
 801   2          
 802   2        
 803   2        if(STOP_IO==0)    //0为充电模式   1
 804   2            {
 805   3              Stop_same++;  
 806   3          
 807   3              if(Stop_same>4000)   //10ms=20     2s  插入充电插座后2s  功能才生效
 808   3              {
 809   4                Stop_FL=1;       //进入充电保护
 810   4                yunxun_FL=0;
 811   4              } 
 812   3                        
 813   3            }
 814   2        
 815   2      //--------------------------------------------------------------------  
 816   2          
 817   2        if((DanWei_AD>=Vol_4_5V)||(CurDanWei_AD>=Vol_4_5V))              //档位板不连接
 818   2        {
 819   3          if(++NO_Connet_ct>6000)//6000*0.5MS=3S   
 820   3          { 
 821   4            NO_Connet_FL=1;
 822   4          }
 823   3          
 824   3           goto NoTestAD; 
 825   3         }
 826   2         else
 827   2         {
 828   3      
 829   3               NO_Connet_ct=0;
 830   3               NO_Connet_FL=0; 
 831   3         }
 832   2      
 833   2       if(DanWei_AD>CurDanWei_AD)/*判断AD变化大不大*/
 834   2        temp= DanWei_AD-CurDanWei_AD; 
 835   2        else
 836   2        temp= CurDanWei_AD-DanWei_AD; 
 837   2        
 838   2        if(temp>=10)
 839   2         goto NoTestAD;
 840   2        
 841   2      //   if(DanWei_AD>Vol_3_5V)          //  三档>3.5v
 842   2        
 843   2        if(DanWei==3)
 844   2        {
 845   3        
 846   3          ELE_BIG_SET1=ELE30A;
 847   3          ELE_BIG_SET2=ELE35A;  
 848   3          ELE_BIG_SET3=ELE32A;
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 15  

 849   3      
 850   3           ShaCheTM=10;//10*20MS
 851   3           
 852   3          FRONT_BACK_FL=1;
 853   3          DanWei_PWM=0xff;//97%
 854   3          DanWei=3; /*高速档位*/
 855   3          HIGH_LOWS_PEED_FL=1;/*为0低速*/
 856   3          
 857   3         }
 858   2        // else
 859   2         // if(DanWei_AD>Vol_2_5V)         //二档  2.5V----3.5V
 860   2         if(DanWei==2)
 861   2        {
 862   3             
 863   3           NO_Connet_FL=0;
 864   3          ELE_BIG_SET1=ELE17_5A;
 865   3          ELE_BIG_SET2=ELE25A;
 866   3        ELE_BIG_SET3=ELE21A;
 867   3      
 868   3          ShaCheTM=20;//20*20MS
 869   3          
 870   3          FRONT_BACK_FL=1;
 871   3          DanWei_PWM=153;//65%=166  60%=153
 872   3        DanWei=2;   /*中速档位*/
 873   3        HIGH_LOWS_PEED_FL=0;/*为0低速*/
 874   3         }
 875   2       //  else
 876   2         // if(DanWei_AD>Vol_1V)        //一档    
 877   2         if(DanWei==1)
 878   2         {
 879   3            
 880   3            NO_Connet_FL=0;
 881   3            ELE_BIG_SET1=ELE10A;
 882   3            ELE_BIG_SET2=ELE15A;
 883   3            //ELE_BIG_SET3=0XFF;  ELE12A
 884   3            ELE_BIG_SET3=ELE12A;
 885   3           ShaCheTM=20;//20*20MS
 886   3           
 887   3            FRONT_BACK_FL=1;
 888   3            DanWei_PWM=76;//35%=89    76=30%
 889   3            DanWei=1;  /*低速档位*/
 890   3            HIGH_LOWS_PEED_FL=0;/*为0低速*/
 891   3         }
 892   2        //else                    //倒挡
 893   2         if(DanWei==0)
 894   2        {
 895   3            
 896   3            NO_Connet_FL=0;
 897   3           ELE_BIG_SET1=ELE10A;
 898   3           ELE_BIG_SET2=ELE15A;
 899   3         // ELE_BIG_SET3=0XFF;
 900   3          ELE_BIG_SET3=ELE12A;
 901   3           ShaCheTM=20;//20*20MS
 902   3           
 903   3         FRONT_BACK_FL=0;
 904   3          DanWei_PWM=76;//40%=102  76=30%
 905   3         DanWei=0;  /*倒档位*/
 906   3         HIGH_LOWS_PEED_FL=0;/*为0低速*/
 907   3        }
 908   2        
 909   2          
 910   2        PWM_Ele_Set=DanWei_PWM;
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 16  

 911   2        PWM_MAX_Set=PWM_Ele_Set;//128;
 912   2      
 913   2      
 914   2      NoTestAD:
 915   2      
 916   2      if((CHANGE_Off_TM==0)&&G_S_FL&&(ELE_ERR_FL==0))           //脚踏板踏下
 917   2         {
 918   3         
 919   3           if(FRONT_BACK_FL)
 920   3           {
 921   4             FRONT_FL=1;
 922   4             BACK_FL=0;
 923   4            }
 924   3           else
 925   3            {
 926   4             FRONT_FL=0;
 927   4             BACK_FL=1;
 928   4            }
 929   3         }
 930   2         else
 931   2         {   
 932   3           FRONT_FL=0;
 933   3           BACK_FL=0;
 934   3         } 
 935   2      
 936   2      
 937   2        if(HIGH_LOWS_PEED_FLold!=HIGH_LOWS_PEED_FL)
 938   2        {
 939   3          HIGH_LOWS_PEED_FLold=HIGH_LOWS_PEED_FL;
 940   3          TurnHighSpeed_FL=0;
 941   3          TurnHighSpeed_FL_New=0;
 942   3          ELE_BIG_TM=0;
 943   3        }
 944   2        
 945   2      
 946   2      ///////////////////////////////////////
 947   2           if((Stop_FL==1)||(VoltageLowFL==1))               //充电时或者低压时
 948   2           {
 949   3                 BeginMoveBackTM=0;
 950   3                 BeginMoveFrontTM=0;
 951   3                 turn_zero_fl=0;
 952   3                 G_S_FL=0;
 953   3             
 954   3           }
 955   2          else
 956   2            
 957   2            if(FRONT_FL)
 958   2              {
 959   3               if(FRONT_CTRL)
 960   3                DelayOffTM=ShaCheTM;//50MS/20MS=3 // 2*20MS后刹车
 961   3                BeginMoveBackTM=0;
 962   3              if(BeginMoveFrontTM<250)
 963   3                 BeginMoveFrontTM++;
 964   3          
 965   3               if(BackOFFTime>24)// 24*20MS后再换向    24
 966   3                 { 
 967   4                  BACK_CTRL=0;
 968   4                  FrontOFFTime=0;  
 969   4                  FRONT_CTRL=1;
 970   4                  RELY=1;
 971   4                 }
 972   3                 else
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 17  

 973   3                 BeginMoveFrontTM=0;  
 974   3             }
 975   2              else
 976   2              {
 977   3                if(BACK_FL)
 978   3                 {      
 979   4                 if(BACK_CTRL)
 980   4                 DelayOffTM=ShaCheTM; // 2*20MS后刹车
 981   4                 BeginMoveFrontTM=0;
 982   4                 if(BeginMoveBackTM<250)
 983   4                  BeginMoveBackTM++;
 984   4                    if(FrontOFFTime>24)  // 24*20MS后再换向24
 985   4                    {
 986   5                          FRONT_CTRL=0;
 987   5                          BackOFFTime=0;
 988   5                          BACK_CTRL=1;
 989   5                          RELY=1;
 990   5                    }
 991   4                    else
 992   4                   {
 993   5                      BeginMoveBackTM=0;
 994   5                   }
 995   4      
 996   4                 }
 997   3                 else
 998   3                 {
 999   4                     BeginMoveBackTM=0;
1000   4                     BeginMoveFrontTM=0;
1001   4                 }   
1002   3            }
1003   2         if((BeginMoveBackTM>100)||(BeginMoveFrontTM>100))            //50ms/0.5MS=100
1004   2            { 
1005   3                   if(PWM<25)          //最小启动占空比设置处
1006   3                     PWM=25;//??
1007   3                    
1008   3                 PWMADDTM++;                                //慢启动时间设置
1009   3          if(PWMADDTM>PWM_HUAN)//18=1.5S  //22==1.8s 11= 0.9s    5=0.4s  3=0.2s  此处调整加速时间  每0.1S =1.222值
             -   12=1.2s    27=3s
1010   3          {
1011   4              PWMADDTM=0;
1012   4              
1013   4            if(PWM_xianzhi_fl==0)
1014   4              { 
1015   5               if((PWM>PWM_HallSet)/*&&(PWM>PWM_Ele_Set)*/&&(PWM>25))         //最小启动占空比设置处   12=1.2s
1016   5                PWM--;
1017   5                  
1018   5                if((PWM<PWM_HallSet)/*&&(ELEbig25A_FL==0)*/)
1019   5                  PWM++;
1020   5              }    
1021   4                //---------------限流-----------------
1022   4                
1023   4                 if(Cur_ResultNew>57&&DanWei==3)    //限流调整  电流大于20A     20A=1.125V
1024   4                  {
1025   5                     if(PWM>204)    //PWM>80%
1026   5                     {
1027   6                      // jinxianliuTM++;        //5ms自加一次     
1028   6                      //  if(jinxianliuTM>=100)   
1029   6                    //    {
1030   6                            xianliu_fl=1;
1031   6                      //    jinxianliuTM=0;
1032   6                      //  }             
1033   6                     }
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 18  

1034   5                    if(xianliu_fl)      //限流开始
1035   5                   {                
1036   6                     PWM_xianzhi_fl=1;
1037   6                     PWM--;
1038   6                     PWM_HUAN=10;
1039   6                    
1040   6                    if(PWM<101)         
1041   6                     PWM=101;       //30%
1042   6                    
1043   6                    
1044   6                    if(PWM<=102&&DanWei==3)   //进入限流调整 25A 且PWM小于40%时 76=30%    102=40%
1045   6                    {
1046   7                      //LED1_IO=~LED1_IO;
1047   7                      xianliu65_same++;
1048   7                       if(xianliu65_same>=500)     //5MS*500=2.5s
1049   7                       {
1050   8                          ELE30_BIG_ERR_FL=1;
1051   8                          ELE_Wait_5s=40;//WAIT 20S
1052   8                          xianliu65_same=0;
1053   8                       }
1054   7                    }   
1055   6                                      
1056   6                    if(PWM>102&&DanWei==3)    //计数清零
1057   6                    {
1058   7                      xianliu65_same=0;             
1059   7                    }
1060   6                  }       
1061   5                }           
1062   4                  else
1063   4                  {
1064   5                    //xianliu65_same=0;
1065   5                  //  xianliu_fl=0;      //   限流进入条件解除
1066   5                  //  jinxianliuTM=0;
1067   5                    PWM_xianzhi_fl=0;   //  
1068   5                    PWM_HUAN=27;        //24=11ms               
1069   5                  }
1070   4                          
1071   4           }
1072   3                                   
1073   3           }
1074   2           else  
1075   2             {
1076   3                 PWM=0;
1077   3             }  
1078   2        
1079   2                
1080   2            TIME_20MS_CT++;
1081   2            if(TIME_20MS_CT>=41U)//20MS ???
1082   2            {
1083   3                  TIME_20MS_CT=0; 
1084   3            
1085   3              if(POWER_on_TM<=POWER_ON_TM) //2000/20=100      
1086   3              POWER_on_TM++;
1087   3                                  //20200509
1088   3             if(A_DET_FL==0||ELE40_BIG_FL||ELE35_BIG_ERR_FL||ELE25_BIG_ERR_FL
1089   3               ||ELE_InterruptDISP_TM||ELEAP_BIG_ERR_FL||ELEAP_BIG_ERR_FL1
1090   3               ||ELEAP_BIG_ERR_FL2||ELEAP_BIG_ERR_FL3||ELEAP_BIG_ERR_FL4||ELEAP_BIG_ERR_FL5) //短路控制灯快闪时间
1091   3              {
1092   4                
1093   4                if(++LED_TM>5)     //20*5=100ms   
1094   4                 {               
1095   5                   LED_TM=0;
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 19  

1096   5                   LED_IO^=1;
1097   5                 }
1098   4               }
1099   3              else
1100   3            if(++LED_TM>12)//0.25s=20ms*12.5
1101   3             {
1102   4                 LED_TM=0;
1103   4                 LED_pwm++;
1104   4      
1105   4                        if(LED_CT)
1106   4                          {                 
1107   5                             if(LED_pwm<LED_CT)
1108   5                              LED_IO^=1;
1109   5                              else
1110   5                              LED_IO=0;
1111   5                          }
1112   4                        
1113   4                       if(LED_pwm>=(LED_CT+4))
1114   4                          {
1115   5                            LED_pwm=0;
1116   5                            LED_IO=1;
1117   5                          
1118   5                          }
1119   4                       
1120   4              }
1121   3      
1122   3            
1123   3                    if(MOS_Err==1)      //上桥短路闪6下
1124   3                      {
1125   4                        LED_CT=12;
1126   4      
1127   4                      }
1128   3                    else if(MOS_Err==2)    //下桥短路闪7下
1129   3                      {
1130   4                        LED_CT=14;
1131   4      
1132   4                      }
1133   3                    else
1134   3                      
1135   3                  if(NO_Connet_FL||NO_Connet_FL1)
1136   3                      {
1137   4                       LED_CT=8;
1138   4                      }
1139   3                   else
1140   3                  if(VoltageLowFL)
1141   3                      {
1142   4                       LED_CT=4;
1143   4                      }
1144   3                   else           
1145   3                       if(ELE30_BIG_ERR_FL||ELE20_BIG_ERR_FL||ELE28_BIG_ERR_FL/*||ELE25_BIG_ERR_FL||ELE35_BIG_ER
             -R_FL/*||ELEbig25A_FL||I_Err_LED_FL*/)
1146   3                      {
1147   4                       LED_CT=6;   //3次
1148   4                      }
1149   3                       else
1150   3                      if(Stop_FL)    //充电时，进入灯闪1下
1151   3                      {
1152   4                        LED_CT=2;                         
1153   4                      }
1154   3                       else
1155   3                      {
1156   4                       LED_CT=0;              
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 20  

1157   4                      }
1158   3            //---------------20ms自加一次------------------------
1159   3                      
1160   3                if(DanWei_AD>Vol_3_5V)       //档位AD值判断  三档
1161   3                  {
1162   4              
1163   4                       DanWei=3;
1164   4                                                      
1165   4                  }
1166   3                   else
1167   3                     if(DanWei_AD>Vol_2_5V)       //二档
1168   3                     {
1169   4                       dang_23fl=0;
1170   4                       xiajiang_3dan_timer=0;
1171   4                       xiajiang_2dan_timer=0;
1172   4                        DanWei=2;   
1173   4                     }                 
1174   3                     else
1175   3                      if(DanWei_AD>Vol_1V)       //一档
1176   3                      {
1177   4                        dang_23fl=0;
1178   4                       xiajiang_3dan_timer=0;
1179   4                       xiajiang_2dan_timer=0;
1180   4                        DanWei=1;   
1181   4                      }   
1182   3                      else                    //倒档
1183   3                       {
1184   4                         dang_23fl=0;
1185   4                       xiajiang_3dan_timer=0;
1186   4                       xiajiang_2dan_timer=0;
1187   4                         DanWei=0;       
1188   4                       }                   
1189   3                      
1190   3                      
1191   3              //------------------------------        
1192   3                                    
1193   3                /*if(ELE60_BIG_FL)               //60A过流保护生效标志     三档堵转
1194   3                   {
1195   3                    // if(++ELE60_BIG_TM>=10)       //0.02*10=0.2s
1196   3                     //{
1197   3                      ELE40_BIG_FL=1;    //灯快闪
1198   3                      ELE60_BIG_TM=0;
1199   3                      ELE_Wait_5s=40;
1200   3                     //}
1201   3                   }
1202   3                    else
1203   3                    {
1204   3                      ELE60_BIG_TM=0;
1205   3                      if(ELE_Wait_5s==0)               
1206   3                      ELE40_BIG_FL=0;
1207   3                    }   
1208   3                    */
1209   3        
1210   3             if(++time_500ms>25)//0.5s 进入调整一次    20ms自加一次
1211   3             {
1212   4               time_500ms=0;     //500ms自加一次
1213   4                                 
1214   4              
1215   4        //-----在这里更改2min保护   5s保护  2s保护设置---------
1216   4                  
1217   4           //----------------------------2min保护-----------------------------------        
1218   4               if(ELE30_BIG_FL)
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 21  

1219   4              {
1220   5                          
1221   5                  //----------------------三级保护----------------------------------------  
1222   5                                
1223   5                    if(ceshi_zhengchang_FL==0)    //正常模式
1224   5                    {
1225   6                      if(DanWei==0||DanWei==1)       //倒档和一档  2min保护  PWM_HallSet
1226   6                        {
1227   7                          if(++ELE30_BIG_TM>=240)//0.5s*240=120s   
1228   7                          {
1229   8                            ELE30_BIG_ERR_FL=1;  //
1230   8                            ELE30_BIG_TM=0;
1231   8                            ELE_Wait_5s=40;//WAIT 20S
1232   8                          }
1233   7                       }
1234   6                    }
1235   5                    if(DanWei==2)            //二档 2min保护
1236   5                    {
1237   6                      if(++ELE30_BIG_TM>=240)//0.5s*240=120s   240
1238   6                      {
1239   7                        ELE30_BIG_ERR_FL=1;//
1240   7                        ELE30_BIG_TM=0;
1241   7                        ELE_Wait_5s=40;//WAIT 20S
1242   7                      }         
1243   6                    }
1244   5                    
1245   5                     if(DanWei==3)    //   三档    1min
1246   5                    {
1247   6                      if(++ELE30_BIG_TM>=240)//0.5s*240=120s   
1248   6                      {
1249   7                        ELE30_BIG_ERR_FL=1;//
1250   7                        ELE30_BIG_TM=0;
1251   7                        ELE_Wait_5s=40;//WAIT 20S
1252   7                      }         
1253   6                    }
1254   5                    
1255   5              }
1256   4              else
1257   4              {
1258   5                ELE30_BIG_TM=0;
1259   5                 if(ELE_Wait_5s==0)
1260   5                  ELE30_BIG_ERR_FL=0;         
1261   5              }
1262   4      
1263   4          //---------------------------5s保护-------（二级保护）-----------------------------------
1264   4             
1265   4             if(ELE28_BIG_FL)
1266   4              {
1267   5              if(DanWei==0||DanWei==1) 
1268   5                {         
1269   6                 if(++ELE28_BIG_TM>=90)//0.5s*90=45S
1270   6                  {
1271   7                    ELE28_BIG_ERR_FL=1;//
1272   7                    ELE28_BIG_TM=0;
1273   7                      ELE_Wait_5s=40;
1274   7                  }
1275   6                }
1276   5                
1277   5                  if(DanWei==2)
1278   5                  {
1279   6                    if(++ELE28_BIG_TM>=60)//0.5s*60=30S
1280   6                      {
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 22  

1281   7                        ELE28_BIG_ERR_FL=1;//
1282   7                        ELE28_BIG_TM=0;
1283   7                          ELE_Wait_5s=40;
1284   7                      }
1285   6                  }
1286   5                  
1287   5                  if(DanWei==3)
1288   5                  {
1289   6                    if(++ELE28_BIG_TM>=40)//0.5s*120=20S
1290   6                      {
1291   7                        ELE28_BIG_ERR_FL=1;//
1292   7                        ELE28_BIG_TM=0;
1293   7                          ELE_Wait_5s=40;
1294   7                      }
1295   6                  }       
1296   5              }
1297   4              else
1298   4              {
1299   5                  ELE28_BIG_TM=0;
1300   5                 if(ELE_Wait_5s==0)
1301   5                   ELE28_BIG_ERR_FL=0;          
1302   5              }
1303   4      
1304   4          //----------------------------2s保护-----------------------------------
1305   4             if(ELE50_BIG_FL)
1306   4              {
1307   5                if(DanWei==0||DanWei==1)
1308   5                {           
1309   6                  if(++ELE20_BIG_TM>=20)//0.5s*20=10S
1310   6                  {
1311   7                    ELE20_BIG_ERR_FL=1;//
1312   7                    ELE20_BIG_TM=0;
1313   7                    ELE_Wait_5s=40;
1314   7                  }
1315   6                }
1316   5                  if(DanWei==2||DanWei==3)
1317   5                  {
1318   6                    if(++ELE20_BIG_TM>=10)//0.5s*10=5S
1319   6                    {
1320   7                      ELE20_BIG_ERR_FL=1;//
1321   7                      ELE20_BIG_TM=0;
1322   7                        ELE_Wait_5s=40;
1323   7                    } 
1324   6                  }
1325   5                              
1326   5              }
1327   4              else
1328   4              {
1329   5                ELE20_BIG_TM=0;        
1330   5                 if(ELE_Wait_5s==0)
1331   5                   ELE20_BIG_ERR_FL=0;          
1332   5              }
1333   4      
1334   4          //---------------------------------------------
1335   4                 if(ELE12_BIG_FL)                                   //一档堵转生效后  
1336   4                   {                     
1337   5                      if(++ELE12_BIG_TM>=5)// 5S/0.5*5=2.5s        // 堵转时间保护设置
1338   5                     {
1339   6                          duanlu_sw_fl=1;    //禁止电源开关关机
1340   6                           ELE25_BIG_ERR_FL=1;//
1341   6                           ELE12_BIG_TM=0;
1342   6                           ELE_Wait_5s=60;//WAIT 30S
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 23  

1343   6                           duZ_close_fl=1;            //堵转后允许关机标志位
1344   6                       }
1345   5                   }
1346   4                   else
1347   4                   {
1348   5                      ELE12_BIG_TM=0;
1349   5                      if(ELE_Wait_5s==0)
1350   5                      {
1351   6                        ELE25_BIG_ERR_FL=0;   
1352   6                        if(duZ_close_fl)
1353   6                          POWER_IO=0;     //关机
1354   6                      }                 
1355   5                   }
1356   4                   
1357   4                   
1358   4                 if(ELE13_BIG_FL)                       //二档堵转生效后
1359   4                   {                     
1360   5                      if(++ELE13_BIG_TM>=4)// 5S/0.5*4=2s      // 堵转时间保护设置
1361   5                     {
1362   6                        duanlu_sw_fl=1;    //禁止电源开关关机
1363   6                         ELE35_BIG_ERR_FL=1;//
1364   6                        duZ_close_fl=1;            //堵转后允许关机标志位
1365   6                         ELE13_BIG_TM=0;
1366   6                         ELE_Wait_5s=60;//WAIT 30S
1367   6                       
1368   6                     }
1369   5                   }
1370   4                   else
1371   4                   {
1372   5                        ELE13_BIG_TM=0;
1373   5                       if(ELE_Wait_5s==0)       //电流没有了，解除保护计时到了   才允许重启
1374   5                       {
1375   6                         ELE35_BIG_ERR_FL=0; 
1376   6                          if(duZ_close_fl)
1377   6                            POWER_IO=0;     //关机
1378   6                       }
1379   5                                   
1380   5                   }   
1381   4                   
1382   4                   
1383   4                  /* if(ELE60_BIG_FL)               //60A过流保护生效标志     三档堵转
1384   4                   {
1385   4                     if(++ELE60_BIG_TM>=2)       //0.5*2=1
1386   4                     {
1387   4                      ELE40_BIG_FL=1;    //灯快闪
1388   4                      ELE60_BIG_TM=0;
1389   4                      ELE_Wait_5s=40;
1390   4                     }
1391   4                   }
1392   4                    else
1393   4                    {
1394   4                      ELE60_BIG_TM=0;
1395   4                      if(ELE_Wait_5s==0)               
1396   4                      ELE40_BIG_FL=0;
1397   4                    } */
1398   4            
1399   4                       
1400   4          //-----------------------------------      //先以70%测试   40A=2.25V=80 
1401   4        if(xianliu_fl==0)     //没有进入限流
1402   4        {   
1403   5            if((PWM>=175&&PWM<204)&&(DanWei==3)&&Cur_ResultNew>114)    // //70%--79%
1404   5                {
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 24  

1405   6                    if(++A_P_CT5>=nun_n)  //0.5s*6=3s 
1406   6                    {
1407   7                      ELEAP_BIG_ERR_FL5=1;
1408   7                       A_P_CT5=0;
1409   7                       ELE_Wait_5s=60;//WAIT 30S
1410   7                        duanlu_sw_fl=1;    //禁止电源开关关机
1411   7                         duZ_close_fl=1;      //堵转允许关机标志位
1412   7                    }
1413   6                          
1414   6                }
1415   5               else
1416   5               {
1417   6                    A_P_CT5=0;
1418   6                if(ELE_Wait_5s==0)       //电流没有了，解除保护计时到了   才允许重启
1419   6                {
1420   7                   ELEAP_BIG_ERR_FL5=0; 
1421   7                    if(duZ_close_fl)
1422   7                       POWER_IO=0;     //关机
1423   7                }      
1424   6               }         
1425   5                   
1426   5          //-----------------------------------      //先以60%测试   32A=1.8V=92  
1427   5                   
1428   5            if((PWM>=150&&PWM<175)&&(DanWei==3||DanWei==2)&&Cur_ResultNew>92)    // //60%--69%
1429   5                {
1430   6                    if(++A_P_CT4>=nun_n)  //0.5s*2=1s 
1431   6                    {
1432   7                      ELEAP_BIG_ERR_FL4=1;
1433   7                       A_P_CT4=0;
1434   7                       ELE_Wait_5s=60;//WAIT 30S
1435   7                        duanlu_sw_fl=1;    //禁止电源开关关机
1436   7                         duZ_close_fl=1;      //堵转允许关机标志位
1437   7                    }
1438   6                          
1439   6                }
1440   5               else
1441   5               {
1442   6                    A_P_CT4=0;
1443   6                if(ELE_Wait_5s==0)       //电流没有了，解除保护计时到了   才允许重启
1444   6                {
1445   7                  ELEAP_BIG_ERR_FL4=0; 
1446   7                  if(duZ_close_fl)
1447   7                     POWER_IO=0;     //关机
1448   7                }      
1449   6               }         
1450   5                   
1451   5                                     
1452   5            //-----------------------------------      //先以50%测试   28A=1.57v=80
1453   5                        
1454   5          //  A_P_ResultNew=((Cur_ResultNew/PWM_HallSet)*10);       //测各占空比50       
1455   5                   
1456   5                if((PWM>=125&&PWM<150)&&(DanWei==3||DanWei==2)&&Cur_ResultNew>80)     //50%--59%
1457   5                {
1458   6                    if(++A_P_CT>=nun_n)  //0.5s*2=1s 
1459   6                    {
1460   7                      ELEAP_BIG_ERR_FL=1;
1461   7                       A_P_CT=0;
1462   7                       ELE_Wait_5s=60;//WAIT 30S
1463   7                        duanlu_sw_fl=1;    //禁止电源开关关机
1464   7                         duZ_close_fl=1;      //堵转允许关机标志位
1465   7                    }
1466   6                          
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 25  

1467   6                }
1468   5               else
1469   5               {
1470   6                    A_P_CT=0;
1471   6                if(ELE_Wait_5s==0)       //电流没有了，解除保护计时到了   才允许重启
1472   6                {
1473   7                  ELEAP_BIG_ERR_FL=0; 
1474   7                  if(duZ_close_fl)
1475   7                    POWER_IO=0;     //关机
1476   7                }      
1477   6               }
1478   5      
1479   5               //-----------------------------------      //先以40%测试   25A=1.40V=57
1480   5                                     
1481   5                if((PWM>=102&&PWM<125)&&(DanWei==3||DanWei==2)&&Cur_ResultNew>72)    // //40%--49%
1482   5                {
1483   6                    if(++A_P_CT1>=nun_n)  //0.5s*2=1s 
1484   6                    {
1485   7                      ELEAP_BIG_ERR_FL1=1;
1486   7                       A_P_CT1=0;
1487   7                       ELE_Wait_5s=60;//WAIT 30S
1488   7                        duanlu_sw_fl=1;    //禁止电源开关关机
1489   7                         duZ_close_fl=1;      //堵转允许关机标志位
1490   7                    }
1491   6                          
1492   6                }
1493   5               else
1494   5               {
1495   6                    A_P_CT1=0;
1496   6                if(ELE_Wait_5s==0)       //电流没有了，解除保护计时到了   才允许重启
1497   6                {
1498   7                  ELEAP_BIG_ERR_FL1=0; 
1499   7                  if(duZ_close_fl)
1500   7                     POWER_IO=0;     //关机
1501   7                }      
1502   6               }
1503   5               
1504   5            //-----------------------------------      //先以30%测试   20A=1.125V=57
1505   5                                     
1506   5                if((PWM>=76&&PWM<102)&&(DanWei==3||DanWei==2)&&Cur_ResultNew>57)    // //30%--39%
1507   5                {
1508   6                            
1509   6                    if(++A_P_CT2>=nun_n)  //0.5s*2=1s 
1510   6                    {
1511   7                      ELEAP_BIG_ERR_FL2=1;
1512   7                       A_P_CT2=0;
1513   7                       ELE_Wait_5s=60;//WAIT 30S
1514   7                        duanlu_sw_fl=1;    //禁止电源开关关机
1515   7                         duZ_close_fl=1;      //堵转允许关机标志位
1516   7                    }
1517   6                          
1518   6                }
1519   5               else
1520   5               {
1521   6                    A_P_CT2=0;
1522   6                if(ELE_Wait_5s==0)       //电流没有了，解除保护计时到了   才允许重启
1523   6                {
1524   7                  ELEAP_BIG_ERR_FL2=0; 
1525   7                  if(duZ_close_fl)
1526   7                    POWER_IO=0;     //关机
1527   7                }      
1528   6               }
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 26  

1529   5               
1530   5                //-----------------------------------      //先20%测试   15A=0.84V=42
1531   5                                     
1532   5                if((PWM>=51&&PWM<76)&&(DanWei==3||DanWei==2)&&Cur_ResultNew>42)    // //20%--29%
1533   5                {
1534   6                    if(++A_P_CT3>=nun_n)  //0.5s*2=1s 
1535   6                    {
1536   7                      ELEAP_BIG_ERR_FL3=1;
1537   7                       A_P_CT3=0;
1538   7                       ELE_Wait_5s=60;//WAIT 30S
1539   7                        duanlu_sw_fl=1;    //禁止电源开关关机
1540   7                         duZ_close_fl=1;      //堵转允许关机标志位
1541   7                    }
1542   6                          
1543   6                }
1544   5               else
1545   5               {
1546   6                    A_P_CT3=0;
1547   6                if(ELE_Wait_5s==0)       //电流没有了，解除保护计时到了   才允许重启
1548   6                {
1549   7                  ELEAP_BIG_ERR_FL3=0; 
1550   7                  if(duZ_close_fl)
1551   7                     POWER_IO=0;     //关机
1552   7                }      
1553   6               }
1554   5             }             
1555   4                if(ELE_Wait_5s)
1556   4                ELE_Wait_5s--;
1557   4      
1558   4                if(VoltageLowWait)
1559   4                VoltageLowWait--;            //500ms自减一次
1560   4                              
1561   4            }
1562   3             
1563   3              
1564   3      if(G_S_FL)             //脚踏板
1565   3      {
1566   4        
1567   4        if(G_S_old_FL)
1568   4        {
1569   5            G_S_old_FL=0;
1570   5            G_S_L2H_FL=1;    
1571   5      
1572   5        }
1573   4        
1574   4      // POWER=1;
1575   4      G_S_FL_CT=0;
1576   4      
1577   4        HallLowCT=0;
1578   4       if(Stop_FL==0)
1579   4       POWER_ON_IO=1;
1580   4       else
1581   4        POWER_ON_IO=0;
1582   4      
1583   4       }
1584   3       else
1585   3       {
1586   4        G_S_old_FL=1;
1587   4      
1588   4      
1589   4         if(++HallLowCT>15000) //5*60*1000/20=15000   
1590   4          {
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 27  

1591   5            POWER_ON_IO=0;                                                                
1592   5          }
1593   4      
1594   4       }
1595   3                                                 
1596   3             if(Voltage_AD<Vol16V)
1597   3             {
1598   4                  VoltageLowCT++;                //20ms自加一次 
1599   4                if(VoltageLowCT>225)     //    225=4.5s      在这里更改低电检测时间
1600   4                         {            
1601   5                            VoltageLowFL=1;
1602   5                            turn_zero_fl=0;
1603   5                            VoltageLowWait=40;
1604   5                          }
1605   4             }
1606   3             else
1607   3               {
1608   4                    VoltageLowCT=0;
1609   4                 if((Voltage_AD>Vol21_6V)/*&&(G_S_FL==0)*/&&(VoltageLowWait==0))
1610   4                    VoltageLowFL=0;
1611   4               }
1612   3      
1613   3      
1614   3      
1615   3        if(FRONT_CTRL==0)
1616   3          {
1617   4             if(FrontOFFTime<250)    //250
1618   4              FrontOFFTime++; //??????
1619   4           }
1620   3         else
1621   3            FrontOFFTime=0;
1622   3      
1623   3        if(BACK_CTRL==0)
1624   3           {
1625   4           if(BackOFFTime<250) 
1626   4              BackOFFTime++;//??????
1627   4           }
1628   3         else
1629   3            BackOFFTime=0;
1630   3      /////////////////////////////////////////////////
1631   3              if(DelayOffTM>1)
1632   3               {
1633   4                   DelayOffTM--;
1634   4                 RELYDelayTM=2;/*刹车2*20MS后再关继电器*/  //2
1635   4               }
1636   3               else     //刹车间隔时间完后
1637   3               {
1638   4               
1639   4                 if(RELYDelayTM)
1640   4                    RELYDelayTM--;
1641   4                  else         
1642   4                  RELY=0;
1643   4                              
1644   4                  if(DelayOffTM)
1645   4                     {
1646   5                         DelayOffTM=0;
1647   5                        PWM=0;
1648   5                       MoveCtrl();
1649   5                    
1650   5                    if(qudiao_shache_FL==0)     //各保护不起效，才能输出刹车占空比3%
1651   5                    {       
1652   6                      PWM=10;           //1%=2.55     //在这里更改刹车占空比   目前是3%
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 28  

1653   6                       MoveCtrl();
1654   6                    }
1655   5                    else     //各保护起效后，停止输出刹车占空比3%
1656   5                    {
1657   6                       PWM=0;
1658   6                       MoveCtrl();
1659   6                    }
1660   5              for(DelayOffTM=0;DelayOffTM<STOP_TM;DelayOffTM++)
1661   5              {
1662   6                       if(G_S_FL&&G_S_L2H_FL)
1663   6                         { 
1664   7                           G_S_L2H_FL=0;
1665   7                           goto ESC_STOP2;
1666   7                          }
1667   6                         
1668   6                      count_500US_CT=0;
1669   6                         while(count_500US_CT<=20)//10MS=20    
1670   6                         {                      
1671   7                            if(G_S_FL&&G_S_L2H_FL)
1672   7                            { 
1673   8                            G_S_L2H_FL=0;
1674   8                            goto ESC_STOP2;
1675   8                            }
1676   7                         }    
1677   6                                      
1678   6              }
1679   5      
1680   5             ESC_STOP2:                 
1681   5                          DelayOffTM=0;     //先关继电器
1682   5                          FRONT_CTRL=0;
1683   5                          BACK_CTRL=0;
1684   5                       
1685   5              
1686   5                       count_500US_CT=0;
1687   5                        while(count_500US_CT<=100)   //100*0.5=50ms  延时1  100
1688   5                          {             
1689   6                            if(G_S_FL&&G_S_L2H_FL)
1690   6                             { 
1691   7                               G_S_L2H_FL=0;
1692   7                              goto ESC_STOP8;
1693   7                              }
1694   6                          }
1695   5                       
1696   5                                        
1697   5              
1698   5               ESC_STOP8:    
1699   5                         PWM=0;         //再关PWM
1700   5                         MoveCtrl();                                
1701   5                    }  
1702   4                         
1703   4                FRONT_CTRL=0;
1704   4                BACK_CTRL=0;    
1705   4                BeginMoveBackTM=0;
1706   4                BeginMoveFrontTM=0;
1707   4              
1708   4                }
1709   3                         
1710   3              G_S_L2H_FL=0; 
1711   3             }    
1712   2          
1713   2           } 
1714   1           
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 29  

1715   1      }
1716          
1717          void ADC_DSP(void)
1718          {
1719   1      unsigned char ADtemp;
1720   1      //static    unsigned char ele_ct1 ;
1721   1       ADCF=0;
1722   1       ADtemp=ADCRH;
1723   1        
1724   1      if(AD_CH==5)
1725   1      {
1726   2        AD_CH=7;
1727   2        Enable_ADC_AIN0;    //脚踏板霍尔油门  P17
1728   2        clr_ADCF;
1729   2        set_ADCS; 
1730   2        EADC=0;   
1731   2      
1732   2      
1733   2           Hall_Add+=ADtemp;            
1734   2           Hall_Add_ct++;
1735   2           if(Hall_Add_ct>=8)//>=255) //??32?,???? 64     //平均了8次
1736   2           {
1737   3            //  PROT=!PROT;
1738   3           Hall_Add_ct=0;
1739   3           Cur_ResultNew=Hall_Add>>3;//??    //除8    //Cur_ResultNew---电流值
1740   3           Hall_Add=0;  
1741   3          ///////3.3v==>5v=====     
1742   3       
1743   3        //==============================  
1744   3            if(POWER_on_TM<POWER_ON_TM)
1745   3               Cur_ResultNew=0;
1746   3              
1747   3               if((Cur_ResultNew>=73)&&(DanWei==1))     //25A=73    73=1.41V      
1748   3                    {
1749   4                          
1750   4                      ELE12_BIG_ct++;
1751   4                      ELE12_Small_ct=0;
1752   4                      if(ELE12_BIG_ct>5)
1753   4                          ELE12_BIG_FL=1;                //一档堵转生效标志
1754   4                    }
1755   3                    else
1756   3                      {
1757   4                        ELE12_BIG_ct=0;
1758   4                        ELE12_Small_ct++;           
1759   4                        if(ELE12_Small_ct>5)
1760   4                        ELE12_BIG_FL=0;
1761   4                      }  
1762   3                      
1763   3                if((Cur_ResultNew>=115)&&(DanWei==2))     //35A=100   1.96V     40A=115=2.25V
1764   3                    {
1765   4                      ELE13_BIG_ct++;
1766   4                      ELE13_Small_ct=0;
1767   4                      if(ELE13_BIG_ct>5)
1768   4                       ELE13_BIG_FL=1;            //二档堵转生效标志
1769   4                    }
1770   3                    else
1771   3                      {               
1772   4                        ELE13_Small_ct++;            
1773   4                        if(ELE13_Small_ct>5)      //30
1774   4                        {
1775   5                          ELE13_BIG_FL=0;
1776   5                          ELE13_BIG_ct=0;
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 30  

1777   5                        }
1778   4                      }     
1779   3      
1780   3          /*  if(Cur_ResultNew > ELE60A&&(DanWei==3))//ELE40A)       //60A过流保护    173=3.4V
1781   3            {   
1782   3             ELE40_BIG_ct++;
1783   3             ELE40_Small_ct=0;
1784   3            // if(ELE40_BIG_ct>5)                   //三档堵转生效标志
1785   3            // {
1786   3               ELE60_BIG_FL=1;        
1787   3            // }
1788   3                 
1789   3            }
1790   3            else
1791   3            {   
1792   3              //  RELY=~ RELY;        //约500us自加一次   
1793   3              ELE40_BIG_ct=0;
1794   3              ELE40_Small_ct++;     
1795   3              if(ELE40_Small_ct>5)      //    3ms      
1796   3               ELE60_BIG_FL=0;
1797   3            }*/
1798   3      
1799   3        //------------------------------------------------------  
1800   3        if(Cur_ResultNew > ELE60A&&DanWei==3)           //三档堵转保护
1801   3        {
1802   4          ELE40_BIG_FL=1;       //保护  灯快闪
1803   4          ELE40_BIG_ct++;
1804   4          ELE40_Small_ct=0;
1805   4       //  if(ELE40_BIG_ct>15)//20=200MS  5=50MS    15--130ms
1806   4        // {
1807   4            //ELE40_BIG_FL=1;
1808   4            ELE_Wait_5s=60;        //保护解除要60=30s   0.5s自减一次     120=1min
1809   4        // }
1810   4           duZ_close_fl=1;      //堵转允许关机标志位
1811   4          duanlu_sw_fl=1;    //禁止电源开关关机
1812   4        }
1813   3        else
1814   3        { 
1815   4          ELE40_BIG_ct=0;
1816   4          ELE40_Small_ct++;     
1817   4          if((ELE40_Small_ct>5)&&(ELE_Wait_5s==0))  
1818   4          {   
1819   5             ELE40_BIG_FL=0;
1820   5             if(duZ_close_fl)
1821   5                POWER_IO=0;     //关机
1822   5          }     
1823   4            
1824   4        }
1825   3      
1826   3      //----------------------------------------------------------
1827   3                                  
1828   3        if(Cur_ResultNew>ELE_BIG_SET2)
1829   3            {
1830   4                  
1831   4              ELE50_BIG_ct++;
1832   4              ELE50_Small_ct=0;
1833   4              if(ELE50_BIG_ct>5)
1834   4              ELE50_BIG_FL=1;
1835   4            }
1836   3            else
1837   3              {            
1838   4                ELE50_BIG_ct=0;
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 31  

1839   4                  ELE50_Small_ct++;           
1840   4                  if(ELE50_Small_ct>5)
1841   4                      ELE50_BIG_FL=0;
1842   4              }
1843   3        
1844   3        if(Cur_ResultNew>ELE_BIG_SET1)
1845   3          {
1846   4                
1847   4            ELE30_BIG_ct++;
1848   4            ELE30_Small_ct=0;
1849   4          if(ELE30_BIG_ct>10)
1850   4                ELE30_BIG_FL=1;
1851   4          }
1852   3          else
1853   3            {
1854   4                
1855   4              ELE30_BIG_ct=0;
1856   4                ELE30_Small_ct++;           
1857   4                if(ELE30_Small_ct>5)
1858   4                    ELE30_BIG_FL=0;
1859   4            }
1860   3      
1861   3      
1862   3          if(Cur_ResultNew>ELE_BIG_SET3)
1863   3            {
1864   4                  
1865   4              ELE28_BIG_ct++;
1866   4              ELE28_Small_ct=0;
1867   4            if(ELE28_BIG_ct>5)
1868   4                  ELE28_BIG_FL=1;
1869   4            }
1870   3            else
1871   3              {
1872   4                  
1873   4                ELE28_BIG_ct=0;
1874   4                  ELE28_Small_ct++;           
1875   4                  if(ELE28_Small_ct>5)
1876   4                      ELE28_BIG_FL=0;
1877   4              }
1878   3         
1879   3        }
1880   2       }
1881   1        else
1882   1         if(AD_CH==7)
1883   1         {
1884   2            AD_CH=4;
1885   2            Enable_ADC_AIN1;    //速度开关    P30
1886   2            clr_ADCF;
1887   2            set_ADCS; 
1888   2            EADC=0;
1889   2        // HallPWM=ADtemp;
1890   2           
1891   2            //---------油门大于4.8V  停止工作，显示故障灯闪4下
1892   2          
1893   2          if(ADtemp>HALL_4000MV) 
1894   2          {
1895   3            NO_Connet_FL1=1;
1896   3          }
1897   2               
1898   2          if(ADtemp>HALL_1000MV)    //踩下脚踏  1.33v
1899   2          {
1900   3          
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 32  

1901   3          G_S_HighCT_fanjiao=0;
1902   3         //if(FRONT_CTRL==0&&BACK_CTRL==0)    //50ms生效后，判断继电器是否有吸合  没有才允许脚踏生效
1903   3        //  {
1904   3            if(G_S_HighCT>=100) //10MS   0.5*20     100=50ms    200ms
1905   3            {
1906   4          //  if(FRONT_CTRL==0&&BACK_CTRL==0)    //50ms生效后，判断继电器是否有吸合  没有才允许脚踏生效
1907   4          //    {
1908   4                if(turn_zero_fl==1)/*&&(G_S_State==0))*/
1909   4                  {
1910   5                    if(G_S_State==0)  
1911   5                     G_S_State=1;
1912   5                                      
1913   5                    if(G_S_State==2)
1914   5                     G_S_FL=1;         //脚踏板生效   
1915   5                  } 
1916   4              //}
1917   4           //}
1918   4            }
1919   3            ADtemp=ADtemp-HALL_1000MV;      //
1920   3            if(ADtemp>HALL_DV)
1921   3            ADtemp=HALL_DV;
1922   3      
1923   3            if((HIGH_LOWS_PEED_FL)&&(DanWei==3))    //高速档
1924   3            PWM_HallSet=ADtemp*PWM_98_DV/HALL_DV; 
1925   3      
1926   3           if((HIGH_LOWS_PEED_FL==0)&&(DanWei==2))    //二档
1927   3            // PWM_HallSet=143;
1928   3             PWM_HallSet=ADtemp*PWM_65_DV/HALL_DV; 
1929   3      
1930   3            if((HIGH_LOWS_PEED_FL==0)&&(DanWei==1))    //一档
1931   3              PWM_HallSet=80;
1932   3            //PWM_HallSet=ADtemp*PWM_40_DV/HALL_DV; 
1933   3      
1934   3            if((HIGH_LOWS_PEED_FL==0)&&(DanWei==0))    //倒档
1935   3            PWM_HallSet=ADtemp*PWM_40_DV/HALL_DV; 
1936   3      
1937   3            PWM_HallSet+=PWM_15;  
1938   3           
1939   3          }
1940   2          else        //放开脚踏
1941   2          {
1942   3            if(ADtemp>HALL_0500MV)     //且大于0.5V  小于1.33V  
1943   3            {
1944   4                G_S_HighCT=0;      
1945   4                NO_Connet_FL1=0;
1946   4             if(G_S_HighCT_fanjiao>=100)    //50ms   连续50ms为低  才认为是松开脚踏
1947   4             {
1948   5                if((Stop_FL==0)&&(VoltageLowFL==0))
1949   5                 turn_zero_fl=1;
1950   5               
1951   5                 set_PWMRUN;       //PWM运行使能位开启
1952   5                G_S_FL=0;
1953   5                G_S_State=0;
1954   5                PWM_xianzhi_fl=0;
1955   5                xianliu_fl=0;      //   限流进入条件解除
1956   5            
1957   5             }             
1958   4            }
1959   3            else       //小于0.5V  故障灯闪    
1960   3            {     
1961   4                NO_Connet_FL1=1;      
1962   4            }
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 33  

1963   3                
1964   3          }
1965   2            
1966   2         }
1967   1         else
1968   1          if(AD_CH==4)//速度和进退检测      
1969   1         {
1970   2            AD_CH=6;
1971   2            Enable_ADC_AIN7;     //电压检测   P11
1972   2            clr_ADCF;
1973   2            set_ADCS; 
1974   2            EADC=0;
1975   2                 CurDanWei_AD=ADtemp;
1976   2                  volHand_add+=ADtemp;            
1977   2                 volHand_addct++;
1978   2                 if(volHand_addct>=64)//>=255)  
1979   2                 {           
1980   3                 volHand_addct=0;
1981   3                 DanWei_AD=volHand_add>>6;              //档位值
1982   3                 volHand_add=0;  
1983   3                  }
1984   2            
1985   2          }
1986   1             else
1987   1          if(AD_CH==6)//电压检测
1988   1         {
1989   2            AD_CH=5;
1990   2            Enable_ADC_AIN4;     //电流检测    P05        
1991   2            clr_ADCF;
1992   2            set_ADCS; 
1993   2            EADC=0;
1994   2            // Voltage_AD=ADtemp;
1995   2      
1996   2             vol_add+=ADtemp;            
1997   2                 vol_addct++;
1998   2                 if(vol_addct==0)//>=64)//>=255)   //??32?,???? 64
1999   2                 {
2000   3                    
2001   3                 vol_addct=0;
2002   3                 Voltage_AD=vol_add>>8;//??
2003   3                 vol_add=0;  
2004   3                  }
2005   2      
2006   2          }
2007   1      
2008   1      }
2009          
2010          void zidongguangji()
2011          {
2012   1        if(FLAG_NMS)
2013   1        {
2014   2           FLAG_NMS=0;     //4ms自加一次
2015   2        
2016   2          if(duanlu_sw_fl==0)      //当堵转保护后，禁止手动关电源
2017   2          {
2018   3            if(SW_FL)
2019   3              {
2020   4                  if(SW_IO)
2021   4                 {
2022   5                   SW_yanshi++;
2023   5                   if(SW_yanshi>=5)   //按键防抖20ms
2024   5                   {             
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 34  

2025   6                     if(SW_IO)
2026   6                     {
2027   7                        POWER_IO=0;     //关机
2028   7                       SW_yanshi=5;
2029   7                     }
2030   6                   }          
2031   5                 }                                         
2032   4              }
2033   3          }
2034   2              
2035   2           if(SW_IO==0)
2036   2           {  
2037   3             
2038   3              SW_yanshi=0;      //清按键计数
2039   3                 sw_timer++;
2040   3             
2041   3              if(sw_timer>=10)    //40ms     //上电40ms后才允许去关机
2042   3                {
2043   4                  sw_timer=0;
2044   4                  SW_FL=1;  
2045   4                }
2046   3                
2047   3           //----------------------------------       
2048   3             if(G_S_IO==0)
2049   3             {
2050   4              if(STOP_IO)        //不充电时进入待机计时    
2051   4              {
2052   5                guanji_timer++;
2053   5                    
2054   5               if(guanji_timer>=250)
2055   5                {
2056   6                 guanji_timer=0;        
2057   6                  guangji_1stimer++;
2058   6                   if(guangji_1stimer>=60)      //1min
2059   6                   {
2060   7                     guangji_1stimer=0;
2061   7                      guangji_1mintimer++;
2062   7                        if(guangji_1mintimer>=10)
2063   7                        {
2064   8                         POWER_IO=0;   
2065   8                        }                   
2066   7                   }
2067   6               }
2068   5              }
2069   4             }
2070   3             else
2071   3             {       
2072   4                   guanji_timer=0;
2073   4                   guangji_1stimer=0;
2074   4                  guangji_1mintimer=0;
2075   4             }
2076   3          }
2077   2      }
2078   1      }
2079          
2080          
2081          //-----------------???-----------------------------
2082          void main(void)
2083          { 
2084   1        init();
2085   1       while(1)
2086   1        {  
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 35  

2087   2          
2088   2          
2089   2          //--------看门狗设置------
2090   2            TA=0xAA;
2091   2            TA=0x55;
2092   2            WDCON = 0x7; 
2093   2           set_WDTR;
2094   2           set_WDCLR;
2095   2           set_EWDT;         //WDT看门狗使能位   
2096   2          
2097   2          PICON=0X80;       //边沿触发和IO选择   P06
2098   2          PINEN=0X40;        //使能--下降沿触发
2099   2          EIE=0X02;
2100   2                
2101   2           zidongguangji();   //自动关机程序
2102   2          //---------------------------   
2103   2          time_dsp();  
2104   2          MoveCtrl();
2105   2          if(ADCF)
2106   2          ADC_DSP();
2107   2       
2108   2        }
2109   1      }
2110          
2111          
2112          void init_ISR()  interrupt 7 
2113          {
2114   1          if(PIF==0X40)   //P06 管脚中断标志位   生效位 
2115   1          {    
2116   2              Delay3us();
2117   2            if(A_DET_IO==0)
2118   2            {
2119   3            ELE_InterruptDISP_TM = 20;    //20
2120   3            ELE_ERR_FL=1;   
2121   3            TurnHighSpeed_FL=0;
2122   3            TurnHighSpeed_FL_New=0;       
2123   3            PWM5_P03_OUTPUT_DISABLE;
2124   3            PWM4_P01_OUTPUT_DISABLE;
2125   3            FLAG_IO_PWM=1;
2126   3            P03=1;//换为IO    //下桥
2127   3            P01=0;         //上桥
2128   3            turn_zero_fl=0;
2129   3            clr_PWMRUN;                      //PWM运行使能位关闭
2130   3          // A_DET_FL=0;
2131   3            PWM=0;     
2132   3            
2133   3            //  MoveCtrl();  
2134   3            qudiao_shache_FL=1;   //各保护起效后，允许--停止刹车占空比输出
2135   3              
2136   3              PIF=0X00;          //清零
2137   3            }
2138   2              PIF=0X00;          //清零
2139   2          }
2140   1      }
2141          
2142          
2143          
2144          
2145          


MODULE INFORMATION:   STATIC OVERLAYABLE
C51 COMPILER V9.01   MAIN                                                                  01/20/2022 17:01:34 PAGE 36  

   CODE SIZE        =   4019    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =     94    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =     57    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)

C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN MAIN.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE SOURCE\MAIN.c COMPACT OMF2 OPTIMIZE(8,SPEED) BROWSE DEBUG PRINT(.\MAIN.l
                    -st) OBJECT(MAIN.obj)

line level    source

*** WARNING C500 IN LINE 1 OF SOURCE\MAIN.c: INCORRECT LICENSE ID CODE (LIC) IN 'TOOLS.INI'
   1          /*--------------------------------------------------------------------------------------------------------
             --*/
   2          /*                                                                                                        
             - */
   3          /* Copyright(c) 2017 Nuvoton Technology Corp. All rights reserved.                                        
             - */
   4          /*                                                                                                        
             - */
   5          /*--------------------------------------------------------------------------------------------------------
             --*/
   6           //升级记录
   7          
   8          ////20170619 G/S修改成低电平有效  .A-DET PORT功能取消 
   9          //20180327 修改为型号M92 1取消大电流增加PWM功能
  10          //2 G/S引脚功能取消，改为由P11采样霍尔控制车速1-2.5V对应高速15-98或低速15-60%     
  11          //20180505 增加刹车脚STOP，P00=STOP;内部上拉；低电平时，停止输出；
  12          //20180507       P00 POWER功能删除
  13          //20180508       P00加上拉
  14          //20181008  //IO改一下；
  15                     //速度开关改为用AD读，且把进退也放在这里检测；
  16                     //增加电压检测
  17                      //GS改为用霍尔
  18          //20181126 //1.三档PWM分别改为：低->40% 中->70% 高->97%;
  19                        //2.缓启动时间降低30%。
  20          //20181210       DelayOffTM=20;改成 DelayOffTM=2; PWM关了，延时拉低FC&BC输出低电平的时间 0.4S， 改成50MS
  21          //20181218   增加电流 18 20 25分别不同时间保护
  22                  //   1 18A，2分钟，
  23                 //    2 20A，5秒钟
  24                 //    3 25A，2秒钟       
  25          //20181219   M92客户 把慢启动时间加快至1.8秒
  26          //20181224 1.去掉P01的电源控制功能，改为控制LED;去掉P10脚功能；使用常闭式电源开关，不再管理电源通断；
  27                   //   2.P01为LED控制脚，可指示电源和故障； 
  28                    //  1高电平有效；
  29                    //  2开机电源灯常亮；
  30                   // 3过流，灯快闪（亮0.1秒，灭0.1秒，保护动作后，循环）；
  31                   //  4欠压，灯闪（亮1秒，灭1秒，保护动作后，循环）；
  32                  //  5充电中，灯亮0.1秒，灭0.5秒，循环；
  33                 // 6解除保护后，灯回复正常长亮；
  34                  // 3.过流检测值加大，
  35                  //   1 25A，2分钟，
  36                 //    2 30A，5秒钟
  37                 //    3 35A，2秒钟        
  38           
  39           //20190105 要三个版本刹车 0秒   慢启动 1.2秒;
  40                     //刹车 0秒   慢启动 1.5秒;
  41                      //刹车 0秒   慢启动 1.8秒;
  42          
  43           //20190225 按文档“功能修改9B20 M92.doc”修改
  44           
  45                  //20190704  去掉档位板上的霍尔调节----ok
  46                  //20190710  将刹车PWM由2%改为3%----ok
  47            //20190717 去掉PWM_EN  同时将PWN改为PWM互补模式（P00为下桥输出  P05为上桥输出）-----ok
  48                  //20190725  加入看门狗程序------------ok
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 2   

  49                  //20190731  将倒档和一档在6A保护，保护时间由2min改为30s  且二档和三档任保持2min保护-----ok
  50           //20190802  倒档电压是：0V--1V 改为：0V--0.5V ---------ok
  51           //          一档电压是：1V--2.5V 改为: 0.5V--2.5V--------ok
  52           //          将低电检测时间由： 2s改为：3s  -----ok     
  53            //20190807  更改每个档位占空比：倒档30% 一档30% 二档60% 三档100%-----------ok      //到这里是出货的版本 
             - 9fe7  600台
  54            //20190828   将死区时间由2us加大到6us-------ok
  55          
  56          //20190829 //1.本版增加MOS管短路检测；
  57                     //2.A_DET大电流检测--没有加检测延时
  58                     //3.脚踏板检测加防接抖，需连续10ms电平不变，才认为是脚踏板有效；
  59          //20190907  //过流保护、档位电流保护，档位板不连接保护时。将停止刹车占空比3%输出-----ok
  60          //20190908  //脚踏后，将延时由10ms加至到50ms生效-----ok
  61          //20190911  //加入测试模式------ok     //到这里是50块样板的出货版本
  62          //20190921   //脚踏板踩下那刻，要判断继电器，接着50ms后，再次判断继电器，无吸合后，才开始mos检测，检测正常
             -则才允许启动--ok         
  63          //20190924     //脚踏板松开时，要加防抖   连续检测到50ms低电平，这时才认为脚踏松开---ok
  64          
  65          //20200509   增加60A级别--过流--灯快闪     
  66          //20210405   油门脚踏变霍尔
  67          //20210416   慢启动时间改为2s
  68          //20210426   增加限流25A功能
  69          //20210508   将最小占空比由20%改至30%
  70          
  71          //20210528   1.限流由25A；2.各档位PWM更改；3.欠压值更改；4.油门故障保护设置大于4V;5.油门启动电压值由1V--1.
             -3V
  72          
  73          //20210806    脚踏快速重启（将继电器判断还在mos管检测前）
  74          
  75          //20210815    增加一二档堵转保护  23A   35A  ---1.5s保护
  76          
  77          //20210902    慢启动改为3s   最大占空比95   
  78           
  79          //20220117    1.堵转保护后 20s 关机
  80          //            2.二档堵转时间由2s减少至1.5s
  81          //            3.二档取消变速功能  和一档一样
  82          
  83          
  84          #include "N76E003.h"
  85          #include <string.h>
  86          #include "Common.h"
  87          #include "Delay.h"
  88          #include "SFR_Macro.h"
  89          
  90          #include "Function_define.h"
  91          #include "TIME_ISP.h"
  92           
  93          #define RELOAD_VALUE_H  (65536-8000)/256 //500US
  94          #define RELOAD_VALUE_L  (65536-8000)%256//500US
  95          
  96            //---------------------------------------------------------
  97          //funtion :Rx IR cortrol FANCAR
  98          //body    :N76E003
  99          //date    :2017 11 28
 100          //in/output:
 101          ////20170619 G/S????????  .A-DET PORT????
 102          //------------------------------------------
 103          
 104          #define  STOP_TM      50//10MS*50=500    刹车时间500MS ,单位10MS  50
 105          
 106          #define  Vol_5V       245       //255 
 107          #define  Vol_4_5V     244       //255    229=4.5
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 3   

 108          
 109          #define  Vol_3_5V   178//255*3.5/5            //档位板电压设置
 110          
 111          #define  Vol_2_5V    128//255*2.5/5
 112          #define  Vol_2V     102//255*2/5
 113          #define  Vol_1V     26//255*1/5  51=1V   26=0.5V
 114          
 115          
 116          #define  Vol_1_88V     96//255*1.88/5   19.2V时IO电压为1.88V
 117          
 118          #define  Vol16V       134//         //欠压检测  低于27V
 119          #define  Vol21_6V     161//     //32.7V  解除欠压   161
 120          
 121          #define     nun_n      6
 122          
 123          
 124          #define POWER_ON_TM         100
 125          
 126          #define  HALL_1000MV         66 //255*1/3.3=77     启动电压由1V改成1.3V
 127          
 128          #define  HALL_4200MV         193//193   //255*2.5/3.3=193
 129          #define  HALL_DV                 (HALL_4200MV-HALL_1000MV) //116
 130          //#define  HALL_DV              66
 131          #define  PWM_15                          25//255*0.15   38
 132          
 133          #define  HALL_4000MV         245        //255*1/3.3=77
 134          
 135          #define   HALL_0500MV    26
 136          
 137          #define  PWM_30                         79//255*60
 138          #define  PWM_30_DV           (PWM_30-PWM_15)//115
 139          
 140          #define  PWM_40                         104//255*60
 141          #define  PWM_40_DV           (PWM_40-PWM_15)//115
 142          
 143          #define  PWM_65                          168//255*60
 144          #define  PWM_65_DV           (PWM_65-PWM_15)//115
 145          
 146          #define  PWM_98                          243//255*98     255=100%     243=95%      248=97%
 147          #define  PWM_98_DV           (PWM_98-PWM_15)//212  
 148          
 149          
 150          #define  ELE10A         42//255*0.466v/5=  10A=33   19
 151          #define  ELE12A         50    //12.5A--5s保护      44
 152          #define  ELE15A                 55//255*0.757v/5        52
 153          
 154          #define  ELE17_5A           61//255*0.886v/5         
 155          #define  ELE21A               71//255*0.886v/5         
 156          #define  ELE25A         82//255*1.255v/5        87
 157                                                      
 158                                                                                                                          
 159          #define  ELE30A         78    //255*1.255v/5  98             27A---2min保护    28.5A--5S保护          99--
             -20200507
 160          #define  ELE32A         92                   //111
 161          #define  ELE35A         100       //255*1.781v/5               113---20200507
 162                  
 163          #define  ELE60A        143//130//230   173---3.4V--60A     3.1V=55A=158    50A=2.81V=143
 164          
 165          
 166          #define  ELE_1A         4
 167          #define  ELE_2A         8//3A
 168          
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 4   

 169          //#define  PWM_15         40 //255*15/100
 170          
 171          #define  PWM_55         140 //255*55/100
 172          #define  PWM_80         204 //255*80/100
 173          
 174          
 175           #define  LED_IO                           P12
 176           #define  LED_SET              P12_PushPull_Mode     //故障指示灯--已改
 177          
 178           #define  LED1_IO                           P15
 179           #define  LED1_SET              P15_PushPull_Mode
 180          
 181          #define  A_0_IO                  P05
 182          #define  A_0_IO_SET              P05_Input_Mode     //电流检测口---ok
 183           
 184          #define  STOP_IO                  P02     /*充电脚*///    ---ok
 185          #define  STOP_IO_SET             P02_Quasi_Mode //P00_Input_Mode ---已改  P02_Quasi_Mode
 186            
 187                  
 188          #define  G_S_IO                  P17
 189          #define  G_S_IO_SET              P17_Input_Mode         
 190                  
 191                  
 192          //#define  G_S_IO                  P10
 193          //#define  G_S_IO_SET              P10_Input_Mode   
 194          
 195          //#define  POWER_SW_IO                P10
 196          //#define  POWER_SW_IO_SET          P10_Quasi_Mode   
 197          
 198          //#define  PROT            P14
 199          //#define  PROT_SET        P14_Quasi_Mode
 200          #define  RELY            P07
 201          #define  RELY_SET        P07_PushPull_Mode     //不用到该IO口
 202          
 203          
 204          #define  BACK_CTRL         P10
 205          #define  BACK_CTRL_SET     P10_PushPull_Mode    //后退---已改
 206          
 207          
 208          #define  FRONT_CTRL        P00  
 209          #define  FRONT_CTRL_SET    P00_PushPull_Mode     //前进---ok
 210          
 211          
 212          #define PWMOUT            P03// FP23  //
 213          #define PWMOUT_SET             P03_PushPull_Mode //    ok
 214          
 215          #define PWMOUTt            P01// FP23  //
 216          #define PWMOUTt_SET            P01_PushPull_Mode //   ok
 217          
 218          
 219          #define  Vol_IO          P11
 220          #define  Vol_IO_SET          P11_Input_Mode     //电压检测---ok
 221          
 222          
 223          #define  A_DET_IO           P06              //短路电流检测---ok
 224          #define  A_DET_IO_SET         P06_Quasi_Mode
 225          
 226          
 227          #define  MOS_DET_IO             P04
 228          #define  MOS_DET_INPUT_SET          P04_Input_Mode
 229          #define  MOS_DET_OUTPUT_SET         P04_PushPull_Mode
 230          
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 5   

 231          
 232          #define  SW_IO           P13
 233          #define  SW_IO_SET          P13_Input_Mode
 234          
 235          #define  POWER_IO          P14
 236          #define  POWER_IO_SET       P14_PushPull_Mode
 237          
 238          
 239          
 240          unsigned char POWER_on_TM;
 241          
 242          unsigned char ELE_BIG_SET2;
 243          unsigned char ELE_BIG_SET1;
 244          unsigned char ELE_BIG_SET3;
 245          unsigned char VoltageLowWait;
 246          unsigned char  ShaCheTM;//2*20MS
 247          unsigned char LED_TM;  //调到闪的频率0.26MS
 248          unsigned char LED_pwm; //中间变量
 249          unsigned char LED_CT;//闪的次数X2
 250          unsigned char CurDanWei_AD;
 251          unsigned char  G_S_HighCT;
 252          unsigned char   ELE_InterruptDISP_TM;
 253          
 254          bit NO_Connet_FL;
 255          
 256          bit turn_zero_fl;
 257          bit  ELE40_BIG_FL;
 258          
 259          bit G_S_old_FL;
 260          bit  G_S_L2H_FL;
 261          
 262          bit  ELE60_BIG_FL;
 263                   
 264          unsigned char ELE40_BIG_ct;
 265          unsigned char   ELE40_Small_ct;
 266          
 267          unsigned char  ELE60_BIG_TM;
 268          
 269          unsigned int NO_Connet_ct;      
 270          
 271          bit POWER_ON_IO ;
 272          
 273          unsigned char  ELE_Wait_5s;
 274          unsigned char  VoltageLowCT;
 275          bit  VoltageLowFL;
 276          unsigned char AD_CH,Voltage_AD,DanWei_AD;//PWM_HallSet;
 277          unsigned char ELE50_BIG_ct;
 278          unsigned char   ELE50_Small_ct=0;
 279          bit     ELE50_BIG_FL;
 280          
 281          unsigned char  DanWei_PWM;
 282          unsigned char PWM_Ele_Set;
 283          unsigned int Hall_Add,HallLowCT;            
 284          unsigned char   Hall_Add_ct;    
 285          unsigned char Cur_ResultNew;
 286          unsigned char  time_500ms;
 287          
 288          unsigned char DanWei;
 289          
 290          unsigned char ELE13_BIG_TM;
 291          unsigned char ELE13_Small_ct;
 292          unsigned char ELE13_BIG_ct;
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 6   

 293          
 294          bit     ELE13_BIG_FL;
 295          
 296          bit ELE35_BIG_ERR_FL;
 297          
 298          bit ELE_ERR_FL;
 299          bit BIT_TMP;
 300          bit FRONT_FL;
 301          bit BACK_FL;
 302          bit HIGH_LOWS_PEED_FLold;
 303          
 304          bit TurnHighSpeed_FL;
 305          bit TurnHighSpeed_FL_New;
 306          
 307          bit CHANGE;
 308          bit LA;
 309          bit CHANGE_FL;
 310          bit HIGH_LOWS_PEED_FL;
 311          bit HIGH_LOWS_PEED;
 312          
 313          bit  ELE12_BIG_FL;
 314          bit ELE25_BIG_ERR_FL;//
 315          unsigned char   ELE12_BIG_TM;
 316          unsigned char ELE12_BIG_ct;
 317          unsigned char  ELE12_Small_ct;
 318          
 319          
 320          bit     ELE30_BIG_ERR_FL;//
 321          unsigned char   ELE30_BIG_TM;
 322          
 323          bit     ELE20_BIG_ERR_FL;//
 324          unsigned char   ELE20_BIG_TM;
 325          
 326          
 327          unsigned int       Stop_same;
 328          bit  Stop_FL;
 329          bit Stop_Old;
 330          unsigned char   ELE_BIG_TM;
 331          bit ELE_BIG_FL;
 332          bit G_S_Old;
 333          bit G_S_FL;
 334          unsigned char G_S_State;
 335          unsigned char  G_S_same;
 336          
 337          bit A_DET_FL;
 338          
 339          bit FRONT_BACK_FL;
 340          
 341          
 342          unsigned char   PWMADDTM;//
 343          
 344          unsigned char TIME_20MS_CT;//
 345          
 346          
 347          unsigned char  PWMold;//?????
 348          unsigned char count_500US_CT;//500us
 349          unsigned char PWM;
 350          
 351          unsigned char CHANGE_Off_TM;
 352          
 353          unsigned char  FrontOFFTime;
 354          unsigned char   BackOFFTime; 
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 7   

 355          
 356          
 357          unsigned char  DelayOffTM;//50MS/20MS=3 /*刹车时间*/
 358          unsigned char  BeginMoveBackTM;
 359          unsigned char  BeginMoveFrontTM;
 360          unsigned char  PWM_MAX_Set;               
 361            
 362          unsigned char Count1S;
 363          
 364          
 365          unsigned char Count2_5MS;     
 366           
 367          unsigned char G_S_FL_CT;        
 368          
 369          
 370          unsigned char  volHand_addct;
 371          unsigned int   volHand_add;   
 372          
 373          unsigned char  vol_addct;
 374          unsigned int   vol_add;  
 375          
 376          unsigned char ELE30_BIG_ct=0;
 377          unsigned char ELE30_Small_ct;                    
 378          
 379          
 380          unsigned char   RELYDelayTM ;
 381          
 382          unsigned char   ELE28_BIG_ct,ELE28_BIG_TM;
 383          unsigned char   ELE28_Small_ct;
 384          
 385          unsigned char MOS_Err;
 386          
 387          
 388          bit     ELE28_BIG_FL;
 389          bit     ELE28_BIG_ERR_FL;
 390          bit     ELE30_BIG_FL;
 391          
 392          bit FLAG_IO_PWM;
 393          
 394          //-----------更改增加的变量
 395          bit qudiao_shache_FL;
 396          bit ceshi_zhengchang_FL;
 397          
 398          bit yunxun_FL;
 399          bit shangdian_yunxun_FL;
 400          unsigned char G_S_HighCT_fanjiao;
 401          
 402          unsigned char PWM_HallSet;
 403          
 404          bit PWM_xianzhi_fl;
 405          
 406          
 407          
 408          bit SW_FL;
 409          unsigned char guanji_timer,guangji_1stimer,guangji_1mintimer;
 410          unsigned char sw_timer,SW_yanshi;
 411          bit FLAG_NMS;
 412           
 413          bit NO_Connet_FL1;
 414                  
 415          bit shache_4ms;
 416          
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 8   

 417          bit  dang_23fl;
 418          unsigned char           xiajiang_3dan_timer;
 419          unsigned char           xiajiang_2dan_timer;
 420          
 421          unsigned char PWM_HUAN;
 422          bit PWM_xianzhi_fl;
 423          unsigned int xianliu65_same;
 424          bit xianliu_fl;
 425          
 426          unsigned char jinxianliuTM;
 427          
 428          bit  duZ_close_fl;
 429          
 430          bit duanlu_sw_fl;
 431          
 432           //unsigned char deadtmphigh,deadtmplow;
 433          
 434          #define UINT16 unsigned int
 435          #define UINT8 unsigned char
 436                  
 437          //unsigned char A_P_ResultNew;
 438          unsigned char  A_P_CT,A_P_CT1,A_P_CT2,A_P_CT3,A_P_CT4,A_P_CT5;
 439          bit ELEAP_BIG_ERR_FL,ELEAP_BIG_ERR_FL1,ELEAP_BIG_ERR_FL2,ELEAP_BIG_ERR_FL3,ELEAP_BIG_ERR_FL4,ELEAP_BIG_ERR
             -_FL5;
 440          
 441          //------------------------------------------------------------------------------------
 442                  
 443          void time_dsp(void);
 444          
 445          
 446          void Delay3us()         //@16MHz
 447          {
 448   1              unsigned char i;
 449   1      
 450   1              _nop_();
 451   1              _nop_();
 452   1              i = 9;
 453   1              while (--i);
 454   1      }
 455          
 456          
 457          //----------------死区时间设置--------------------
 458          /*void PWM_DEAD_TIME_VALUE(UINT16       DeadTimeData)
 459          {
 460                  UINT8 deadtmphigh,deadtmplow;
 461                  deadtmplow = DeadTimeData;
 462                  deadtmphigh = DeadTimeData>>8;
 463                  BIT_TMP = EA;
 464                  if (deadtmphigh==0x01)
 465                  {
 466                          EA = 0;
 467                          TA = 0xAA;
 468                          TA = 0x55;
 469                          PDTEN|=0x10;
 470                  }
 471                  TA = 0xAA;
 472                  TA = 0x55;
 473                  PDTCNT = deadtmplow;
 474                  EA = BIT_TMP;
 475          }*/
 476          
 477          void PWM_DEAD_TIME_VALUE()
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 9   

 478          {
 479   1              UINT8 deadtmphigh,deadtmplow;
 480   1              deadtmplow = 94;
 481   1              deadtmphigh = 11;
 482   1              BIT_TMP = EA;
 483   1              if (deadtmphigh==0x01)
 484   1              {
 485   2                      EA = 0;
 486   2                      TA = 0xAA;
 487   2                      TA = 0x55;
 488   2                      PDTEN|=0x10;
 489   2              }
 490   1              TA = 0xAA;
 491   1              TA = 0x55;
 492   1              PDTCNT = deadtmplow;
 493   1              EA = BIT_TMP;
 494   1      }
 495          
 496          
 497          //---------------------------------
 498          
 499          void init(void)
 500          { 
 501   1              BACK_CTRL=0;
 502   1              FRONT_CTRL=0;   
 503   1      
 504   1              SW_FL=0;
 505   1              
 506   1              SW_IO_SET;
 507   1              NO_Connet_FL1=0;
 508   1              PWM_xianzhi_fl=0;
 509   1              A_DET_IO_SET;
 510   1                      
 511   1              PWM_xianzhi_fl=0;
 512   1              STOP_IO_SET;
 513   1              duZ_close_fl=0;      //堵转允许关机标志位
 514   1              A_0_IO_SET;                     
 515   1              RELY_SET;                    
 516   1              BACK_CTRL_SET;                                             
 517   1              FRONT_CTRL_SET;
 518   1              BACK_CTRL=0 ;
 519   1              FRONT_CTRL=0;   
 520   1              PWMOUT_SET;      
 521   1              PWMOUTt_SET;  
 522   1              STOP_IO_SET;    
 523   1              Vol_IO_SET;             
 524   1              // POWER_SW_IO_SET; 
 525   1              LED_SET;
 526   1              LED1_SET;   
 527   1              MOS_DET_INPUT_SET;      
 528   1              //  POWER_ON_SET;
 529   1              //  PWM_EN_IO_SET;
 530   1      
 531   1              PWM5_P03_OUTPUT_ENABLE; 
 532   1              PWM4_P01_OUTPUT_ENABLE;
 533   1              PWM_COMPLEMENTARY_MODE;      //设置为互补模式
 534   1               
 535   1              //PWM4_OUTPUT_INVERSE;  
 536   1              PWM5_OUTPUT_INVERSE;
 537   1      
 538   1              set_PDT45EN;    //使能死区
 539   1              PWM_CLOCK_DIV_32;//PWM_CLOCK_DIV_16=3.9k;         PWM_CLOCK_DIV_32=2k PWM_CLOCK_DIV_64=1k
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 10  

 540   1              PWMPH = 0x00;
 541   1              PWMPL = 0xFF;//F0=4.1K  FF=3.9K
 542   1              //PWM_DEAD_TIME_VALUE(94);   //死区时间设置   27=2us     81=5us     94=6us
 543   1              PWM_DEAD_TIME_VALUE();
 544   1      /**********************************************************************
 545   1              PWM frequency = Fpwm/((PWMPH,PWMPL) + 1) <Fpwm = Fsys/PWM_CLOCK_DIV> 
 546   1                                                                      = (16MHz/8)/(0x7CF + 1)
 547   1                                                                      = 1KHz (1ms)
 548   1      ***********************************************************************/        
 549   1              set_SFRPAGE;                                         //PWM4 and PWM5 duty seting is in SFP page 1
 550   1              PWM4H = 0x00;                                           
 551   1              PWM4L = 0x00;
 552   1              clr_SFRPAGE;                                                                                    
 553   1      
 554   1      //-------- PWM start run--------------
 555   1          set_LOAD;
 556   1          set_PWMRUN;
 557   1      ///////////////////////////////////
 558   1          RH3 = RELOAD_VALUE_H;                       //initial counter values 
 559   1          RL3 = RELOAD_VALUE_L;       
 560   1          set_ET3;                                    //enable Timer3 interrupt
 561   1          set_EA;                                     //enable interrupts
 562   1          set_TR3;
 563   1        /////////////////////////////////                   
 564   1              Enable_ADC_BandGap; 
 565   1          Enable_ADC_AIN0;        //P17脚踏板油门
 566   1      
 567   1              AD_CH=5;
 568   1              clr_ADCF;
 569   1              set_ADCS; 
 570   1              EADC=0;                                                                                                  
             -                                     // Each time ADC start trig signal
 571   1         // while(ADCF == 0);
 572   1      //////////////////////////////
 573   1              P0=0XFe;
 574   1              //P1=0XDD;
 575   1              //POWER_SW_IO=1;
 576   1               PWM=0;
 577   1              CHANGE_Off_TM=0;
 578   1              PWM_MAX_Set=255;
 579   1              PWMold=1;
 580   1              POWER_ON_IO=1; 
 581   1              //PROT=0;
 582   1              //IO_1=0;
 583   1              //IO_2=0;
 584   1              STOP_IO=1;
 585   1              CHANGE_FL=1;
 586   1              A_DET_FL=1;
 587   1              //I_Err_LED_FL=0;
 588   1              PWM_Ele_Set=128;
 589   1              LED_IO=1;           //电源指示灯
 590   1              LED1_IO=0;        //进入测试模式--指示灯
 591   1              POWER_on_TM=0;
 592   1      
 593   1              qudiao_shache_FL=0;
 594   1              ceshi_zhengchang_FL=0;
 595   1              yunxun_FL=0;
 596   1              shangdian_yunxun_FL=1;
 597   1      
 598   1              POWER_IO_SET;
 599   1              
 600   1              POWER_IO=1;    //POWER 上电即是高电平
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 11  

 601   1              dang_23fl=0;
 602   1              xiajiang_3dan_timer=0;
 603   1              xiajiang_2dan_timer=0;
 604   1              xianliu_fl=0;
 605   1              LED1_IO=0;      
 606   1              jinxianliuTM=0;
 607   1              duanlu_sw_fl=0;    //允许电源开关关机
 608   1              ELEAP_BIG_ERR_FL=0;
 609   1                      
 610   1      
 611   1      }
 612          
 613          
 614          void Timer3_ISR (void) interrupt 16 
 615          {
 616   1                 clr_TF3;
 617   1          count_500US_CT++;   
 618   1      }
 619          
 620          
 621          void  MoveCtrl(void)
 622          {        
 623   1              if(FRONT_CTRL==0&&BACK_CTRL==0) 
 624   1              {
 625   2                      if(G_S_State==1)
 626   2                      {                                       
 627   3                              G_S_State=2;
 628   3                              MOS_Err=0;
 629   3                              LED1_IO=1;
 630   3                              MOS_DET_OUTPUT_SET;
 631   3                              MOS_DET_IO=0;//检测前先放电
 632   3                              count_500US_CT=0;
 633   3                              while(count_500US_CT<=40)//10MS=20
 634   3                              {
 635   4                               ;
 636   4                              }
 637   3                              MOS_DET_INPUT_SET;
 638   3                              count_500US_CT=0;
 639   3                              while(count_500US_CT<=3)         //1.5ms  转变输入检测
 640   3                              {
 641   4                                      ;
 642   4                              }
 643   3                              count_500US_CT=0;
 644   3                              while(count_500US_CT<=2)     //1ms
 645   3                              {
 646   4                                      if(MOS_DET_IO)              //如果检测到是高电平  
 647   4                                      {                   
 648   5                                         MOS_Err=1;                //则表明上桥是短路的   闪6下
 649   5                                         G_S_State=0xff;
 650   5                                      }
 651   4                              }
 652   3                                                        
 653   3                              MOS_DET_OUTPUT_SET;      //强输出状态
 654   3                              MOS_DET_IO=1;           //充电
 655   3                              count_500US_CT=0;
 656   3                              while(count_500US_CT<=40)    //40*05=20ms
 657   3                              {                                        
 658   4                                        ;
 659   4                              }
 660   3                              MOS_DET_INPUT_SET;       //这里转变IO口  不需要时间转变了？
 661   3                              count_500US_CT=0;
 662   3                              while(count_500US_CT<=2)    //检测1ms
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 12  

 663   3                              {
 664   4                                      if(MOS_DET_IO==0)     // 如果检测是低电平
 665   4                                      {                     
 666   5                                              MOS_Err=2;          //则表示下桥短路故障     闪7下
 667   5                                              G_S_State=0xff;
 668   5                                      }
 669   4                              } 
 670   3                              LED1_IO=0;
 671   3                                                                                                                       
 672   3                      }
 673   2              }
 674   1              else
 675   1              {
 676   2                      G_S_State=2;                     
 677   2              }
 678   1      
 679   1            
 680   1              if(PWMold!=PWM)
 681   1              {
 682   2                      PWMold=PWM;
 683   2      
 684   2                      set_SFRPAGE;                                            //PWM4 and PWM5 duty seting is in SFP page 1
 685   2                      PWM4H = 0x00;                                           
 686   2                      PWM4L = (255-PWM);
 687   2                      clr_SFRPAGE;                            
 688   2                      set_LOAD;
 689   2            // if(PWM==0)//>=0xfe)
 690   2                      if(PWM>=0xfe)//==0)
 691   2                      {
 692   3                              PWM5_P03_OUTPUT_DISABLE;
 693   3                              PWM4_P01_OUTPUT_DISABLE;
 694   3                              FLAG_IO_PWM=1;
 695   3                              P01=0;//换为IO
 696   3                              P03=0;               //1
 697   3                              // PWM_EN_IO=0;
 698   3                      }
 699   2                      else
 700   2                       // if(PWM>=0xfe)//==0)
 701   2                      if(PWM==0)//>=0xfe)
 702   2                      {
 703   3                              PWM5_P03_OUTPUT_DISABLE;
 704   3                              PWM4_P01_OUTPUT_DISABLE;
 705   3                              FLAG_IO_PWM=1;
 706   3                              P01=0;//换为IO      //上桥
 707   3                              P03=1;            // 下桥
 708   3                              //PWM_EN_IO=0;
 709   3                      }
 710   2                      else
 711   2                      {
 712   3                              if(FLAG_IO_PWM)
 713   3                  {      
 714   4                     
 715   4                              
 716   4                                      PWM5_P03_OUTPUT_ENABLE;    //下桥
 717   4                                      count_500US_CT=0;
 718   4      
 719   4                                      PWM4_P01_OUTPUT_ENABLE;     //上桥
 720   4                                      FLAG_IO_PWM=0;   
 721   4                  }                                                    
 722   3                      }
 723   2      
 724   2              }
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 13  

 725   1      }
 726          
 727          void time_dsp(void)
 728          {
 729   1              unsigned char temp;
 730   1              
 731   1              if(count_500US_CT)//;count_500US_CT>=10U;count_500US_CT-=10)//50*10=500US
 732   1              {
 733   2                      count_500US_CT=0;       
 734   2                      if(G_S_HighCT<250)     //脚踏  放开清零  按下计数
 735   2                              G_S_HighCT++;      //0.5ms
 736   2      
 737   2                      if(G_S_HighCT_fanjiao<250)   //脚踏   按下清零   放开计数
 738   2                              G_S_HighCT_fanjiao++;
 739   2      
 740   2              Count2_5MS++;
 741   2                      if(Count2_5MS>=8)    //4ms自加一次
 742   2                      {
 743   3                              Count2_5MS=0;
 744   3                              Count1S++;
 745   3                              FLAG_NMS=1;
 746   3                              shache_4ms=1;
 747   3                      if(Count1S>250)
 748   3                      {
 749   4                              Count1S=0;
 750   4      
 751   4                              if(ELE_InterruptDISP_TM)
 752   4                                      ELE_InterruptDISP_TM--;
 753   4      
 754   4                              if(CHANGE_Off_TM)
 755   4                              {
 756   5                                      CHANGE_Off_TM--;
 757   5                              }
 758   4      
 759   4                      }
 760   3                      }
 761   2       ////////////////////////////////////////////////////                                                     
             -                                              
 762   2                      if((MOS_Err)||(A_DET_FL==0)/*(A_DET_IO==0)*/||ELE25_BIG_ERR_FL||ELE35_BIG_ERR_FL||ELE28_BIG_ERR_FL
 763   2                       ||ELE30_BIG_ERR_FL||ELE20_BIG_ERR_FL||ELE40_BIG_FL||NO_Connet_FL||NO_Connet_FL1
 764   2                      ||ELE_InterruptDISP_TM||ELEAP_BIG_ERR_FL||ELEAP_BIG_ERR_FL1||ELEAP_BIG_ERR_FL2||ELEAP_BIG_ERR_FL3||ELEAP
             -_BIG_ERR_FL4||ELEAP_BIG_ERR_FL5)
 765   2                      {
 766   3                              ELE_ERR_FL=1;   
 767   3                              TurnHighSpeed_FL=0;
 768   3                              TurnHighSpeed_FL_New=0;     
 769   3                               qudiao_shache_FL=1;   //各保护起效后，允许--停止刹车占空比输出
 770   3                      }
 771   2                      else
 772   2                      if(G_S_FL==0)
 773   2                      {
 774   3                              ELE_ERR_FL=0;
 775   3                              TurnHighSpeed_FL=0;
 776   3                              TurnHighSpeed_FL_New=0;
 777   3                              qudiao_shache_FL=0;      //再次重踩脚踏后，允许标志位-清零
 778   3                      }
 779   2       //-------------------------------------
 780   2      
 781   2              
 782   2      //------------------------充电口--正常模式--测试模式入口----------------------
 783   2                      if(STOP_IO)
 784   2                      {
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 14  

 785   3                              shangdian_yunxun_FL=0;
 786   3                              Stop_same=0;
 787   3                              Stop_FL=0;                          //解除充电保护
 788   3                      }       
 789   2          
 790   2              
 791   2                      if(STOP_IO==0)    //0为充电模式   1
 792   2                      {
 793   3                              Stop_same++;    
 794   3                              if(Stop_same>4000)   //10ms=20     2s  插入充电插座后2s  功能才生效
 795   3                              {
 796   4                                      Stop_FL=1;           //进入充电保护
 797   4                                      yunxun_FL=0;
 798   4                              }                                       
 799   3                      }
 800   2      //--------------------------------------------------------------------  
 801   2                      
 802   2                      if((DanWei_AD>=Vol_4_5V)||(CurDanWei_AD>=Vol_4_5V))              //档位板不连接
 803   2                      {
 804   3                              if(++NO_Connet_ct>6000)//6000*0.5MS=3S   
 805   3                              { 
 806   4                                      NO_Connet_FL=1;
 807   4                              }
 808   3                              goto NoTestAD; 
 809   3                      }
 810   2                      else
 811   2                      {
 812   3                               NO_Connet_ct=0;
 813   3                               NO_Connet_FL=0; 
 814   3                      }
 815   2      
 816   2                      if(DanWei_AD>CurDanWei_AD)/*判断AD变化大不大*/
 817   2                              temp= DanWei_AD-CurDanWei_AD; 
 818   2                      else
 819   2                              temp= CurDanWei_AD-DanWei_AD; 
 820   2        
 821   2                      if(temp>=10)
 822   2                              goto NoTestAD;
 823   2        
 824   2      //       if(DanWei_AD>Vol_3_5V)          //  三档>3.5v
 825   2              
 826   2                      if(DanWei==3)
 827   2                      {
 828   3                              ELE_BIG_SET1=ELE30A;
 829   3                              ELE_BIG_SET2=ELE35A;  
 830   3                              ELE_BIG_SET3=ELE32A;
 831   3      
 832   3                              ShaCheTM=10;//10*20MS
 833   3      
 834   3                              FRONT_BACK_FL=1;
 835   3                              DanWei_PWM=0xff;//97%
 836   3                              DanWei=3; /*高速档位*/
 837   3                              HIGH_LOWS_PEED_FL=1;/*为0低速*/
 838   3                      }
 839   2        // else
 840   2               // if(DanWei_AD>Vol_2_5V)         //二档  2.5V----3.5V
 841   2                      if(DanWei==2)
 842   2                      {
 843   3                              NO_Connet_FL=0;
 844   3                              ELE_BIG_SET1=ELE17_5A;
 845   3                              ELE_BIG_SET2=ELE25A;
 846   3                              ELE_BIG_SET3=ELE21A;
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 15  

 847   3      
 848   3                              ShaCheTM=20;//20*20MS
 849   3      
 850   3                              FRONT_BACK_FL=1;
 851   3                              DanWei_PWM=153;//65%=166  60%=153
 852   3                              DanWei=2;   /*中速档位*/
 853   3                              HIGH_LOWS_PEED_FL=0;/*为0低速*/
 854   3                      }
 855   2       //  else
 856   2               // if(DanWei_AD>Vol_1V)        //一档    
 857   2                      if(DanWei==1)
 858   2                      {
 859   3      
 860   3                              NO_Connet_FL=0;
 861   3                              ELE_BIG_SET1=ELE10A;
 862   3                              ELE_BIG_SET2=ELE15A;
 863   3                              //ELE_BIG_SET3=0XFF;  ELE12A
 864   3                              ELE_BIG_SET3=ELE12A;
 865   3                              ShaCheTM=20;//20*20MS
 866   3      
 867   3                              FRONT_BACK_FL=1;
 868   3                              DanWei_PWM=76;//35%=89    76=30%
 869   3                              DanWei=1;  /*低速档位*/
 870   3                              HIGH_LOWS_PEED_FL=0;/*为0低速*/
 871   3                      }
 872   2              //else                    //倒挡
 873   2                      if(DanWei==0)
 874   2                      {
 875   3                              NO_Connet_FL=0;
 876   3                              ELE_BIG_SET1=ELE10A;
 877   3                              ELE_BIG_SET2=ELE15A;
 878   3                              // ELE_BIG_SET3=0XFF;
 879   3                              ELE_BIG_SET3=ELE12A;
 880   3                              ShaCheTM=20;//20*20MS
 881   3      
 882   3                              FRONT_BACK_FL=0;
 883   3                              DanWei_PWM=76;//40%=102  76=30%
 884   3                              DanWei=0;  /*倒档位*/
 885   3                              HIGH_LOWS_PEED_FL=0;/*为0低速*/
 886   3                      }
 887   2                      PWM_Ele_Set=DanWei_PWM;
 888   2                      PWM_MAX_Set=PWM_Ele_Set;//128;
 889   2      
 890   2      NoTestAD:
 891   2      
 892   2                      if((CHANGE_Off_TM==0)&&G_S_FL&&(ELE_ERR_FL==0))           //脚踏板踏下
 893   2                      {
 894   3                              if(FRONT_BACK_FL)
 895   3                              {
 896   4                                      FRONT_FL=1;
 897   4                                      BACK_FL=0;
 898   4                              }
 899   3                              else
 900   3                              {
 901   4                                      FRONT_FL=0;
 902   4                                      BACK_FL=1;
 903   4                              }
 904   3                      }
 905   2                      else
 906   2                      {        
 907   3                              FRONT_FL=0;
 908   3                              BACK_FL=0;
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 16  

 909   3                      } 
 910   2      
 911   2      
 912   2                      if(HIGH_LOWS_PEED_FLold!=HIGH_LOWS_PEED_FL)
 913   2                      {
 914   3                              HIGH_LOWS_PEED_FLold=HIGH_LOWS_PEED_FL;
 915   3                              TurnHighSpeed_FL=0;
 916   3                              TurnHighSpeed_FL_New=0;
 917   3                              ELE_BIG_TM=0;
 918   3                      }
 919   2      ///////////////////////////////////////
 920   2                      if((Stop_FL==1)||(VoltageLowFL==1))               //充电时或者低压时
 921   2                      {
 922   3                              BeginMoveBackTM=0;
 923   3                              BeginMoveFrontTM=0;
 924   3                              turn_zero_fl=0;
 925   3                              G_S_FL=0;
 926   3                      }
 927   2                      else    
 928   2                      if(FRONT_FL)
 929   2                      {
 930   3                              if(FRONT_CTRL)
 931   3                                      DelayOffTM=ShaCheTM;//50MS/20MS=3       // 2*20MS后刹车
 932   3                              BeginMoveBackTM=0;
 933   3                              if(BeginMoveFrontTM<250)
 934   3                                      BeginMoveFrontTM++;
 935   3      
 936   3                              if(BackOFFTime>24)// 24*20MS后再换向    24
 937   3                              { 
 938   4                                      BACK_CTRL=0;
 939   4                                      FrontOFFTime=0;  
 940   4                                      FRONT_CTRL=1;
 941   4                                      RELY=1;
 942   4                              }
 943   3                              else
 944   3                                      BeginMoveFrontTM=0;  
 945   3                      }
 946   2              else
 947   2              {
 948   3                              if(BACK_FL)
 949   3                              {                       
 950   4                                      if(BACK_CTRL)
 951   4                                              DelayOffTM=ShaCheTM; // 2*20MS后刹车
 952   4                                      BeginMoveFrontTM=0;
 953   4                                      if(BeginMoveBackTM<250)
 954   4                                              BeginMoveBackTM++;
 955   4                                              if(FrontOFFTime>24)  // 24*20MS后再换向24
 956   4                                              {
 957   5                                                      FRONT_CTRL=0;
 958   5                                                      BackOFFTime=0;
 959   5                                                      BACK_CTRL=1;
 960   5                                                      RELY=1;
 961   5                                              }
 962   4                                              else
 963   4                                              {
 964   5                                                      BeginMoveBackTM=0;
 965   5                                              }
 966   4                               }
 967   3                              else
 968   3                              {
 969   4                                      BeginMoveBackTM=0;
 970   4                                      BeginMoveFrontTM=0;
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 17  

 971   4                              }   
 972   3                      }
 973   2                      if((BeginMoveBackTM>100)||(BeginMoveFrontTM>100))            //50ms/0.5MS=100
 974   2                      {       
 975   3                              if(PWM<25)          //最小启动占空比设置处
 976   3                              PWM=25;//??
 977   3                                                              
 978   3                              PWMADDTM++;                                //慢启动时间设置
 979   3                      if(PWMADDTM>PWM_HUAN)//18=1.5S  //22==1.8s 11= 0.9s        5=0.4s  3=0.2s  此处调整加速时间      每0.1S =1.222值
             -   12=1.2s    27=3s
 980   3                      {
 981   4                              PWMADDTM=0;     
 982   4                              if(PWM_xianzhi_fl==0)
 983   4                              {       
 984   5                                      if((PWM>PWM_HallSet)/*&&(PWM>PWM_Ele_Set)*/&&(PWM>25))         //最小启动占空比设置处   12=1.2s
 985   5                                              PWM--;
 986   5      
 987   5                                      if((PWM<PWM_HallSet)/*&&(ELEbig25A_FL==0)*/)
 988   5                                              PWM++;
 989   5                              }          
 990   4                                              //---------------限流-----------------                  
 991   4                              if(Cur_ResultNew>57&&DanWei==3)    //限流调整  电流大于20A     20A=1.125V
 992   4                              {
 993   5                                      if(PWM>204)    //PWM>80%
 994   5                                      {
 995   6                                      // jinxianliuTM++;        //5ms自加一次     
 996   6                                      //  if(jinxianliuTM>=100)   
 997   6                                      //              {
 998   6                                              xianliu_fl=1;
 999   6                                      //              jinxianliuTM=0;
1000   6                                      //      }                                                 
1001   6                                      }
1002   5                                      if(xianliu_fl)            //限流开始
1003   5                                      {                                                               
1004   6                                              PWM_xianzhi_fl=1;
1005   6                                              PWM--;
1006   6                                              PWM_HUAN=10;
1007   6      
1008   6                                              if(PWM<101)         
1009   6                                                      PWM=101;       //30%
1010   6                                                        
1011   6                                                      
1012   6                                              if(PWM<=102&&DanWei==3)   //进入限流调整 25A 且PWM小于40%时 76=30%    102=40%
1013   6                                              {
1014   7                                                      //LED1_IO=~LED1_IO;
1015   7                                                              xianliu65_same++;
1016   7                                                      if(xianliu65_same>=500)     //5MS*500=2.5s
1017   7                                                      {
1018   8                                                              ELE30_BIG_ERR_FL=1;
1019   8                                                              ELE_Wait_5s=40;//WAIT 20S
1020   8                                                              xianliu65_same=0;
1021   8                                                      }
1022   7                                              }               
1023   6                                              if(PWM>102&&DanWei==3)    //计数清零
1024   6                                              {
1025   7                                                      xianliu65_same=0;                                                       
1026   7                                              }
1027   6                                      }                               
1028   5                              }                                       
1029   4                              else
1030   4                              {
1031   5                                      //xianliu65_same=0;
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 18  

1032   5                                      //      xianliu_fl=0;      //   限流进入条件解除
1033   5                                      //      jinxianliuTM=0;
1034   5                                      PWM_xianzhi_fl=0;   //  
1035   5                                      PWM_HUAN=27;        //24=11ms                                                   
1036   5                              }
1037   4                                                                                      
1038   4                      }                                                        
1039   3              }
1040   2              else     
1041   2              {
1042   3                      PWM=0;
1043   3              }               
1044   2              TIME_20MS_CT++;
1045   2              if(TIME_20MS_CT>=41U)//20MS ???
1046   2              {
1047   3                      TIME_20MS_CT=0; 
1048   3              
1049   3                      if(POWER_on_TM<=POWER_ON_TM) //2000/20=100      
1050   3                              POWER_on_TM++;
1051   3                                              //20200509
1052   3                      if(A_DET_FL==0||ELE40_BIG_FL||ELE35_BIG_ERR_FL||ELE25_BIG_ERR_FL
1053   3                               ||ELE_InterruptDISP_TM||ELEAP_BIG_ERR_FL||ELEAP_BIG_ERR_FL1
1054   3                         ||ELEAP_BIG_ERR_FL2||ELEAP_BIG_ERR_FL3||ELEAP_BIG_ERR_FL4||ELEAP_BIG_ERR_FL5) //短路控制灯快闪时间
1055   3                      {
1056   4                                              
1057   4                              if(++LED_TM>5)     //20*5=100ms   
1058   4                              {                                                        
1059   5                                      LED_TM=0;
1060   5                                      LED_IO^=1;
1061   5                              }
1062   4                      }
1063   3                      else
1064   3                      if(++LED_TM>12)//0.25s=20ms*12.5
1065   3                      {
1066   4                              LED_TM=0;
1067   4                              LED_pwm++;
1068   4                              if(LED_CT)
1069   4                              {                 
1070   5                                      if(LED_pwm<LED_CT)
1071   5                                      LED_IO^=1;
1072   5                                      else
1073   5                                      LED_IO=0;
1074   5                              }
1075   4                              if(LED_pwm>=(LED_CT+4))
1076   4                              {
1077   5                                      LED_pwm=0;
1078   5                                      LED_IO=1;
1079   5                              }
1080   4                      }       
1081   3                      if(MOS_Err==1)      //上桥短路闪6下
1082   3                      {
1083   4                              LED_CT=12;
1084   4                      }
1085   3                      else if(MOS_Err==2)    //下桥短路闪7下
1086   3                      {
1087   4                              LED_CT=14;
1088   4                      }
1089   3                      else
1090   3                      if(NO_Connet_FL||NO_Connet_FL1)
1091   3                      {
1092   4                              LED_CT=8;
1093   4                      }
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 19  

1094   3                      else
1095   3                      if(VoltageLowFL)
1096   3                      {
1097   4                              LED_CT=4;
1098   4                      }
1099   3                      else           
1100   3                      if(ELE30_BIG_ERR_FL||ELE20_BIG_ERR_FL||ELE28_BIG_ERR_FL/*||ELE25_BIG_ERR_FL||ELE35_BIG_ERR_FL/*||ELEbig2
             -5A_FL||I_Err_LED_FL*/)
1101   3                      {
1102   4                              LED_CT=6;        //3次
1103   4                      }
1104   3                      else
1105   3                      if(Stop_FL)    //充电时，进入灯闪1下
1106   3                      {
1107   4                              LED_CT=2;                         
1108   4                      }
1109   3                      else
1110   3                      {
1111   4                              LED_CT=0;                                                       
1112   4                      }
1113   3            //---------------20ms自加一次------------------------                             
1114   3                      if(DanWei_AD>Vol_3_5V)       //档位AD值判断  三档
1115   3                      {
1116   4                              DanWei=3;                                                                                                                                       
1117   4                      }
1118   3                      else
1119   3                      if(DanWei_AD>Vol_2_5V)       //二档
1120   3                      {
1121   4                              dang_23fl=0;
1122   4                              xiajiang_3dan_timer=0;
1123   4                              xiajiang_2dan_timer=0;
1124   4                              DanWei=2;               
1125   4                      }                                                                
1126   3                      else
1127   3                      if(DanWei_AD>Vol_1V)       //一档
1128   3                      {
1129   4                              dang_23fl=0;
1130   4                              xiajiang_3dan_timer=0;
1131   4                              xiajiang_2dan_timer=0;
1132   4                              DanWei=1;               
1133   4                      }               
1134   3                      else                    //倒档
1135   3                      {
1136   4                              dang_23fl=0;
1137   4                              xiajiang_3dan_timer=0;
1138   4                              xiajiang_2dan_timer=0;
1139   4                              DanWei=0;                        
1140   4                      }                                                                                                                                       
1141   3                      //------------------------------                                
1142   3                                                                                                              
1143   3                              /*if(ELE60_BIG_FL)               //60A过流保护生效标志     三档堵转
1144   3                                       {
1145   3                                              // if(++ELE60_BIG_TM>=10)       //0.02*10=0.2s
1146   3                                               //{
1147   3                                                      ELE40_BIG_FL=1;          //灯快闪
1148   3                                                ELE60_BIG_TM=0;
1149   3                                                      ELE_Wait_5s=40;
1150   3                                               //}
1151   3                                       }
1152   3                                              else
1153   3                                              {
1154   3                                                      ELE60_BIG_TM=0;
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 20  

1155   3                                                      if(ELE_Wait_5s==0)               
1156   3                                                      ELE40_BIG_FL=0;
1157   3                                              }       
1158   3                                              */
1159   3        
1160   3                      if(++time_500ms>25)//0.5s 进入调整一次    20ms自加一次
1161   3                      {
1162   4                              time_500ms=0;     //500ms自加一次
1163   4                                                                                                       
1164   4              //-----在这里更改2min保护   5s保护  2s保护设置---------
1165   4              
1166   4           //----------------------------2min保护-----------------------------------        
1167   4                              if(ELE30_BIG_FL)
1168   4                              {                                               
1169   5                                                      //----------------------三级保护----------------------------------------        
1170   5                                                                                                              
1171   5                                      if(ceshi_zhengchang_FL==0)        //正常模式
1172   5                                      {
1173   6                                              if(DanWei==0||DanWei==1)       //倒档和一档  2min保护  PWM_HallSet
1174   6                                              {
1175   7                                                      if(++ELE30_BIG_TM>=240)//0.5s*240=120s   
1176   7                                                      {
1177   8                                                              ELE30_BIG_ERR_FL=1;  //
1178   8                                                              ELE30_BIG_TM=0;
1179   8                                                              ELE_Wait_5s=40;//WAIT 20S
1180   8                                                      }
1181   7                                              }
1182   6                                      }
1183   5                                      if(DanWei==2)            //二档 2min保护
1184   5                                      {
1185   6                                              if(++ELE30_BIG_TM>=240)//0.5s*240=120s   240
1186   6                                              {
1187   7                                                      ELE30_BIG_ERR_FL=1;//
1188   7                                                      ELE30_BIG_TM=0;
1189   7                                                      ELE_Wait_5s=40;//WAIT 20S
1190   7                                              }                                       
1191   6                                      }
1192   5                                                              
1193   5                                      if(DanWei==3)    //   三档    1min
1194   5                                      {
1195   6                                              if(++ELE30_BIG_TM>=240)//0.5s*240=120s   
1196   6                                              {
1197   7                                                      ELE30_BIG_ERR_FL=1;//
1198   7                                                      ELE30_BIG_TM=0;
1199   7                                                      ELE_Wait_5s=40;//WAIT 20S
1200   7                                              }                                       
1201   6                                      }
1202   5                                                              
1203   5                              }
1204   4                              else
1205   4                              {
1206   5                                      ELE30_BIG_TM=0;
1207   5                                      if(ELE_Wait_5s==0)
1208   5                                      ELE30_BIG_ERR_FL=0;                                     
1209   5                              }
1210   4      
1211   4          //---------------------------5s保护-------（二级保护）-----------------------------------
1212   4                               
1213   4                              if(ELE28_BIG_FL)
1214   4                              {
1215   5                                      if(DanWei==0||DanWei==1) 
1216   5                                      {                                       
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 21  

1217   6                                              if(++ELE28_BIG_TM>=90)//0.5s*90=45S
1218   6                                              {
1219   7                                                      ELE28_BIG_ERR_FL=1;//
1220   7                                                      ELE28_BIG_TM=0;
1221   7                                                      ELE_Wait_5s=40;
1222   7                                              }
1223   6                                      }
1224   5                                              
1225   5                                      if(DanWei==2)
1226   5                                      {
1227   6                                              if(++ELE28_BIG_TM>=60)//0.5s*60=30S
1228   6                                              {
1229   7                                                      ELE28_BIG_ERR_FL=1;//
1230   7                                                      ELE28_BIG_TM=0;
1231   7                                                      ELE_Wait_5s=40;
1232   7                                              }
1233   6                                      }
1234   5                                                      
1235   5                                      if(DanWei==3)
1236   5                                      {
1237   6                                              if(++ELE28_BIG_TM>=40)//0.5s*120=20S
1238   6                                              {
1239   7                                                      ELE28_BIG_ERR_FL=1;//
1240   7                                                      ELE28_BIG_TM=0;
1241   7                                                      ELE_Wait_5s=40;
1242   7                                              }
1243   6                                      }                               
1244   5                              }
1245   4                              else
1246   4                              {
1247   5                                      ELE28_BIG_TM=0;
1248   5                                      if(ELE_Wait_5s==0)
1249   5                                      ELE28_BIG_ERR_FL=0;                                     
1250   5                              }
1251   4      
1252   4          //----------------------------2s保护-----------------------------------
1253   4                              if(ELE50_BIG_FL)
1254   4                              {
1255   5                                      if(DanWei==0||DanWei==1)
1256   5                                      {                                               
1257   6                                              if(++ELE20_BIG_TM>=20)//0.5s*20=10S
1258   6                                              {
1259   7                                                      ELE20_BIG_ERR_FL=1;//
1260   7                                                      ELE20_BIG_TM=0;
1261   7                                                      ELE_Wait_5s=40;
1262   7                                              }
1263   6                                      }
1264   5                                      if(DanWei==2||DanWei==3)
1265   5                                      {
1266   6                                              if(++ELE20_BIG_TM>=10)//0.5s*10=5S
1267   6                                              {
1268   7                                                      ELE20_BIG_ERR_FL=1;//
1269   7                                                      ELE20_BIG_TM=0;
1270   7                                                      ELE_Wait_5s=40;
1271   7                                              }       
1272   6                                      }
1273   5                              }
1274   4                              else
1275   4                              {
1276   5                                      ELE20_BIG_TM=0;        
1277   5                                      if(ELE_Wait_5s==0)
1278   5                                      ELE20_BIG_ERR_FL=0;                                     
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 22  

1279   5                              }
1280   4      
1281   4          //---------------------------------------------
1282   4                              if(ELE12_BIG_FL)                                   //一档堵转生效后  
1283   4                              {                     
1284   5                                      if(++ELE12_BIG_TM>=5)// 5S/0.5*5=2.5s        // 堵转时间保护设置
1285   5                                      {
1286   6                                              duanlu_sw_fl=1;    //禁止电源开关关机
1287   6                                              ELE25_BIG_ERR_FL=1;//
1288   6                                              ELE12_BIG_TM=0;
1289   6                                              ELE_Wait_5s=60;//WAIT 30S
1290   6                                              duZ_close_fl=1;            //堵转后允许关机标志位
1291   6                                      }
1292   5                              }
1293   4                              else
1294   4                              {
1295   5                                      ELE12_BIG_TM=0;
1296   5                                      if(ELE_Wait_5s==0)
1297   5                                      {
1298   6                                              ELE25_BIG_ERR_FL=0;   
1299   6                                              if(duZ_close_fl)
1300   6                                              POWER_IO=0;     //关机
1301   6                                      }                                                                       
1302   5                              }                                        
1303   4                              if(ELE13_BIG_FL)                       //二档堵转生效后
1304   4                              {                     
1305   5                                      if(++ELE13_BIG_TM>=4)// 5S/0.5*4=2s      // 堵转时间保护设置
1306   5                                      {
1307   6                                              duanlu_sw_fl=1;    //禁止电源开关关机
1308   6                                              ELE35_BIG_ERR_FL=1;//
1309   6                                              duZ_close_fl=1;            //堵转后允许关机标志位
1310   6                                              ELE13_BIG_TM=0;
1311   6                                              ELE_Wait_5s=60;//WAIT 30S
1312   6                                      }
1313   5                              }
1314   4                              else
1315   4                              {
1316   5                                      ELE13_BIG_TM=0;
1317   5                                      if(ELE_Wait_5s==0)       //电流没有了，解除保护计时到了   才允许重启
1318   5                                      {
1319   6                                              ELE35_BIG_ERR_FL=0; 
1320   6                                              if(duZ_close_fl)
1321   6                                                      POWER_IO=0;     //关机
1322   6                                      }
1323   5                              } 
1324   4                              /* if(ELE60_BIG_FL)               //60A过流保护生效标志     三档堵转
1325   4                               {
1326   4                                       if(++ELE60_BIG_TM>=2)       //0.5*2=1
1327   4                                       {
1328   4                                              ELE40_BIG_FL=1;          //灯快闪
1329   4                                        ELE60_BIG_TM=0;
1330   4                                              ELE_Wait_5s=40;
1331   4                                       }
1332   4                               }
1333   4                                      else
1334   4                                      {
1335   4                                              ELE60_BIG_TM=0;
1336   4                                              if(ELE_Wait_5s==0)               
1337   4                                              ELE40_BIG_FL=0;
1338   4                                      } */
1339   4                                               
1340   4              //-----------------------------------      //先以70%测试   40A=2.25V=80 
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 23  

1341   4                              if(xianliu_fl==0)                 //没有进入限流
1342   4                              {               
1343   5                                      if((PWM>=175&&PWM<204)&&(DanWei==3)&&Cur_ResultNew>114)    // //70%--79%
1344   5                                      {
1345   6                                              if(++A_P_CT5>=nun_n)  //0.5s*6=3s 
1346   6                                              {
1347   7                                                      ELEAP_BIG_ERR_FL5=1;
1348   7                                                      A_P_CT5=0;
1349   7                                                      ELE_Wait_5s=60;//WAIT 30S
1350   7                                                      duanlu_sw_fl=1;    //禁止电源开关关机
1351   7                                                      duZ_close_fl=1;      //堵转允许关机标志位
1352   7                                              }                                       
1353   6                                      }
1354   5                              }
1355   4                              else
1356   4                              {
1357   5                                      A_P_CT5=0;
1358   5                                      if(ELE_Wait_5s==0)       //电流没有了，解除保护计时到了   才允许重启
1359   5                                      {
1360   6                                              ELEAP_BIG_ERR_FL5=0; 
1361   6                                              if(duZ_close_fl)
1362   6                                              POWER_IO=0;     //关机
1363   6                                      }                        
1364   5                              }                                
1365   4                                                       
1366   4                      //-----------------------------------      //先以60%测试   32A=1.8V=92  
1367   4                                                       
1368   4                              if((PWM>=150&&PWM<175)&&(DanWei==3||DanWei==2)&&Cur_ResultNew>92)    // //60%--69%
1369   4                              {
1370   5                                      if(++A_P_CT4>=nun_n)  //0.5s*2=1s 
1371   5                                      {
1372   6                                              ELEAP_BIG_ERR_FL4=1;
1373   6                                              A_P_CT4=0;
1374   6                                              ELE_Wait_5s=60;//WAIT 30S
1375   6                                              duanlu_sw_fl=1;    //禁止电源开关关机
1376   6                                              duZ_close_fl=1;      //堵转允许关机标志位
1377   6                                      }
1378   5                                                                                      
1379   5                              }
1380   4                              else
1381   4                              {
1382   5                                      A_P_CT4=0;
1383   5                                      if(ELE_Wait_5s==0)       //电流没有了，解除保护计时到了   才允许重启
1384   5                                      {
1385   6                                              ELEAP_BIG_ERR_FL4=0; 
1386   6                                              if(duZ_close_fl)
1387   6                                              POWER_IO=0;     //关机
1388   6                                      }                        
1389   5                              }                                                                                                
1390   4                              //-----------------------------------      //先以50%测试   28A=1.57v=80
1391   4                                                      
1392   4                      //      A_P_ResultNew=((Cur_ResultNew/PWM_HallSet)*10);       //测各占空比50             
1393   4                                                       
1394   4                              if((PWM>=125&&PWM<150)&&(DanWei==3||DanWei==2)&&Cur_ResultNew>80)     //50%--59%
1395   4                              {
1396   5                                      if(++A_P_CT>=nun_n)  //0.5s*2=1s 
1397   5                                      {
1398   6                                              ELEAP_BIG_ERR_FL=1;
1399   6                                              A_P_CT=0;
1400   6                                              ELE_Wait_5s=60;//WAIT 30S
1401   6                                              duanlu_sw_fl=1;    //禁止电源开关关机
1402   6                                              duZ_close_fl=1;      //堵转允许关机标志位
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 24  

1403   6                                      }
1404   5                                                                                      
1405   5                              }
1406   4                              else
1407   4                              {
1408   5                                      A_P_CT=0;
1409   5                                      if(ELE_Wait_5s==0)       //电流没有了，解除保护计时到了   才允许重启
1410   5                                      {
1411   6                                              ELEAP_BIG_ERR_FL=0; 
1412   6                                              if(duZ_close_fl)
1413   6                                              POWER_IO=0;     //关机
1414   6                                      }                        
1415   5                              }
1416   4      
1417   4                                       //-----------------------------------      //先以40%测试   25A=1.40V=57
1418   4                                                                                                       
1419   4                              if((PWM>=102&&PWM<125)&&(DanWei==3||DanWei==2)&&Cur_ResultNew>72)    // //40%--49%
1420   4                              {
1421   5                                      if(++A_P_CT1>=nun_n)  //0.5s*2=1s 
1422   5                                      {
1423   6                                              ELEAP_BIG_ERR_FL1=1;
1424   6                                              A_P_CT1=0;
1425   6                                              ELE_Wait_5s=60;//WAIT 30S
1426   6                                              duanlu_sw_fl=1;    //禁止电源开关关机
1427   6                                              duZ_close_fl=1;      //堵转允许关机标志位
1428   6                                      }
1429   5      
1430   5                              }
1431   4                              else
1432   4                              {
1433   5                                      A_P_CT1=0;
1434   5                                      if(ELE_Wait_5s==0)       //电流没有了，解除保护计时到了   才允许重启
1435   5                                      {
1436   6                                              ELEAP_BIG_ERR_FL1=0; 
1437   6                                              if(duZ_close_fl)
1438   6                                                 POWER_IO=0;     //关机
1439   6                                      }                        
1440   5                              }
1441   4                                       
1442   4                              //-----------------------------------      //先以30%测试   20A=1.125V=57
1443   4                                                                                                       
1444   4                              if((PWM>=76&&PWM<102)&&(DanWei==3||DanWei==2)&&Cur_ResultNew>57)    // //30%--39%
1445   4                              {
1446   5                                      if(++A_P_CT2>=nun_n)  //0.5s*2=1s 
1447   5                                      {
1448   6                                              ELEAP_BIG_ERR_FL2=1;
1449   6                                              A_P_CT2=0;
1450   6                                              ELE_Wait_5s=60;//WAIT 30S
1451   6                                              duanlu_sw_fl=1;    //禁止电源开关关机
1452   6                                              duZ_close_fl=1;      //堵转允许关机标志位
1453   6                                      }
1454   5                              }
1455   4                              else
1456   4                              {
1457   5                                      A_P_CT2=0;
1458   5                                      if(ELE_Wait_5s==0)       //电流没有了，解除保护计时到了   才允许重启
1459   5                                      {
1460   6                                              ELEAP_BIG_ERR_FL2=0; 
1461   6                                              if(duZ_close_fl)
1462   6                                                      POWER_IO=0;     //关机
1463   6                                      }                        
1464   5                              }        
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 25  

1465   4                                              //-----------------------------------      //先20%测试   15A=0.84V=42                                                                            
1466   4                              if((PWM>=51&&PWM<76)&&(DanWei==3||DanWei==2)&&Cur_ResultNew>42)    // //20%--29%
1467   4                              {
1468   5                                      if(++A_P_CT3>=nun_n)  //0.5s*2=1s 
1469   5                                      {
1470   6                                              ELEAP_BIG_ERR_FL3=1;
1471   6                                              A_P_CT3=0;
1472   6                                              ELE_Wait_5s=60;//WAIT 30S
1473   6                                              duanlu_sw_fl=1;    //禁止电源开关关机
1474   6                                               duZ_close_fl=1;      //堵转允许关机标志位
1475   6                                      }                               
1476   5                              }
1477   4                              else
1478   4                              {
1479   5                                      A_P_CT3=0;
1480   5                                      if(ELE_Wait_5s==0)       //电流没有了，解除保护计时到了   才允许重启
1481   5                                      {
1482   6                                              ELEAP_BIG_ERR_FL3=0; 
1483   6                                              if(duZ_close_fl)
1484   6                                              POWER_IO=0;     //关机
1485   6                                      }                        
1486   5                              }
1487   4                      }
1488   3      
1489   3                      if(ELE_Wait_5s)
1490   3                              ELE_Wait_5s--;
1491   3      
1492   3                      if(VoltageLowWait)
1493   3                              VoltageLowWait--;            //500ms自减一次
1494   3              }
1495   2                               
1496   2                                      
1497   2              if(G_S_FL)             //脚踏板
1498   2              {
1499   3                      if(G_S_old_FL)
1500   3                      {
1501   4                              G_S_old_FL=0;
1502   4                              G_S_L2H_FL=1;    
1503   4                      }
1504   3                      // POWER=1;
1505   3                      G_S_FL_CT=0;
1506   3      
1507   3                      HallLowCT=0;
1508   3                      if(Stop_FL==0)
1509   3                              POWER_ON_IO=1;
1510   3                      else
1511   3                              POWER_ON_IO=0;
1512   3      
1513   3              }
1514   2              else
1515   2              {
1516   3                      G_S_old_FL=1;
1517   3                      if(++HallLowCT>15000) //5*60*1000/20=15000   
1518   3                      {
1519   4                              POWER_ON_IO=0;                                                                
1520   4                      }
1521   3              }
1522   2                                                 
1523   2              if(Voltage_AD<Vol16V)
1524   2              {
1525   3                      VoltageLowCT++;                //20ms自加一次 
1526   3                      if(VoltageLowCT>225)     //    225=4.5s      在这里更改低电检测时间
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 26  

1527   3                      {            
1528   4                              VoltageLowFL=1;
1529   4                              turn_zero_fl=0;
1530   4                              VoltageLowWait=40;
1531   4                      }
1532   3              }
1533   2              else
1534   2              {
1535   3                      VoltageLowCT=0;
1536   3                      if((Voltage_AD>Vol21_6V)/*&&(G_S_FL==0)*/&&(VoltageLowWait==0))
1537   3                              VoltageLowFL=0;
1538   3              }
1539   2      
1540   2              if(FRONT_CTRL==0)
1541   2              {
1542   3                      if(FrontOFFTime<250)    //250
1543   3                              FrontOFFTime++; //??????
1544   3              }
1545   2              else
1546   2                      FrontOFFTime=0;
1547   2      
1548   2              if(BACK_CTRL==0)
1549   2              {
1550   3                      if(BackOFFTime<250) 
1551   3                              BackOFFTime++;//??????
1552   3              }
1553   2                       else
1554   2                              BackOFFTime=0;
1555   2              /////////////////////////////////////////////////
1556   2              if(DelayOffTM>1)
1557   2              {
1558   3                      DelayOffTM--;
1559   3                      RELYDelayTM=2;/*刹车2*20MS后再关继电器*/  //2
1560   3              }
1561   2              else     //刹车间隔时间完后
1562   2              {
1563   3      
1564   3                      if(RELYDelayTM)
1565   3                              RELYDelayTM--;
1566   3                      else                       
1567   3                              RELY=0;
1568   3                                      
1569   3                      if(DelayOffTM)
1570   3                      {
1571   4                              DelayOffTM=0;
1572   4                              PWM=0;
1573   4                              MoveCtrl();
1574   4                              if(qudiao_shache_FL==0)                 //各保护不起效，才能输出刹车占空比3%
1575   4                              {                               
1576   5                                      PWM=10;           //1%=2.55     //在这里更改刹车占空比   目前是3%
1577   5                                      MoveCtrl();
1578   5                              }
1579   4                              else     //各保护起效后，停止输出刹车占空比3%
1580   4                              {
1581   5                                      PWM=0;
1582   5                                      MoveCtrl();
1583   5                              }
1584   4                              for(DelayOffTM=0;DelayOffTM<STOP_TM;DelayOffTM++)
1585   4                              {
1586   5                                      if(G_S_FL&&G_S_L2H_FL)
1587   5                                      { 
1588   6                                              G_S_L2H_FL=0;
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 27  

1589   6                                              goto ESC_STOP2;
1590   6                                      }
1591   5                                 
1592   5                                      count_500US_CT=0;
1593   5                                      while(count_500US_CT<=20)//10MS=20    
1594   5                                      {                                                                                 
1595   6                                              if(G_S_FL&&G_S_L2H_FL)
1596   6                                              { 
1597   7                                                      G_S_L2H_FL=0;
1598   7                                                      goto ESC_STOP2;
1599   7                                              }
1600   6                                      }               
1601   5                                                                                              
1602   5                              }
1603   4      
1604   4                              ESC_STOP2:                 
1605   4                                      DelayOffTM=0;     //先关继电器
1606   4                                      FRONT_CTRL=0;
1607   4                                      BACK_CTRL=0;
1608   4                                      count_500US_CT=0;
1609   4                                      while(count_500US_CT<=100)   //100*0.5=50ms  延时1  100
1610   4                                      {                                                       
1611   5                                              if(G_S_FL&&G_S_L2H_FL)
1612   5                                              { 
1613   6                                                      G_S_L2H_FL=0;
1614   6                                                      goto ESC_STOP8;
1615   6                                              }
1616   5                                      }
1617   4      
1618   4                              ESC_STOP8:    
1619   4                                      PWM=0;         //再关PWM
1620   4                                      MoveCtrl();                                                                                                                             
1621   4                                                              
1622   4                                                                       
1623   4                              FRONT_CTRL=0;
1624   4                              BACK_CTRL=0;            
1625   4                              BeginMoveBackTM=0;
1626   4                              BeginMoveFrontTM=0;                              
1627   4                              G_S_L2H_FL=0; 
1628   4                              }
1629   3                      }
1630   2              }
1631   1      }
1632                           
1633           
1634          
1635          void ADC_DSP(void)
1636          {
1637   1      unsigned char ADtemp;
1638   1      //static          unsigned char ele_ct1 ;
1639   1       ADCF=0;
1640   1       ADtemp=ADCRH;
1641   1              
1642   1      if(AD_CH==5)
1643   1      {
1644   2        AD_CH=7;
1645   2        Enable_ADC_AIN0;    //脚踏板霍尔油门  P17
1646   2        clr_ADCF;
1647   2        set_ADCS; 
1648   2        EADC=0;   
1649   2      
1650   2      
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 28  

1651   2           Hall_Add+=ADtemp;            
1652   2                 Hall_Add_ct++;
1653   2                 if(Hall_Add_ct>=8)//>=255)   //??32?,???? 64     //平均了8次
1654   2                 {
1655   3                              //      PROT=!PROT;
1656   3                 Hall_Add_ct=0;
1657   3                 Cur_ResultNew=Hall_Add>>3;//??    //除8    //Cur_ResultNew---电流值
1658   3                 Hall_Add=0;  
1659   3                ///////3.3v==>5v=====                 
1660   3       
1661   3              //==============================  
1662   3                  if(POWER_on_TM<POWER_ON_TM)
1663   3                         Cur_ResultNew=0;
1664   3                              
1665   3               if((Cur_ResultNew>=73)&&(DanWei==1))     //25A=73    73=1.41V      
1666   3                    {
1667   4                          
1668   4                      ELE12_BIG_ct++;
1669   4                      ELE12_Small_ct=0;
1670   4                      if(ELE12_BIG_ct>5)
1671   4                          ELE12_BIG_FL=1;                //一档堵转生效标志
1672   4                    }
1673   3                    else
1674   3                      {
1675   4                                                                              ELE12_BIG_ct=0;
1676   4                                                                              ELE12_Small_ct++;           
1677   4                                                                              if(ELE12_Small_ct>5)
1678   4                                                                              ELE12_BIG_FL=0;
1679   4                      }  
1680   3                                                                      
1681   3                                              if((Cur_ResultNew>=115)&&(DanWei==2))     //35A=100   1.96V     40A=115=2.25V
1682   3                    {
1683   4                      ELE13_BIG_ct++;
1684   4                      ELE13_Small_ct=0;
1685   4                      if(ELE13_BIG_ct>5)
1686   4                       ELE13_BIG_FL=1;            //二档堵转生效标志
1687   4                    }
1688   3                    else
1689   3                      {                                                               
1690   4                                                                              ELE13_Small_ct++;            
1691   4                                                                              if(ELE13_Small_ct>5)      //30
1692   4                                                                              {
1693   5                                                                                      ELE13_BIG_FL=0;
1694   5                                                                                      ELE13_BIG_ct=0;
1695   5                                                                              }
1696   4                      }               
1697   3      
1698   3          /*  if(Cur_ResultNew > ELE60A&&(DanWei==3))//ELE40A)       //60A过流保护    173=3.4V
1699   3                              {               
1700   3                               ELE40_BIG_ct++;
1701   3                               ELE40_Small_ct=0;
1702   3                              // if(ELE40_BIG_ct>5)                   //三档堵转生效标志
1703   3                              // {
1704   3                                       ELE60_BIG_FL=1;                                
1705   3                              // }
1706   3                                               
1707   3                              }
1708   3                              else
1709   3                              {               
1710   3                                      //  RELY=~ RELY;        //约500us自加一次   
1711   3                                      ELE40_BIG_ct=0;
1712   3                                      ELE40_Small_ct++;                       
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 29  

1713   3                                      if(ELE40_Small_ct>5)      //    3ms      
1714   3                                       ELE60_BIG_FL=0;
1715   3                              }*/
1716   3      
1717   3              //------------------------------------------------------        
1718   3        if(Cur_ResultNew > ELE60A&&DanWei==3)           //三档堵转保护
1719   3        {
1720   4                      ELE40_BIG_FL=1;       //保护  灯快闪
1721   4          ELE40_BIG_ct++;
1722   4              ELE40_Small_ct=0;
1723   4       //  if(ELE40_BIG_ct>15)//20=200MS  5=50MS    15--130ms
1724   4        // {
1725   4                        //ELE40_BIG_FL=1;
1726   4                      ELE_Wait_5s=60;        //保护解除要60=30s   0.5s自减一次     120=1min
1727   4              // }
1728   4                       duZ_close_fl=1;      //堵转允许关机标志位
1729   4                      duanlu_sw_fl=1;    //禁止电源开关关机
1730   4        }
1731   3        else
1732   3              {       
1733   4                ELE40_BIG_ct=0;
1734   4                      ELE40_Small_ct++;                       
1735   4                      if((ELE40_Small_ct>5)&&(ELE_Wait_5s==0))  
1736   4                      {               
1737   5                         ELE40_BIG_FL=0;
1738   5                               if(duZ_close_fl)
1739   5                                        POWER_IO=0;     //关机
1740   5                      }                       
1741   4                              
1742   4              }
1743   3      
1744   3      //----------------------------------------------------------
1745   3                                                                                                                      
1746   3        if(Cur_ResultNew>ELE_BIG_SET2)
1747   3            {
1748   4                  
1749   4                                      ELE50_BIG_ct++;
1750   4                                      ELE50_Small_ct=0;
1751   4                                      if(ELE50_BIG_ct>5)
1752   4                                      ELE50_BIG_FL=1;
1753   4            }
1754   3            else
1755   3              {            
1756   4                ELE50_BIG_ct=0;
1757   4                  ELE50_Small_ct++;           
1758   4                  if(ELE50_Small_ct>5)
1759   4                      ELE50_BIG_FL=0;
1760   4              }
1761   3        
1762   3        if(Cur_ResultNew>ELE_BIG_SET1)
1763   3          {
1764   4                
1765   4            ELE30_BIG_ct++;
1766   4            ELE30_Small_ct=0;
1767   4          if(ELE30_BIG_ct>10)
1768   4                ELE30_BIG_FL=1;
1769   4          }
1770   3          else
1771   3            {
1772   4                
1773   4              ELE30_BIG_ct=0;
1774   4                ELE30_Small_ct++;           
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 30  

1775   4                if(ELE30_Small_ct>5)
1776   4                    ELE30_BIG_FL=0;
1777   4            }
1778   3      
1779   3      
1780   3                if(Cur_ResultNew>ELE_BIG_SET3)
1781   3            {
1782   4                  
1783   4              ELE28_BIG_ct++;
1784   4              ELE28_Small_ct=0;
1785   4            if(ELE28_BIG_ct>5)
1786   4                  ELE28_BIG_FL=1;
1787   4            }
1788   3            else
1789   3              {
1790   4                  
1791   4                ELE28_BIG_ct=0;
1792   4                  ELE28_Small_ct++;           
1793   4                  if(ELE28_Small_ct>5)
1794   4                      ELE28_BIG_FL=0;
1795   4              }
1796   3         
1797   3        }
1798   2       }
1799   1        else
1800   1               if(AD_CH==7)
1801   1               {
1802   2                  AD_CH=4;
1803   2            Enable_ADC_AIN1;    //速度开关    P30
1804   2            clr_ADCF;
1805   2            set_ADCS; 
1806   2            EADC=0;
1807   2              // HallPWM=ADtemp;
1808   2                       
1809   2                              //---------油门大于4.8V  停止工作，显示故障灯闪4下
1810   2                      
1811   2                      if(ADtemp>HALL_4000MV) 
1812   2                      {
1813   3                        NO_Connet_FL1=1;
1814   3                      }
1815   2                                       
1816   2                if(ADtemp>HALL_1000MV)    //踩下脚踏  1.33v
1817   2                {
1818   3                      
1819   3                      G_S_HighCT_fanjiao=0;
1820   3         //if(FRONT_CTRL==0&&BACK_CTRL==0)    //50ms生效后，判断继电器是否有吸合  没有才允许脚踏生效
1821   3              //      {
1822   3                  if(G_S_HighCT>=100) //10MS   0.5*20     100=50ms    200ms
1823   3                        {
1824   4                      //      if(FRONT_CTRL==0&&BACK_CTRL==0)    //50ms生效后，判断继电器是否有吸合  没有才允许脚踏生效
1825   4                      //              {
1826   4                      if(turn_zero_fl==1)/*&&(G_S_State==0))*/
1827   4                  {
1828   5                                                              if(G_S_State==0)        
1829   5                     G_S_State=1;
1830   5                                                                                                                        
1831   5                    if(G_S_State==2)
1832   5                                                         G_S_FL=1;         //脚踏板生效               
1833   5                                                }     
1834   4                                      //}
1835   4                       //}
1836   4                  }
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 31  

1837   3                              ADtemp=ADtemp-HALL_1000MV;      //
1838   3                              if(ADtemp>HALL_DV)
1839   3                              ADtemp=HALL_DV;
1840   3      
1841   3                              if((HIGH_LOWS_PEED_FL)&&(DanWei==3))    //高速档
1842   3                              PWM_HallSet=ADtemp*PWM_98_DV/HALL_DV; 
1843   3      
1844   3                       if((HIGH_LOWS_PEED_FL==0)&&(DanWei==2))    //二档
1845   3                              // PWM_HallSet=143;
1846   3                               PWM_HallSet=ADtemp*PWM_65_DV/HALL_DV; 
1847   3      
1848   3                              if((HIGH_LOWS_PEED_FL==0)&&(DanWei==1))    //一档
1849   3                                      PWM_HallSet=80;
1850   3                              //PWM_HallSet=ADtemp*PWM_40_DV/HALL_DV; 
1851   3      
1852   3                              if((HIGH_LOWS_PEED_FL==0)&&(DanWei==0))    //倒档
1853   3                              PWM_HallSet=ADtemp*PWM_40_DV/HALL_DV; 
1854   3      
1855   3                              PWM_HallSet+=PWM_15;    
1856   3                       
1857   3                }
1858   2                else        //放开脚踏
1859   2                {
1860   3                  if(ADtemp>HALL_0500MV)     //且大于0.5V  小于1.33V  
1861   3                              {
1862   4                G_S_HighCT=0;      
1863   4                NO_Connet_FL1=0;
1864   4                               if(G_S_HighCT_fanjiao>=100)    //50ms   连续50ms为低  才认为是松开脚踏
1865   4                               {
1866   5                                  if((Stop_FL==0)&&(VoltageLowFL==0))
1867   5                       turn_zero_fl=1;
1868   5               
1869   5                                               set_PWMRUN;       //PWM运行使能位开启
1870   5                      G_S_FL=0;
1871   5                G_S_State=0;
1872   5                                              PWM_xianzhi_fl=0;
1873   5                                              xianliu_fl=0;      //   限流进入条件解除
1874   5                              
1875   5                               }                                               
1876   4            }
1877   3                              else       //小于0.5V  故障灯闪    
1878   3                              {                       
1879   4                                  NO_Connet_FL1=1;                    
1880   4                              }
1881   3                                              
1882   3                }
1883   2                              
1884   2               }
1885   1               else
1886   1                if(AD_CH==4)//速度和进退检测      
1887   1               {
1888   2                  AD_CH=6;
1889   2            Enable_ADC_AIN7;     //电压检测   P11
1890   2            clr_ADCF;
1891   2            set_ADCS; 
1892   2            EADC=0;
1893   2                 CurDanWei_AD=ADtemp;
1894   2                  volHand_add+=ADtemp;            
1895   2                 volHand_addct++;
1896   2                 if(volHand_addct>=64)//>=255)  
1897   2                 {           
1898   3                 volHand_addct=0;
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 32  

1899   3                 DanWei_AD=volHand_add>>6;              //档位值
1900   3                 volHand_add=0;  
1901   3                  }
1902   2            
1903   2                }
1904   1                 else
1905   1                if(AD_CH==6)//电压检测
1906   1               {
1907   2                  AD_CH=5;
1908   2            Enable_ADC_AIN4;     //电流检测    P05        
1909   2            clr_ADCF;
1910   2            set_ADCS; 
1911   2            EADC=0;
1912   2            // Voltage_AD=ADtemp;
1913   2      
1914   2                         vol_add+=ADtemp;            
1915   2                 vol_addct++;
1916   2                 if(vol_addct==0)//>=64)//>=255)   //??32?,???? 64
1917   2                 {
1918   3                    
1919   3                 vol_addct=0;
1920   3                 Voltage_AD=vol_add>>8;//??
1921   3                 vol_add=0;  
1922   3                  }
1923   2      
1924   2                }
1925   1      
1926   1      }
1927          
1928          void zidongguangji()
1929          {
1930   1              if(FLAG_NMS)
1931   1              {
1932   2           FLAG_NMS=0;     //4ms自加一次
1933   2              
1934   2                      if(duanlu_sw_fl==0)      //当堵转保护后，禁止手动关电源
1935   2                      {
1936   3                              if(SW_FL)
1937   3                                      {
1938   4                                                      if(SW_IO)
1939   4                                               {
1940   5                                                       SW_yanshi++;
1941   5                                                       if(SW_yanshi>=5)   //按键防抖20ms
1942   5                                                       {                                               
1943   6                                                         if(SW_IO)
1944   6                                                               {
1945   7                                                              POWER_IO=0;     //关机
1946   7                                                                       SW_yanshi=5;
1947   7                                                               }
1948   6                                                 }                  
1949   5                                               }                                                                                                       
1950   4                                      }
1951   3                }
1952   2                                      
1953   2               if(SW_IO==0)
1954   2                 {  
1955   3                               
1956   3                                SW_yanshi=0;      //清按键计数
1957   3                             sw_timer++;
1958   3                               
1959   3                          if(sw_timer>=10)    //40ms     //上电40ms后才允许去关机
1960   3                                              {
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 33  

1961   4                                                      sw_timer=0;
1962   4                                                      SW_FL=1;        
1963   4                                              }
1964   3                                      
1965   3                 //----------------------------------                         
1966   3                         if(G_S_IO==0)
1967   3                         {
1968   4                                      if(STOP_IO)        //不充电时进入待机计时    
1969   4                                      {
1970   5                                  guanji_timer++;
1971   5                          
1972   5                                       if(guanji_timer>=250)
1973   5                                        {
1974   6                                               guanji_timer=0;                                
1975   6                                                      guangji_1stimer++;
1976   6                                                 if(guangji_1stimer>=60)      //1min
1977   6                                                 {
1978   7                                                               guangji_1stimer=0;
1979   7                                                                guangji_1mintimer++;
1980   7                                                                  if(guangji_1mintimer>=10)
1981   7                                                                              {
1982   8                                                                               POWER_IO=0;   
1983   8                                                                              }                               
1984   7                                                 }
1985   6                                       }
1986   5                                }
1987   4                         }
1988   3                         else
1989   3                         {                     
1990   4                   guanji_timer=0;
1991   4                                     guangji_1stimer=0;
1992   4                                          guangji_1mintimer=0;
1993   4                         }
1994   3                      }
1995   2      }
1996   1      }
1997          
1998          
1999          //-----------------???-----------------------------
2000          void main(void)
2001          { 
2002   1              init();
2003   1              while(1)
2004   1              {       
2005   2                      //--------看门狗设置------
2006   2                      TA=0xAA;
2007   2                      TA=0x55;
2008   2                      WDCON = 0x7; 
2009   2                      set_WDTR;
2010   2                      set_WDCLR;
2011   2                      set_EWDT;         //WDT看门狗使能位   
2012   2      
2013   2                      PICON=0X80;                       //边沿触发和IO选择   P06
2014   2                      PINEN=0X40;                              //使能--下降沿触发
2015   2                      EIE=0X02;
2016   2      
2017   2                      zidongguangji();   //自动关机程序
2018   2                      //---------------------------           
2019   2                      time_dsp();  
2020   2                      MoveCtrl();
2021   2                      if(ADCF)
2022   2                      ADC_DSP();
C51 COMPILER V9.60.0.0   MAIN                                                              04/04/2022 17:40:24 PAGE 34  

2023   2              }
2024   1      }
2025          
2026          
2027          void init_ISR()  interrupt 7 
2028          {
2029   1          if(PIF==0X40)   //P06 管脚中断标志位   生效位 
2030   1              {                
2031   2                                      Delay3us();
2032   2                              if(A_DET_IO==0)
2033   2                              {
2034   3                                      ELE_InterruptDISP_TM = 20;    //20
2035   3                                      ELE_ERR_FL=1;   
2036   3                                      TurnHighSpeed_FL=0;
2037   3                                      TurnHighSpeed_FL_New=0;                         
2038   3                                      PWM5_P03_OUTPUT_DISABLE;
2039   3                                      PWM4_P01_OUTPUT_DISABLE;
2040   3                                      FLAG_IO_PWM=1;
2041   3                                      P03=1;//换为IO    //下桥
2042   3                                      P01=0;         //上桥
2043   3                                      turn_zero_fl=0;
2044   3                                      clr_PWMRUN;                      //PWM运行使能位关闭
2045   3                                      // A_DET_FL=0;
2046   3                                      PWM=0;     
2047   3      
2048   3                                      //      MoveCtrl();      
2049   3                                      qudiao_shache_FL=1;   //各保护起效后，允许--停止刹车占空比输出
2050   3      
2051   3                                      PIF=0X00;              //清零
2052   3                              }
2053   2                              PIF=0X00;              //清零
2054   2              }
2055   1      }
2056          
2057          
2058          
2059          
2060          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   4496    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =     94    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =     57    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)

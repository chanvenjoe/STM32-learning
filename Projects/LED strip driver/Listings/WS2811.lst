C51 COMPILER V9.60.0.0   WS2811                                                            04/26/2022 16:51:28 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE WS2811
OBJECT MODULE PLACED IN .\Objects\WS2811.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Functions\WS2811.c LARGE ROM(COMPACT) OPTIMIZE(5,SPEED) BROWSE INCDIR(..
                    -\Include) DEFINE(FOSC_160000) DEBUG OBJECTEXTEND PRINT(.\Listings\WS2811.lst) OBJECT(.\Objects\WS2811.obj)

line level    source

   1          #include "WS2811.h"
   2          #include "N76E003.h"
   3          #include "Motor_control.h"
   4          
   5          /***********TYPE DEFINE****************/
   6          
   7          
   8          
   9          /***********VARIABLE DEFINE************/
  10          
  11          /***********Constant variable**********/
  12          
  13          #define RGB_HSV 0               //1 to enable transformation  code
  14          /**************************************/
  15          
  16          Color_Typedef LED_Buf[LEDNUM+1];
  17          
  18          void WS_Send24bits(u32 color)//Be Careful about the direction of rope: Din->Dout
  19          {
  20   1              u8 i;
  21   1              for(i=0;i<24;i++)
  22   1              {
  23   2                      if(color & 0x00800000)// 0000 0000 1000 0000... the highest bit & color, then the MCU can send 24bits da
             -ta to WS2812
  24   2                      {
  25   3                              CODE_1
  26   3                      }
  27   2                      else CODE_0
  28   2                      color<<=1;
  29   2              }
  30   1      }
  31          
  32          void WS_Color_copy(u8 No, u32 color)
  33          {
  34   1              LED_Buf[No].RGB = color;
  35   1      }
  36          
  37          void WS_ColorSet_LED(u8 from, u8 to, u32 color)
  38          {
  39   1              static int temp;
  40   1              color &= 0x00ffffff;// remove the effect of [32-25]
  41   1              if(from>to)
  42   1              {
  43   2                      temp=from; from=to; to=temp;
  44   2              }
  45   1              for(temp = from;temp<=to; temp++)
  46   1              {
  47   2                      WS_Color_copy(temp, color);
  48   2              }
  49   1      }
  50          
  51          void WS_Refresh()
  52          {
  53   1              u8 i;
C51 COMPILER V9.60.0.0   WS2811                                                            04/26/2022 16:51:28 PAGE 2   

  54   1      //      WS_Send24bits(dummy);
  55   1              for( i=0;i<=LEDNUM+1;i++)
  56   1              {
  57   2                      WS_Send24bits(LED_Buf[i].RGB);
  58   2              }
  59   1              RES
  60   1      }
  61          
  62          void WS_Key_RGB(void)
  63          {
  64   1              static u8 temp = 0;
  65   1              switch (temp)
  66   1              {
  67   2                      case 0:
  68   2                              WS_ColorSet_LED(0, LEDNUM, Black);
  69   2                              WS_Refresh();
  70   2                              WS_ColorSet_LED(0, 3, Red);
  71   2                              WS_Refresh();
  72   2                              break;
  73   2                      case 1:
  74   2                              WS_ColorSet_LED(0, LEDNUM, Black);
  75   2                              WS_Refresh();
  76   2                              WS_ColorSet_LED(4, 6, Blue);
  77   2                              WS_Refresh();
  78   2                              break;
  79   2                      case 2:
  80   2                              WS_ColorSet_LED(0, LEDNUM, Black);
  81   2                              WS_Refresh();
  82   2                              WS_ColorSet_LED(7,10, Green);
  83   2                              WS_Refresh();
  84   2                              break;
  85   2              }
  86   1              temp++;
  87   1              if(temp>2)
  88   1                      temp = 0;
  89   1                              
  90   1                      
  91   1      //              WS_Refresh();
  92   1                      Timer0_Delay1ms(50);
  93   1      }
  94          
  95          
  96          void WS_Hue_change()
  97          {
  98   1              u8 cylon=160;
  99   1              u8 cycle;
 100   1      //      u32 temp;
 101   1              static int h=160;
 102   1              if(h>=0&&h<360)
 103   1              {
 104   2                      for(cycle=0;cycle<=LEDNUM;cycle++)
 105   2                      {
 106   3                              WS_ColorSet_LED(0, cycle, HSV_RGB(h, 1,1,0,0,0));
 107   3                              WS_Refresh();
 108   3                              Timer0_Delay1ms(10);
 109   3                      }
 110   2                      h+=10;
 111   2              }
 112   1                      else
 113   1                              h=0;
 114   1      }
 115          
C51 COMPILER V9.60.0.0   WS2811                                                            04/26/2022 16:51:28 PAGE 3   

 116          
 117          #if(RGB_HSV)
              u8      Get_RGB_Max(u8 R, u8 G, u8 B)
              {
                      u8 Max=R;
                      if(Max<G)
                      {
                              Max=G;
                      }
                      if(Max<B)
                      {
                              Max=B;
                      }
                      return Max;
              }
              u8      Get_RGB_Main(u8 R, u8 G, u8 B)
              {
                      u8 Min=R;
                      if(Min>G)
                      {
                              Min=G;
                      }
                      if(Min>B)
                      {
                              Min=B;
                      }
                      return Min;
              }
              
              u8      Get_Hue_Val(u8 R, u8 G, u8 B)
              {
                      u8 Max, Min,Num,Hue;
                      Max = Get_RGB_Max(R,G,B);
                      Min = Get_RGB_Min(R,G,B);
                      if(Max==Min)
                      {
                              Num=First;
                      }
                      else if(Max==R&&(G>=B))
                      {
                              Num=Second;
                      }
                      else if(Max==R&&(G<B))
                      {
                              Num=Third;
                      }
                      else if(Max==G)
                      {
                              Num=Fourth;
                      }
                      else if(Max==B)
                      {
                              Num=Fifth;
                      }
                      else
                      {
                              Num=Non;
                      }
                      switch(Num)
                      {
                              case 0:
                              break;
C51 COMPILER V9.60.0.0   WS2811                                                            04/26/2022 16:51:28 PAGE 4   

                              case 1:
                                      Hue=0;
                              break;
                              case 2:
                                      Hue=60*((R-G)/(Max-Min));
                              break;
                              case 3:
                                      Hue=60*((R-G)/(Max-Min))+360;
                              break;
                              case 4:
                                      Hue=60*((R-G)/(Max-Min))+120;
                              break;
                              case 5:
                                      Hue=60*((R-G)/(Max-Min))+240;
                              break;
                      }
                      return Hue;
              }
              #else
 197          u32 HSV_RGB(int h, char s, char v, float R, float G, float B)
 198          {
 199   1              u32 RGB;
 200   1              u8 R8,G8,B8;
 201   1              char  i;
 202   1              float X,Y,Z,C;
 203   1              i = h/60;               //char i
 204   1              C = h;          //float C
 205   1              C = C/60-i;
 206   1      //      char X = C*(1- (abs((h/60)%2-1)));
 207   1              X = v*(1-s);
 208   1              Y = v*(1-(s*C));
 209   1              Z = v*(1-s*(1-C));
 210   1              
 211   1              switch(i)
 212   1              {
 213   2                      case 0:
 214   2                              R=v; G=Z; B=X;
 215   2                              break;
 216   2                      case 1:
 217   2                              R=Y; G=v; B=X;
 218   2                              break;
 219   2                      case 2:
 220   2                              R=X; G=v; B=Z;
 221   2                              break;
 222   2                      case 3:
 223   2                              R=X; G=Y; B=v;
 224   2                              break;
 225   2                      case 4:
 226   2                              R=Z; G=X; B=v;
 227   2                              break;
 228   2                      case 5:
 229   2                              R=v; G=X; B=Y;
 230   2                              break;
 231   2              }
 232   1              R8=R*255;
 233   1              G8=G*255;
 234   1              B8=B*255;
 235   1              RGB|=R8;
 236   1              RGB<<=8;
 237   1              RGB|=G8;
 238   1              RGB<<=8;
 239   1              RGB|=B8;
C51 COMPILER V9.60.0.0   WS2811                                                            04/26/2022 16:51:28 PAGE 5   

 240   1              return RGB;
 241   1      }
 242          void WS_voice_Pik(void)
 243          {
 244   1              u8 dB;
 245   1              u32 color=0;
 246   1              dB = Get_HallValue();
 247   1              if(dB>=80&&dB<180)
 248   1              {
 249   2                      color = Black|(dB*2);
 250   2                      WS_ColorSet_LED(0,LEDNUM,color);
 251   2                      WS_Refresh();
 252   2                      Timer1_Delay10ms(30);
 253   2                      while(color)
 254   2                      {
 255   3                              color = (color-5)>5? color-5:0;
 256   3                              WS_ColorSet_LED(0,LEDNUM,color);
 257   3                              WS_Refresh();
 258   3                      }
 259   2              }
 260   1              else if(dB>=180)
 261   1              {
 262   2                      color = Black|dB;
 263   2                      color = LED_type? color<<8:color<<16;
 264   2                      WS_ColorSet_LED(0,LEDNUM,color);
 265   2                      WS_Refresh();
 266   2                      Timer1_Delay10ms(30);
 267   2                      while(dB)
 268   2                      {
 269   3                              dB = (dB-5)>5? dB-5:0;
 270   3                              color = Black|dB;
 271   3                              color = LED_type? color<<8:color<<16;
 272   3                              WS_ColorSet_LED(0,LEDNUM,color);
 273   3                              WS_Refresh();
 274   3                      }
 275   2              }
 276   1              else
 277   1              {
 278   2                      WS_ColorSet_LED(0,LEDNUM,0x000000);
 279   2                      WS_Refresh();
 280   2                      Timer1_Delay10ms(5);                    
 281   2              }
 282   1      }
 283          #endif


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2079    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    460      62
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)

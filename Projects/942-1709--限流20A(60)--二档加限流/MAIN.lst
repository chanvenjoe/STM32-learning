C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN MAIN.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE SOURCE\MAIN.c COMPACT OMF2 OPTIMIZE(8,SPEED) BROWSE DEBUG PRINT(.\MAIN.l
                    -st) OBJECT(MAIN.obj)

line level    source

   1          /*--------------------------------------------------------------------------------------------------------
             --*/
   2          /*                                                                                                        
             - */
   3          /* Copyright(c) 2017 Nuvoton Technology Corp. All rights reserved.                                        
             - */
   4          /*                                                                                                        
             - */
   5          /*--------------------------------------------------------------------------------------------------------
             --*/
   6           //升级记录
   7          
   8          ////20170619 G/S修改成低电平有效  .A-DET PORT功能取消 
   9          //20180327 修改为型号M92 1取消大电流增加PWM功能
  10          //2 G/S引脚功能取消，改为由P11采样霍尔控制车速1-2.5V对应高速15-98或低速15-60%     
  11          //20180505 增加刹车脚STOP，P00=STOP;内部上拉；低电平时，停止输出；
  12          //20180507       P00 POWER功能删除
  13          //20180508       P00加上拉
  14          //20181008  //IO改一下；
  15                     //速度开关改为用AD读，且把进退也放在这里检测；
  16                     //增加电压检测
  17                      //GS改为用霍尔
  18          //20181126 //1.三档PWM分别改为：低->40% 中->70% 高->97%;
  19                        //2.缓启动时间降低30%。
  20          //20181210       DelayOffTM=20;改成 DelayOffTM=2; PWM关了，延时拉低FC&BC输出低电平的时间 0.4S， 改成50MS
  21          //20181218   增加电流 18 20 25分别不同时间保护
  22                  //   1 18A，2分钟，
  23                 //    2 20A，5秒钟
  24                 //    3 25A，2秒钟       
  25          //20181219   M92客户 把慢启动时间加快至1.8秒
  26          //20181224 1.去掉P01的电源控制功能，改为控制LED;去掉P10脚功能；使用常闭式电源开关，不再管理电源通断；
  27                   //   2.P01为LED控制脚，可指示电源和故障； 
  28                    //  1高电平有效；
  29                    //  2开机电源灯常亮；
  30                   // 3过流，灯快闪（亮0.1秒，灭0.1秒，保护动作后，循环）；
  31                   //  4欠压，灯闪（亮1秒，灭1秒，保护动作后，循环）；
  32                  //  5充电中，灯亮0.1秒，灭0.5秒，循环；
  33                 // 6解除保护后，灯回复正常长亮；
  34                  // 3.过流检测值加大，
  35                  //   1 25A，2分钟，
  36                 //    2 30A，5秒钟
  37                 //    3 35A，2秒钟        
  38           
  39           //20190105 要三个版本刹车 0秒   慢启动 1.2秒;
  40                     //刹车 0秒   慢启动 1.5秒;
  41                      //刹车 0秒   慢启动 1.8秒;
  42          
  43           //20190225 按文档“功能修改9B20 M92.doc”修改
  44           
  45                  //20190704  去掉档位板上的霍尔调节----ok
  46                  //20190710  将刹车PWM由2%改为3%----ok
  47            //20190717 去掉PWM_EN  同时将PWN改为PWM互补模式（P00为下桥输出  P05为上桥输出）-----ok
  48                  //20190725  加入看门狗程序------------ok
  49                  //20190731  将倒档和一档在6A保护，保护时间由2min改为30s  且二档和三档任保持2min保护-----ok
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 2   

  50           //20190802  倒档电压是：0V--1V 改为：0V--0.5V ---------ok
  51           //          一档电压是：1V--2.5V 改为: 0.5V--2.5V--------ok
  52           //          将低电检测时间由： 2s改为：3s  -----ok     
  53            //20190807  更改每个档位占空比：倒档30% 一档30% 二档60% 三档100%-----------ok      //到这里是出货的版本 
             - 9fe7  600台
  54            //20190828   将死区时间由2us加大到6us-------ok
  55          
  56          //20190829 //1.本版增加MOS管短路检测；
  57                     //2.A_DET大电流检测--没有加检测延时
  58                     //3.脚踏板检测加防接抖，需连续10ms电平不变，才认为是脚踏板有效；
  59          //20190907  //过流保护、档位电流保护，档位板不连接保护时。将停止刹车占空比3%输出-----ok
  60          //20190908  //脚踏后，将延时由10ms加至到50ms生效-----ok
  61          //20190911  //加入测试模式------ok     //到这里是50块样板的出货版本
  62          //20190921   //脚踏板踩下那刻，要判断继电器，接着50ms后，再次判断继电器，无吸合后，才开始mos检测，检测正常
             -则才允许启动--ok         
  63          //20190924     //脚踏板松开时，要加防抖   连续检测到50ms低电平，这时才认为脚踏松开---ok
  64          
  65          //20200509   增加60A级别--过流--灯快闪     
  66          //20210405   油门脚踏变霍尔
  67          //20210416   慢启动时间改为2s
  68          //20210426   增加限流25A功能
  69          //20210508   将最小占空比由20%改至30%
  70          
  71          //20210528   1.限流由25A；2.各档位PWM更改；3.欠压值更改；4.油门故障保护设置大于4V;5.油门启动电压值由1V--1.
             -3V
  72          
  73          //20210806    脚踏快速重启（将继电器判断还在mos管检测前）
  74          
  75          //20210815    增加一二档堵转保护  23A   35A  ---1.5s保护
  76          
  77          //20210902    慢启动改为3s   最大占空比95   
  78           
  79          //20220117    1.堵转保护后 20s 关机
  80          //            2.二档堵转时间由2s减少至1.5s
  81          //            3.二档取消变速功能  和一档一样
  82          
  83          
  84          #include "N76E003.h"
  85          #include <string.h>
  86          #include "Common.h"
  87          #include "Delay.h"
  88          #include "SFR_Macro.h"
  89          
  90          #include "Function_define.h"
  91          #include "TIME_ISP.h"
  92           
  93          #define RELOAD_VALUE_H  (65536-8000)/256 //500US
  94          #define RELOAD_VALUE_L  (65536-8000)%256//500US
  95          
  96            //---------------------------------------------------------
  97          //funtion :Rx IR cortrol FANCAR
  98          //body    :N76E003
  99          //date    :2017 11 28
 100          //in/output:
 101          ////20170619 G/S????????  .A-DET PORT????
 102          //------------------------------------------
 103          
 104          #define  STOP_TM      50//10MS*50=500    刹车时间500MS ,单位10MS  50
 105          
 106          #define  Vol_5V       245       //255 
 107          #define  Vol_4_5V     244       //255    229=4.5
 108          
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 3   

 109          #define  Vol_3_5V   178//255*3.5/5            //档位板电压设置
 110          
 111          #define  Vol_2_5V    128//255*2.5/5
 112          #define  Vol_2V     102//255*2/5
 113          #define  Vol_1V     26//255*1/5  51=1V   26=0.5V
 114          
 115          
 116          #define  Vol_1_88V     96//255*1.88/5   19.2V时IO电压为1.88V
 117          
 118          #define  Vol16V       134//         //欠压检测  低于27V
 119          #define  Vol21_6V     161//     //32.7V  解除欠压   161
 120          
 121          #define     nun_n      6
 122          
 123          
 124          #define POWER_ON_TM         100
 125          
 126          #define  HALL_1000MV         66 //255*1/3.3=77     启动电压由1V改成1.3V
 127          
 128          #define  HALL_4200MV         193//193   //255*2.5/3.3=193
 129          #define  HALL_DV                 (HALL_4200MV-HALL_1000MV) //116
 130          //#define  HALL_DV              66
 131          #define  PWM_15                          25//255*0.15   38
 132          
 133          #define  HALL_4000MV         245        //255*1/3.3=77
 134          
 135          #define   HALL_0500MV    26
 136          
 137          #define  PWM_30                         79//255*60
 138          #define  PWM_30_DV           (PWM_30-PWM_15)//115
 139          
 140          #define  PWM_40                         104//255*60
 141          #define  PWM_40_DV           (PWM_40-PWM_15)//115
 142          
 143          #define  PWM_65                          168//255*60
 144          #define  PWM_65_DV           (PWM_65-PWM_15)//115
 145          
 146          #define  PWM_98                          243//255*98     255=100%     243=95%      248=97%
 147          #define  PWM_98_DV           (PWM_98-PWM_15)//212  
 148          
 149          
 150          #define  ELE10A         42//255*0.466v/5=  10A=33   19
 151          #define  ELE12A         50    //12.5A--5s保护      44
 152          #define  ELE15A                 55//255*0.757v/5        52
 153          
 154          #define  ELE17_5A           61//255*0.886v/5         
 155          #define  ELE21A               71//255*0.886v/5         
 156          #define  ELE25A         82//255*1.255v/5        87
 157                                                      
 158                                                                                                                          
 159          #define  ELE30A         78    //255*1.255v/5  98             27A---2min保护    28.5A--5S保护          99--
             -20200507
 160          #define  ELE32A         92                   //111
 161          #define  ELE35A         100       //255*1.781v/5               113---20200507
 162                  
 163          #define  ELE60A        143//130//230   173---3.4V--60A     3.1V=55A=158    50A=2.81V=143
 164          
 165          
 166          #define  ELE_1A         4
 167          #define  ELE_2A         8//3A
 168          
 169          //#define  PWM_15         40 //255*15/100
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 4   

 170          
 171          #define  PWM_55         140 //255*55/100
 172          #define  PWM_80         204 //255*80/100
 173          
 174          
 175           #define  LED_IO                           P12
 176           #define  LED_SET              P12_PushPull_Mode     //故障指示灯--已改
 177          
 178           #define  LED1_IO                           P15
 179           #define  LED1_SET              P15_PushPull_Mode
 180          
 181          #define  A_0_IO                  P05
 182          #define  A_0_IO_SET              P05_Input_Mode     //电流检测口---ok
 183           
 184          #define  STOP_IO                  P02     /*充电脚*///    ---ok
 185          #define  STOP_IO_SET             P02_Quasi_Mode //P00_Input_Mode ---已改  P02_Quasi_Mode
 186            
 187                  
 188          #define  G_S_IO                  P17
 189          #define  G_S_IO_SET              P17_Input_Mode         
 190                  
 191                  
 192          //#define  G_S_IO                  P10
 193          //#define  G_S_IO_SET              P10_Input_Mode   
 194          
 195          //#define  POWER_SW_IO                P10
 196          //#define  POWER_SW_IO_SET          P10_Quasi_Mode   
 197          
 198          //#define  PROT            P14
 199          //#define  PROT_SET        P14_Quasi_Mode
 200          #define  RELY            P07
 201          #define  RELY_SET        P07_PushPull_Mode     //不用到该IO口
 202          
 203          
 204          #define  BACK_CTRL         P10
 205          #define  BACK_CTRL_SET     P10_PushPull_Mode    //后退---已改
 206          
 207          
 208          #define  FRONT_CTRL        P00  
 209          #define  FRONT_CTRL_SET    P00_PushPull_Mode     //前进---ok
 210          
 211          
 212          #define PWMOUT            P03// FP23  //
 213          #define PWMOUT_SET             P03_PushPull_Mode //    ok
 214          
 215          #define PWMOUTt            P01// FP23  //
 216          #define PWMOUTt_SET            P01_PushPull_Mode //   ok
 217          
 218          
 219          #define  Vol_IO          P11
 220          #define  Vol_IO_SET          P11_Input_Mode     //电压检测---ok
 221          
 222           
 223          #define  A_DET_IO           P06              //短路电流检测---ok
 224          #define  A_DET_IO_SET         P06_Quasi_Mode
 225          
 226          
 227          #define  MOS_DET_IO             P04
 228          #define  MOS_DET_INPUT_SET          P04_Input_Mode
 229            #define  MOS_DET_OUTPUT_SET       P04_PushPull_Mode
 230          
 231          
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 5   

 232          #define  SW_IO           P13
 233          #define  SW_IO_SET          P13_Input_Mode
 234          
 235          #define  POWER_IO          P14
 236          #define  POWER_IO_SET       P14_PushPull_Mode
 237          
 238          
 239          
 240           unsigned char POWER_on_TM;
 241          
 242           unsigned char ELE_BIG_SET2;
 243           unsigned char ELE_BIG_SET1;
 244            unsigned char ELE_BIG_SET3;
 245            unsigned char VoltageLowWait;
 246           unsigned char  ShaCheTM;//2*20MS
 247            unsigned char LED_TM;  //调到闪的频率0.26MS
 248           unsigned char LED_pwm; //中间变量
 249           unsigned char LED_CT;//闪的次数X2
 250           unsigned char CurDanWei_AD;
 251           unsigned char  G_S_HighCT;
 252          unsigned char   ELE_InterruptDISP_TM;
 253          
 254           bit NO_Connet_FL;
 255          
 256          bit turn_zero_fl;
 257           bit  ELE40_BIG_FL;
 258           
 259          bit  xianliu_BIG_ERR_FL;
 260          
 261           bit G_S_old_FL;
 262           bit  G_S_L2H_FL;
 263           
 264             bit  ELE60_BIG_FL;
 265                   
 266           unsigned char ELE40_BIG_ct;
 267           unsigned char  ELE40_Small_ct;
 268          
 269           unsigned char  ELE60_BIG_TM;
 270          
 271           unsigned int NO_Connet_ct;     
 272          
 273            bit POWER_ON_IO ;
 274          
 275           unsigned int  ELE_Wait_5s;
 276           unsigned char  VoltageLowCT;
 277          bit  VoltageLowFL;
 278          unsigned char AD_CH,Voltage_AD,DanWei_AD;//PWM_HallSet;
 279          unsigned char ELE50_BIG_ct;
 280          unsigned char   ELE50_Small_ct=0;
 281          bit     ELE50_BIG_FL;
 282          
 283          unsigned char  DanWei_PWM;
 284          unsigned char PWM_Ele_Set;
 285          unsigned int Hall_Add,HallLowCT;            
 286          unsigned char   Hall_Add_ct;    
 287          unsigned char Cur_ResultNew;
 288          unsigned char  time_500ms;
 289          
 290          unsigned char DanWei;
 291          
 292            unsigned char ELE13_BIG_TM;
 293                  unsigned char ELE13_Small_ct;
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 6   

 294                  unsigned char ELE13_BIG_ct;
 295          
 296                  bit     ELE13_BIG_FL;
 297                  
 298                  bit ELE35_BIG_ERR_FL;
 299                  
 300          bit ELE_ERR_FL;
 301           bit BIT_TMP;
 302           bit FRONT_FL;
 303           bit BACK_FL;
 304           bit HIGH_LOWS_PEED_FLold;
 305          
 306          bit TurnHighSpeed_FL;
 307          bit TurnHighSpeed_FL_New;
 308          
 309                  bit CHANGE;
 310                  bit LA;
 311                  bit CHANGE_FL;
 312                  bit HIGH_LOWS_PEED_FL;
 313                  bit HIGH_LOWS_PEED;
 314          
 315                  bit  ELE12_BIG_FL;
 316                  bit ELE25_BIG_ERR_FL;//
 317                  unsigned char   ELE12_BIG_TM;
 318                  unsigned char ELE12_BIG_ct;
 319                  unsigned char  ELE12_Small_ct;
 320          
 321          
 322                  bit     ELE30_BIG_ERR_FL;//
 323                  unsigned char   ELE30_BIG_TM;
 324          
 325                  bit     ELE20_BIG_ERR_FL;//
 326                  unsigned char   ELE20_BIG_TM;
 327          
 328          
 329          unsigned int       Stop_same;
 330          bit  Stop_FL;
 331          bit Stop_Old;
 332          unsigned char   ELE_BIG_TM;
 333           bit ELE_BIG_FL;
 334           bit G_S_Old;
 335           bit G_S_FL;
 336             unsigned char G_S_State;
 337           unsigned char  G_S_same;
 338          
 339          bit A_DET_FL;
 340          
 341           bit FRONT_BACK_FL;
 342          
 343          
 344          unsigned char   PWMADDTM;//
 345           
 346          unsigned char TIME_20MS_CT;//
 347            
 348          
 349          unsigned char  PWMold;//?????
 350          unsigned char count_500US_CT;//500us
 351          unsigned char PWM;
 352           
 353          unsigned char CHANGE_Off_TM;
 354          
 355           unsigned char  FrontOFFTime;
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 7   

 356          unsigned char   BackOFFTime; 
 357          
 358          
 359          unsigned char  DelayOffTM;//50MS/20MS=3 /*刹车时间*/
 360          unsigned char  BeginMoveBackTM;
 361          unsigned char  BeginMoveFrontTM;
 362          unsigned char  PWM_MAX_Set;               
 363                    
 364           unsigned char Count1S;
 365          
 366          
 367          unsigned char Count2_5MS;     
 368               
 369           unsigned char   G_S_FL_CT;     
 370          
 371           
 372           unsigned char  volHand_addct;
 373           unsigned int   volHand_add;   
 374          
 375            unsigned char  vol_addct;
 376           unsigned int   vol_add;  
 377          
 378           unsigned char ELE30_BIG_ct=0;
 379           unsigned char ELE30_Small_ct;                   
 380                  bit             ELE30_BIG_FL;
 381          
 382          
 383            unsigned char   RELYDelayTM ;
 384          
 385           unsigned char     ELE28_BIG_ct,ELE28_BIG_TM;
 386           unsigned char     ELE28_Small_ct;
 387          
 388             unsigned char MOS_Err;
 389          
 390           
 391            bit              ELE28_BIG_FL;
 392            bit      ELE28_BIG_ERR_FL;
 393          
 394            bit FLAG_IO_PWM;
 395          
 396          //-----------更改增加的变量
 397             bit qudiao_shache_FL;
 398             bit ceshi_zhengchang_FL;
 399                  
 400                   bit yunxun_FL;
 401                   bit shangdian_yunxun_FL;
 402            unsigned char G_S_HighCT_fanjiao;
 403                   
 404             unsigned char PWM_HallSet;
 405                   
 406                           bit PWM_xianzhi_fl;
 407                   
 408                   
 409                   
 410                            bit SW_FL;
 411            unsigned char guanji_timer,guangji_1stimer,guangji_1mintimer;
 412                   unsigned char sw_timer,SW_yanshi;
 413                   bit FLAG_NMS;
 414                   
 415                   bit NO_Connet_FL1;
 416                                  
 417                   bit shache_4ms;
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 8   

 418                  
 419           bit  dang_23fl;
 420                          unsigned char           xiajiang_3dan_timer;
 421                          unsigned char           xiajiang_2dan_timer;
 422          
 423          unsigned char PWM_HUAN;
 424          bit PWM_xianzhi_fl;
 425           unsigned int xianliu65_same;
 426          bit xianliu_fl;
 427          
 428          unsigned char jinxianliuTM;
 429          
 430          bit  duZ_close_fl;
 431          
 432          bit duanlu_sw_fl;
 433          
 434          bit DanWei3_40,DanWei3_65,DanWei2_40;
 435          
 436          bit jia_close_led_fl,huanxing_fl;
 437          
 438          unsigned char sw_songtimer;
 439                  
 440          bit duzhuan_30min_fl;
 441          unsigned char duzhuan_cishu_num;
 442          bit duzhuan_cishu_fl;   
 443          bit jia_zheng_close_fl; 
 444           //unsigned char deadtmphigh,deadtmplow;
 445          
 446          #define UINT16 unsigned int
 447          #define UINT8 unsigned char
 448                  
 449          //unsigned char A_P_ResultNew;
 450          unsigned char  A_P_CT,A_P_CT1,A_P_CT2,A_P_CT3,A_P_CT4,A_P_CT5;
 451          bit ELEAP_BIG_ERR_FL,ELEAP_BIG_ERR_FL1,ELEAP_BIG_ERR_FL2,ELEAP_BIG_ERR_FL3,ELEAP_BIG_ERR_FL4,ELEAP_BIG_ERR
             -_FL5;
 452          
 453          bit xianliu_BIG_FL;
 454          
 455          unsigned char xianliu_Small_ct;
 456          //------------------------------------------------------------------------------------
 457                  
 458          void time_dsp(void);
 459          
 460          
 461          void Delay3us()         //@16MHz
 462          {
 463   1              unsigned char i;
 464   1      
 465   1              _nop_();
 466   1              _nop_();
 467   1              i = 9;
 468   1              while (--i);
 469   1      }
 470          
 471          
 472          //----------------死区时间设置--------------------
 473          /*void PWM_DEAD_TIME_VALUE(UINT16       DeadTimeData)
 474          {
 475                  UINT8 deadtmphigh,deadtmplow;
 476                  deadtmplow = DeadTimeData;
 477                  deadtmphigh = DeadTimeData>>8;
 478                  BIT_TMP = EA;
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 9   

 479                  if (deadtmphigh==0x01)
 480                  {
 481                          EA = 0;
 482                          TA = 0xAA;
 483                          TA = 0x55;
 484                          PDTEN|=0x10;
 485                  }
 486                  TA = 0xAA;
 487                  TA = 0x55;
 488                  PDTCNT = deadtmplow;
 489                  EA = BIT_TMP;
 490          }*/
 491          
 492          void PWM_DEAD_TIME_VALUE()
 493          {
 494   1              UINT8 deadtmphigh,deadtmplow;
 495   1              deadtmplow = 94;
 496   1              deadtmphigh = 11;
 497   1              BIT_TMP = EA;
 498   1              if (deadtmphigh==0x01)
 499   1              {
 500   2                      EA = 0;
 501   2                      TA = 0xAA;
 502   2                      TA = 0x55;
 503   2                      PDTEN|=0x10;
 504   2              }
 505   1              TA = 0xAA;
 506   1              TA = 0x55;
 507   1              PDTCNT = deadtmplow;
 508   1              EA = BIT_TMP;
 509   1      }
 510          
 511          
 512          //---------------------------------
 513          
 514          void init(void)
 515          { 
 516   1          BACK_CTRL=0;
 517   1          FRONT_CTRL=0;   
 518   1      
 519   1              SW_FL=0;
 520   1               
 521   1              SW_IO_SET;
 522   1              NO_Connet_FL1=0;
 523   1              PWM_xianzhi_fl=0;
 524   1              A_DET_IO_SET;
 525   1              
 526   1      PWM_xianzhi_fl=0;
 527   1       STOP_IO_SET;
 528   1       duZ_close_fl=0;      //堵转允许关机标志位
 529   1       A_0_IO_SET;                    
 530   1       RELY_SET;                    
 531   1       BACK_CTRL_SET;                                            
 532   1       FRONT_CTRL_SET;
 533   1        BACK_CTRL=0 ;
 534   1        FRONT_CTRL=0;   
 535   1       PWMOUT_SET;     
 536   1      PWMOUTt_SET;  
 537   1       STOP_IO_SET;   
 538   1       Vol_IO_SET;            
 539   1      // POWER_SW_IO_SET; 
 540   1       LED_SET;
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 10  

 541   1       LED1_SET;   
 542   1      MOS_DET_INPUT_SET;      
 543   1      //  POWER_ON_SET;
 544   1        //  PWM_EN_IO_SET;
 545   1      
 546   1                       PWM5_P03_OUTPUT_ENABLE;        
 547   1                       PWM4_P01_OUTPUT_ENABLE;
 548   1                 PWM_COMPLEMENTARY_MODE;           //设置为互补模式
 549   1                       
 550   1              //PWM4_OUTPUT_INVERSE;  
 551   1                      PWM5_OUTPUT_INVERSE;
 552   1      
 553   1                      set_PDT45EN;    //使能死区
 554   1                      PWM_CLOCK_DIV_32;//PWM_CLOCK_DIV_16=3.9k;         PWM_CLOCK_DIV_32=2k PWM_CLOCK_DIV_64=1k
 555   1                      PWMPH = 0x00;
 556   1                      PWMPL = 0xFF;//F0=4.1K  FF=3.9K
 557   1                      //PWM_DEAD_TIME_VALUE(94);   //死区时间设置   27=2us     81=5us     94=6us
 558   1                      PWM_DEAD_TIME_VALUE();
 559   1      /**********************************************************************
 560   1              PWM frequency = Fpwm/((PWMPH,PWMPL) + 1) <Fpwm = Fsys/PWM_CLOCK_DIV> 
 561   1                                                                      = (16MHz/8)/(0x7CF + 1)
 562   1                                                                      = 1KHz (1ms)
 563   1      ***********************************************************************/        
 564   1                      set_SFRPAGE;                                         //PWM4 and PWM5 duty seting is in SFP page 1
 565   1                      PWM4H = 0x00;                                           
 566   1                      PWM4L = 0x00;
 567   1                      clr_SFRPAGE;                                                                                    
 568   1      
 569   1      //-------- PWM start run--------------
 570   1          set_LOAD;
 571   1          set_PWMRUN;
 572   1      ///////////////////////////////////
 573   1          RH3 = RELOAD_VALUE_H;                       //initial counter values 
 574   1          RL3 = RELOAD_VALUE_L;       
 575   1          set_ET3;                                    //enable Timer3 interrupt
 576   1          set_EA;                                     //enable interrupts
 577   1          set_TR3;
 578   1        /////////////////////////////////                   
 579   1         Enable_ADC_BandGap; 
 580   1          Enable_ADC_AIN0;        //P17脚踏板油门
 581   1      
 582   1                      AD_CH=5;
 583   1                      clr_ADCF;
 584   1                      set_ADCS; 
 585   1                      EADC=0;                                                                                                 
             -                                      // Each time ADC start trig signal
 586   1         // while(ADCF == 0);
 587   1      //////////////////////////////
 588   1      P0=0XFe;
 589   1      //P1=0XDD;
 590   1      //POWER_SW_IO=1;
 591   1       PWM=0;
 592   1      CHANGE_Off_TM=0;
 593   1      PWM_MAX_Set=255;
 594   1      PWMold=1;
 595   1      POWER_ON_IO=1; 
 596   1      //PROT=0;
 597   1      //IO_1=0;
 598   1      //IO_2=0;
 599   1      STOP_IO=1;
 600   1      CHANGE_FL=1;
 601   1      A_DET_FL=1;
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 11  

 602   1      //I_Err_LED_FL=0;
 603   1      PWM_Ele_Set=128;
 604   1      LED_IO=1;           //电源指示灯
 605   1      LED1_IO=0;        //进入测试模式--指示灯
 606   1      POWER_on_TM=0;
 607   1      
 608   1      qudiao_shache_FL=0;
 609   1      ceshi_zhengchang_FL=0;
 610   1      yunxun_FL=0;
 611   1      shangdian_yunxun_FL=1;
 612   1      
 613   1      POWER_IO_SET;
 614   1              
 615   1              POWER_IO=1;    //POWER 上电即是高电平
 616   1      dang_23fl=0;
 617   1      xiajiang_3dan_timer=0;
 618   1      xiajiang_2dan_timer=0;
 619   1      xianliu_fl=0;
 620   1              LED1_IO=0;      
 621   1                      jinxianliuTM=0;
 622   1                      duanlu_sw_fl=0;    //允许电源开关关机
 623   1                      ELEAP_BIG_ERR_FL=0;
 624   1                      
 625   1                      A_P_CT=0;
 626   1                      A_P_CT1=0;
 627   1         A_P_CT2=0;
 628   1               A_P_CT3=0;
 629   1               A_P_CT4=0;
 630   1               A_P_CT5=0;
 631   1               
 632   1                DanWei3_40=0;
 633   1                      DanWei3_65=0;           
 634   1                      DanWei2_40=0;
 635   1                      jia_close_led_fl=0;
 636   1                      huanxing_fl=0;
 637   1                      sw_songtimer=0;
 638   1                      duzhuan_30min_fl=0;
 639   1                      duzhuan_cishu_num=0;
 640   1                      duzhuan_cishu_fl=0;
 641   1                      jia_zheng_close_fl=0;
 642   1                      xianliu_BIG_FL=0;
 643   1                       xianliu_BIG_ERR_FL=0;
 644   1                       xianliu_Small_ct=0;
 645   1       }
 646          
 647          
 648           void Timer3_ISR (void) interrupt 16 
 649          {
 650   1                 clr_TF3;
 651   1          count_500US_CT++;   
 652   1      }
 653          
 654          
 655           void  MoveCtrl(void)
 656           {       
 657   1               
 658   1                 if(FRONT_CTRL==0&&BACK_CTRL==0) 
 659   1                       {
 660   2             if(G_S_State==1)
 661   2             {                                        
 662   3                  G_S_State=2;
 663   3                  MOS_Err=0;
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 12  

 664   3                                               
 665   3                                                      MOS_DET_OUTPUT_SET;
 666   3                                                      MOS_DET_IO=0;//检测前先放电
 667   3                                                      count_500US_CT=0;
 668   3                                                      while(count_500US_CT<=40)//10MS=20
 669   3                                                      {
 670   4                                                       ;
 671   4                                                      }
 672   3                    MOS_DET_INPUT_SET;
 673   3                     count_500US_CT=0;
 674   3                   while(count_500US_CT<=3)         //1.5ms  转变输入检测
 675   3                     {
 676   4                       ;
 677   4                     }
 678   3                    count_500US_CT=0;
 679   3                   while(count_500US_CT<=2)     //1ms
 680   3                     {
 681   4                        if(MOS_DET_IO)              //如果检测到是高电平  
 682   4                        {                   
 683   5                             MOS_Err=1;                //则表明上桥是短路的   闪6下
 684   5                             G_S_State=0xff;
 685   5                        }
 686   4                     }
 687   3                                    
 688   3                     MOS_DET_OUTPUT_SET;      //强输出状态
 689   3                     MOS_DET_IO=1;           //充电
 690   3                    count_500US_CT=0;
 691   3                   while(count_500US_CT<=40)    //40*05=20ms
 692   3                     {                                         
 693   4                        ;
 694   4                     }
 695   3                     MOS_DET_INPUT_SET;       //这里转变IO口  不需要时间转变了？
 696   3                    count_500US_CT=0;
 697   3                   while(count_500US_CT<=2)    //检测1ms
 698   3                     {
 699   4                        if(MOS_DET_IO==0)     // 如果检测是低电平
 700   4                        {                     
 701   5                           MOS_Err=2;          //则表示下桥短路故障     闪7下
 702   5                           G_S_State=0xff;
 703   5                        }
 704   4                     } 
 705   3                                                      
 706   3                                                                                                                               
 707   3          }
 708   2        }
 709   1                       else
 710   1                       {
 711   2                            G_S_State=2;                       
 712   2                       }
 713   1      
 714   1            
 715   1        if(PWMold!=PWM)
 716   1        {
 717   2           PWMold=PWM;
 718   2      
 719   2                      set_SFRPAGE;                                            //PWM4 and PWM5 duty seting is in SFP page 1
 720   2                      PWM4H = 0x00;                                           
 721   2                      PWM4L = (255-PWM);
 722   2                      clr_SFRPAGE;                            
 723   2                       set_LOAD;
 724   2            // if(PWM==0)//>=0xfe)
 725   2                       if(PWM>=0xfe)//==0)
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 13  

 726   2                       {
 727   3                              PWM5_P03_OUTPUT_DISABLE;
 728   3                              PWM4_P01_OUTPUT_DISABLE;
 729   3                              FLAG_IO_PWM=1;
 730   3                              P01=0;//换为IO
 731   3                              P03=0;               //1
 732   3                        // PWM_EN_IO=0;
 733   3                       }
 734   2                       else
 735   2                       // if(PWM>=0xfe)//==0)
 736   2                        if(PWM==0)//>=0xfe)
 737   2                       {
 738   3                              PWM5_P03_OUTPUT_DISABLE;
 739   3                              PWM4_P01_OUTPUT_DISABLE;
 740   3                              FLAG_IO_PWM=1;
 741   3                              P01=0;//换为IO      //上桥
 742   3                              P03=1;            // 下桥
 743   3                              //PWM_EN_IO=0;
 744   3                       }
 745   2                      else
 746   2                      {
 747   3                            if(FLAG_IO_PWM)
 748   3                  {      
 749   4                     
 750   4                              
 751   4                                        PWM5_P03_OUTPUT_ENABLE;    //下桥
 752   4                        count_500US_CT=0;
 753   4                                                                              
 754   4                  
 755   4                                                      
 756   4                      PWM4_P01_OUTPUT_ENABLE;     //上桥
 757   4                              
 758   4      
 759   4                    FLAG_IO_PWM=0;     
 760   4                  }                                                    
 761   3                      }
 762   2      
 763   2        }
 764   1       }
 765          
 766          
 767          void time_dsp(void)
 768          {
 769   1        unsigned char temp;
 770   1              
 771   1         if(count_500US_CT)//;count_500US_CT>=10U;count_500US_CT-=10)//50*10=500US
 772   1                 {
 773   2                   count_500US_CT=0;
 774   2                                
 775   2                              
 776   2                         if(G_S_HighCT<250)     //脚踏  放开清零  按下计数
 777   2                         G_S_HighCT++;      //0.5ms
 778   2                               
 779   2                               if(G_S_HighCT_fanjiao<250)   //脚踏   按下清零   放开计数
 780   2                               G_S_HighCT_fanjiao++;
 781   2      
 782   2      
 783   2              Count2_5MS++;
 784   2          if(Count2_5MS>=8)    //4ms自加一次
 785   2                      {
 786   3                        Count2_5MS=0;
 787   3                  Count1S++;
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 14  

 788   3                                      FLAG_NMS=1;
 789   3                                 shache_4ms=1;
 790   3          if(Count1S>250)
 791   3               {
 792   4              Count1S=0;
 793   4                          
 794   4                       if(ELE_InterruptDISP_TM)
 795   4                               ELE_InterruptDISP_TM--;
 796   4                       
 797   4             if(CHANGE_Off_TM)
 798   4                 {
 799   5                    CHANGE_Off_TM--;
 800   5                      //  PROT=1;
 801   5                        }
 802   4      
 803   4            }
 804   3                }
 805   2       ////////////////////////////////////////////////////           
 806   2                                                                                                  
 807   2       if((MOS_Err)||(A_DET_FL==0)/*(A_DET_IO==0)*/||ELE25_BIG_ERR_FL||ELE35_BIG_ERR_FL||ELE28_BIG_ERR_FL
 808   2               ||ELE30_BIG_ERR_FL||ELE20_BIG_ERR_FL||ELE40_BIG_FL||NO_Connet_FL||NO_Connet_FL1
 809   2       ||ELE_InterruptDISP_TM||ELEAP_BIG_ERR_FL||ELEAP_BIG_ERR_FL1||ELEAP_BIG_ERR_FL2||ELEAP_BIG_ERR_FL3||ELEAP_
             -BIG_ERR_FL4||ELEAP_BIG_ERR_FL5||xianliu_BIG_ERR_FL)
 810   2       {
 811   3              ELE_ERR_FL=1;   
 812   3              TurnHighSpeed_FL=0;
 813   3              TurnHighSpeed_FL_New=0;     
 814   3               qudiao_shache_FL=1;   //各保护起效后，允许--停止刹车占空比输出
 815   3       }
 816   2              else
 817   2       if(G_S_FL==0)
 818   2       {
 819   3                      ELE_ERR_FL=0;
 820   3               TurnHighSpeed_FL=0;
 821   3              TurnHighSpeed_FL_New=0;
 822   3        qudiao_shache_FL=0;      //再次重踩脚踏后，允许标志位-清零
 823   3       }
 824   2       //-------------------------------------
 825   2      
 826   2              
 827   2      //------------------------充电口--正常模式--测试模式入口----------------------
 828   2              
 829   2                 if(STOP_IO)
 830   2                       {
 831   3                               shangdian_yunxun_FL=0;
 832   3                        Stop_same=0;
 833   3            Stop_FL=0;                            //解除充电保护
 834   3                       }      
 835   2          
 836   2              
 837   2              if(STOP_IO==0)    //0为充电模式   1
 838   2                              {
 839   3                                      Stop_same++;    
 840   3                      
 841   3                                      if(Stop_same>4000)   //10ms=20     2s  插入充电插座后2s  功能才生效
 842   3                                      {
 843   4                                              Stop_FL=1;           //进入充电保护
 844   4                                              yunxun_FL=0;
 845   4                                      }       
 846   3                                                                              
 847   3                              }
 848   2              
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 15  

 849   2      //--------------------------------------------------------------------  
 850   2                      
 851   2        if((DanWei_AD>=Vol_4_5V)||(CurDanWei_AD>=Vol_4_5V))              //档位板不连接
 852   2        {
 853   3          if(++NO_Connet_ct>6000)//6000*0.5MS=3S   
 854   3                { 
 855   4                  NO_Connet_FL=1;
 856   4                }
 857   3                
 858   3           goto NoTestAD; 
 859   3         }
 860   2         else
 861   2         {
 862   3      
 863   3                   NO_Connet_ct=0;
 864   3               NO_Connet_FL=0; 
 865   3         }
 866   2      
 867   2       if(DanWei_AD>CurDanWei_AD)/*判断AD变化大不大*/
 868   2        temp= DanWei_AD-CurDanWei_AD; 
 869   2        else
 870   2        temp= CurDanWei_AD-DanWei_AD; 
 871   2        
 872   2        if(temp>=10)
 873   2         goto NoTestAD;
 874   2        
 875   2      //       if(DanWei_AD>Vol_3_5V)          //  三档>3.5v
 876   2              
 877   2              if(DanWei==3)
 878   2        {
 879   3        
 880   3          ELE_BIG_SET1=ELE30A;
 881   3          ELE_BIG_SET2=ELE35A;  
 882   3                ELE_BIG_SET3=ELE32A;
 883   3      
 884   3           ShaCheTM=10;//10*20MS
 885   3           
 886   3          FRONT_BACK_FL=1;
 887   3          DanWei_PWM=0xff;//97%
 888   3                DanWei=3; /*高速档位*/
 889   3                HIGH_LOWS_PEED_FL=1;/*为0低速*/
 890   3                      
 891   3         }
 892   2        // else
 893   2               // if(DanWei_AD>Vol_2_5V)         //二档  2.5V----3.5V
 894   2               if(DanWei==2)
 895   2        {
 896   3             
 897   3           NO_Connet_FL=0;
 898   3          ELE_BIG_SET1=ELE17_5A;
 899   3          ELE_BIG_SET2=ELE25A;
 900   3              ELE_BIG_SET3=ELE21A;
 901   3      
 902   3          ShaCheTM=20;//20*20MS
 903   3          
 904   3          FRONT_BACK_FL=1;
 905   3          DanWei_PWM=153;//65%=166  60%=153
 906   3              DanWei=2;   /*中速档位*/
 907   3              HIGH_LOWS_PEED_FL=0;/*为0低速*/
 908   3         }
 909   2       //  else
 910   2               // if(DanWei_AD>Vol_1V)        //一档    
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 16  

 911   2               if(DanWei==1)
 912   2         {
 913   3            
 914   3                              NO_Connet_FL=0;
 915   3                              ELE_BIG_SET1=ELE10A;
 916   3                              ELE_BIG_SET2=ELE15A;
 917   3                              //ELE_BIG_SET3=0XFF;  ELE12A
 918   3            ELE_BIG_SET3=ELE12A;
 919   3           ShaCheTM=20;//20*20MS
 920   3           
 921   3                              FRONT_BACK_FL=1;
 922   3                              DanWei_PWM=76;//35%=89    76=30%
 923   3                              DanWei=1;  /*低速档位*/
 924   3                              HIGH_LOWS_PEED_FL=0;/*为0低速*/
 925   3         }
 926   2              //else                    //倒挡
 927   2               if(DanWei==0)
 928   2              {
 929   3                      
 930   3                  NO_Connet_FL=0;
 931   3           ELE_BIG_SET1=ELE10A;
 932   3           ELE_BIG_SET2=ELE15A;
 933   3               // ELE_BIG_SET3=0XFF;
 934   3                      ELE_BIG_SET3=ELE12A;
 935   3           ShaCheTM=20;//20*20MS
 936   3           
 937   3               FRONT_BACK_FL=0;
 938   3          DanWei_PWM=76;//40%=102  76=30%
 939   3               DanWei=0;  /*倒档位*/
 940   3               HIGH_LOWS_PEED_FL=0;/*为0低速*/
 941   3              }
 942   2              
 943   2          
 944   2        PWM_Ele_Set=DanWei_PWM;
 945   2        PWM_MAX_Set=PWM_Ele_Set;//128;
 946   2      
 947   2      
 948   2      NoTestAD:
 949   2      
 950   2      if((CHANGE_Off_TM==0)&&G_S_FL&&(ELE_ERR_FL==0))           //脚踏板踏下
 951   2         {
 952   3         
 953   3           if(FRONT_BACK_FL)
 954   3           {
 955   4             FRONT_FL=1;
 956   4             BACK_FL=0;
 957   4            }
 958   3           else
 959   3            {
 960   4             FRONT_FL=0;
 961   4             BACK_FL=1;
 962   4            }
 963   3         }
 964   2         else
 965   2         {     
 966   3                       FRONT_FL=0;
 967   3                       BACK_FL=0;
 968   3         } 
 969   2      
 970   2      
 971   2              if(HIGH_LOWS_PEED_FLold!=HIGH_LOWS_PEED_FL)
 972   2              {
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 17  

 973   3                      HIGH_LOWS_PEED_FLold=HIGH_LOWS_PEED_FL;
 974   3                      TurnHighSpeed_FL=0;
 975   3                      TurnHighSpeed_FL_New=0;
 976   3                      ELE_BIG_TM=0;
 977   3              }
 978   2              
 979   2      
 980   2      ///////////////////////////////////////
 981   2                 if((Stop_FL==1)||(VoltageLowFL==1))               //充电时或者低压时
 982   2                 {
 983   3                                         BeginMoveBackTM=0;
 984   3                             BeginMoveFrontTM=0;
 985   3                 turn_zero_fl=0;
 986   3                 G_S_FL=0;
 987   3                         
 988   3                       }
 989   2                else
 990   2                              
 991   2            if(FRONT_FL)
 992   2              {
 993   3               if(FRONT_CTRL)
 994   3                DelayOffTM=ShaCheTM;//50MS/20MS=3     // 2*20MS后刹车
 995   3                BeginMoveBackTM=0;
 996   3                          if(BeginMoveFrontTM<250)
 997   3                             BeginMoveFrontTM++;
 998   3                
 999   3                                       if(BackOFFTime>24)// 24*20MS后再换向    24
1000   3                                               { 
1001   4                                                      BACK_CTRL=0;
1002   4                                                      FrontOFFTime=0;  
1003   4                                                      FRONT_CTRL=1;
1004   4                                                      RELY=1;
1005   4                                               }
1006   3                                               else
1007   3                                               BeginMoveFrontTM=0;  
1008   3                         }
1009   2              else
1010   2              {
1011   3                                              if(BACK_FL)
1012   3                                               {                      
1013   4                                               if(BACK_CTRL)
1014   4                                               DelayOffTM=ShaCheTM; // 2*20MS后刹车
1015   4                                               BeginMoveFrontTM=0;
1016   4                                               if(BeginMoveBackTM<250)
1017   4                                                      BeginMoveBackTM++;
1018   4                                                              if(FrontOFFTime>24)  // 24*20MS后再换向24
1019   4                                                              {
1020   5                                                                                      FRONT_CTRL=0;
1021   5                                                                                      BackOFFTime=0;
1022   5                                                                                      BACK_CTRL=1;
1023   5                                                                                      RELY=1;
1024   5                                                              }
1025   4                                                              else
1026   4                                                       {
1027   5                                                                      BeginMoveBackTM=0;
1028   5                                                       }
1029   4      
1030   4                                               }
1031   3                                               else
1032   3                                               {
1033   4                                                               BeginMoveBackTM=0;
1034   4                                                   BeginMoveFrontTM=0;
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 18  

1035   4                                               }   
1036   3                        }
1037   2         if((BeginMoveBackTM>100)||(BeginMoveFrontTM>100))            //50ms/0.5MS=100
1038   2            { 
1039   3                   if(PWM<25)          //最小启动占空比设置处
1040   3                     PWM=25;//??
1041   3                                                              
1042   3                       PWMADDTM++;                                //慢启动时间设置
1043   3                      if(PWMADDTM>PWM_HUAN)//18=1.5S  //22==1.8s 11= 0.9s        5=0.4s  3=0.2s  此处调整加速时间      每0.1S =1.222值
             -   12=1.2s    27=3s
1044   3                      {
1045   4                                PWMADDTM=0;
1046   4                                      
1047   4                              if(PWM_xianzhi_fl==0)
1048   4                                      {       
1049   5                                       if((PWM>PWM_HallSet)/*&&(PWM>PWM_Ele_Set)*/&&(PWM>25))         //最小启动占空比设置处   12=1.2s
1050   5                                              PWM--;
1051   5                                                      
1052   5                                              if((PWM<PWM_HallSet)/*&&(ELEbig25A_FL==0)*/)
1053   5                                                      PWM++;
1054   5                              }          
1055   4                                              //---------------限流-----------------
1056   4                                              
1057   4                                               if((Cur_ResultNew>57&&DanWei==3)||(Cur_ResultNew>57&&DanWei==2))    //限流调整  电流大于20A     20A=
             -1.125V
1058   4                                                      {
1059   5                                                              xianliu_Small_ct=0;
1060   5                                                               if(PWM>204&&DanWei==3)    //PWM>80%
1061   5                                                               {
1062   6                                                                        xianliu_fl=1;                                                                                   
1063   6                                                               }
1064   5                                                               
1065   5                                                               if(PWM>140&&DanWei==2)    //PWM>55%
1066   5                                                               {
1067   6                                                                        xianliu_fl=1;                                                                                   
1068   6                                                               }
1069   5                                                               
1070   5                                                              if(xianliu_fl)            //限流开始
1071   5                   {                                                          
1072   6                                                               PWM_xianzhi_fl=1;
1073   6                                                               PWM--;
1074   6                                                               PWM_HUAN=10;
1075   6                                                              
1076   6                                                              if(PWM<101&&DanWei==3)         
1077   6                     PWM=101;               //40%
1078   6                                                        
1079   6                                                              if(PWM<76&&DanWei==2)      //30%   
1080   6                     PWM=76; 
1081   6                                                              
1082   6                                                              if((PWM<=102&&DanWei==3)||(PWM<=78&&DanWei==2))   //进入限流调整 25A 且PWM小于40%时 76=30%    102=4
             -0%
1083   6                                                              {
1084   7                                                              
1085   7                                                                      xianliu65_same++;
1086   7                                                                       if(xianliu65_same>=500)     //5MS*500=2.5s
1087   7                                                                       {
1088   8                                                                                      //ELE30_BIG_ERR_FL=1;
1089   8                                                                      //              ELE_Wait_5s=40;//WAIT 20S
1090   8                                                                                xianliu_BIG_FL=1;
1091   8                                                                                xianliu65_same=0;
1092   8                                                                       }
1093   7                                                                                                                              
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 19  

1094   7                                                              }               
1095   6                                                                                                              
1096   6                                                      /*      if((PWM>102&&DanWei==3)    //计数清零
1097   6                                                              {
1098   6                                                                xianliu65_same=0;                                                     
1099   6                                                              }*/
1100   6                                                      }                               
1101   5                                        }                                             
1102   4                                              //      else
1103   4                                              if(Cur_ResultNew<=57)
1104   4                                                      {
1105   5                                                              //  xianliu65_same=0;
1106   5                                                        //    xianliu_fl=0;      //   限流进入条件解除
1107   5                                                        //    jinxianliuTM=0;
1108   5                                                              xianliu65_same=0;               
1109   5                                                              PWM_xianzhi_fl=0;   //  
1110   5                                                              PWM_HUAN=27;        //24=11ms    
1111   5      
1112   5                                                              /*xianliu_Small_ct++;            
1113   5                                                              if(xianliu_Small_ct>5)      
1114   5                                                              {
1115   5                      xianliu_BIG_FL=0;     //清限流标志位
1116   5                                                                      xianliu_Small_ct=0;
1117   5                                                              }               */                                              
1118   5                                                      } 
1119   4                                                                                      
1120   4           }
1121   3                                                                                       
1122   3                 }
1123   2                 else  
1124   2             {
1125   3                              PWM=0;
1126   3                              if(Cur_ResultNew<=57)
1127   3                              {
1128   4                                      xianliu_Small_ct++;
1129   4                                      if(xianliu_Small_ct>5)
1130   4                                      {
1131   5                                              xianliu_BIG_FL=0;
1132   5                                              xianliu_Small_ct=0;
1133   5                                      }
1134   4                              }
1135   3                         
1136   3                         
1137   3             }        
1138   2              
1139   2                      
1140   2                              TIME_20MS_CT++;
1141   2                               
1142   2                        if(TIME_20MS_CT>=41U)//20MS ???     电源指示灯
1143   2                        {
1144   3                  TIME_20MS_CT=0;     
1145   3                              
1146   3              if(POWER_on_TM<=POWER_ON_TM) //2000/20=100      
1147   3                              POWER_on_TM++;
1148   3                                 
1149   3                                      if(jia_close_led_fl==0)
1150   3                                      {
1151   4                                       if(A_DET_FL==0||ELE40_BIG_FL||ELE35_BIG_ERR_FL||ELE25_BIG_ERR_FL||xianliu_BIG_ERR_FL||ELE_InterruptDI
             -SP_TM) //短路控制灯快闪时间
1152   4                                               
1153   4                                              {
1154   5                                                      
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 20  

1155   5                                                      if(++LED_TM>5)     //20*5=100ms   
1156   5                                                       {                                                       
1157   6                                                               LED_TM=0;
1158   6                                                               LED_IO^=1;
1159   6                                                       }
1160   5                                               }
1161   4                                              else
1162   4                                      if(++LED_TM>12)//0.25s=20ms*12.5
1163   4                                       {
1164   5                                                       LED_TM=0;
1165   5                                                       LED_pwm++;
1166   5      
1167   5                                                                                      if(LED_CT)
1168   5                                                                                              {                 
1169   6                                                                                                       if(LED_pwm<LED_CT)
1170   6                                                                                                              LED_IO^=1;
1171   6                                                                                                              else
1172   6                                                                                                              LED_IO=0;
1173   6                                                                                              }
1174   5                                                                                      
1175   5                                                                               if(LED_pwm>=(LED_CT+4))
1176   5                                                                                              {
1177   6                                                                                                      LED_pwm=0;
1178   6                                                                                                      LED_IO=1;
1179   6                                                                                              
1180   6                                                                                              }                
1181   5                                              }
1182   4                              }
1183   3                              
1184   3                    if(MOS_Err==1)      //上桥短路闪6下
1185   3                      {
1186   4                        LED_CT=12;
1187   4      
1188   4                      }
1189   3                    else if(MOS_Err==2)    //下桥短路闪7下
1190   3                      {
1191   4                        LED_CT=14;
1192   4      
1193   4                      }
1194   3                    else
1195   3                      
1196   3                                    if(NO_Connet_FL||NO_Connet_FL1)
1197   3                      {
1198   4                       LED_CT=8;
1199   4                      }
1200   3                   else
1201   3                  if(VoltageLowFL)
1202   3                      {
1203   4                       LED_CT=4;
1204   4                      }
1205   3                   else           
1206   3                       if(ELE30_BIG_ERR_FL||ELE20_BIG_ERR_FL||ELE28_BIG_ERR_FL)
1207   3                      {
1208   4                       LED_CT=6;       //3次
1209   4                      }
1210   3                       else
1211   3                      if(Stop_FL)    //充电时，进入灯闪1下
1212   3                      {
1213   4                                                                              LED_CT=2;                         
1214   4                      }
1215   3                       else
1216   3                      {
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 21  

1217   4                       LED_CT=0;                                                      
1218   4                      }
1219   3                                                                      
1220   3                                                                      
1221   3            //---------------20ms自加一次------------------------
1222   3                                                                      
1223   3                                        if(DanWei_AD>Vol_3_5V)       //档位AD值判断  三档
1224   3                                                      {       
1225   4                                                                 DanWei=3;                                                                                                                                                                                            
1226   4                                                      }
1227   3                                                       else
1228   3                           if(DanWei_AD>Vol_2_5V)       //二档
1229   3                     {
1230   4                                                                  DanWei=2;           
1231   4                                                               }                                                               
1232   3                                                               else
1233   3                            if(DanWei_AD>Vol_1V)       //一档
1234   3                                                                      {
1235   4                                                                        DanWei=1;             
1236   4                                                                      }               
1237   3                                                                      else                    //倒档
1238   3                                                                       {
1239   4                                                                         DanWei=0;                     
1240   4                                                                       }                                                                       
1241   3                                                                                                                              
1242   3                                      //------------------------------                                
1243   3                                                                                                                              
1244   3                                      /* if(ELE60_BIG_FL)               //60A过流保护生效标志     三档堵转
1245   3                                                       {
1246   3                                                               if(++ELE60_BIG_TM>=25)       //0.02*1=1
1247   3                                                               {
1248   3                                                                       LED1_IO=0;
1249   3                                                                      duanlu_sw_fl=1;    //禁止电源开关关机
1250   3                                                                      duZ_close_fl=1;            //堵转后允许关机标志位
1251   3                                                                      ELE40_BIG_FL=1;          //灯快闪
1252   3                                                                ELE60_BIG_TM=0;
1253   3                                                                      ELE_Wait_5s=60;
1254   3                                                               }
1255   3                                                       }
1256   3                                                              else
1257   3                                                              {
1258   3                                                                      ELE60_BIG_TM=0;
1259   3                                                                      if(ELE_Wait_5s==0) 
1260   3                                                                      {
1261   3                                                                              ELE40_BIG_FL=0;
1262   3                                                                              if(duZ_close_fl)
1263   3                                                                                        POWER_IO=0;     //关机
1264   3                                                                      }                                                                       
1265   3                                                              
1266   3                                                              }*/
1267   3        
1268   3             if(++time_500ms>25)//0.5s 进入调整一次    20ms自加一次
1269   3                               {
1270   4                                       time_500ms=0;     //500ms自加一次
1271   4                                                                                                       
1272   4                          
1273   4              //-----在这里更改2min保护   5s保护  2s保护设置---------
1274   4                                      
1275   4           //----------------------------2min保护-----------------------------------        
1276   4                                 if(ELE30_BIG_FL)
1277   4                                      {
1278   5                                                                                      
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 22  

1279   5                                                      //----------------------三级保护----------------------------------------        
1280   5                                                                                                              
1281   5                                                              if(ceshi_zhengchang_FL==0)        //正常模式
1282   5                                                              {
1283   6                                                              if(DanWei==0||DanWei==1)       //倒档和一档  2min保护  PWM_HallSet
1284   6                                                                              {
1285   7                                                                                      if(++ELE30_BIG_TM>=240)//0.5s*240=120s   
1286   7                                                                                      {
1287   8                                                                                              ELE30_BIG_ERR_FL=1;  //
1288   8                                                                                              ELE30_BIG_TM=0;
1289   8                                                                                              ELE_Wait_5s=40;//WAIT 20S
1290   8                                                                                      }
1291   7                                                                       }
1292   6                                                              }
1293   5                                                              if(DanWei==2)            //二档 2min保护
1294   5                                                              {
1295   6                                                                      if(++ELE30_BIG_TM>=240)//0.5s*240=120s   240
1296   6                                                                      {
1297   7                                                                              ELE30_BIG_ERR_FL=1;//
1298   7                                                                              ELE30_BIG_TM=0;
1299   7                                                                              ELE_Wait_5s=40;//WAIT 20S
1300   7                                                                      }                                       
1301   6                                                              }
1302   5                                                              
1303   5                                                   if(DanWei==3)    //   三档    1min
1304   5                                                              {
1305   6                                                                      if(++ELE30_BIG_TM>=240)//0.5s*240=120s   
1306   6                                                                      {
1307   7                                                                              ELE30_BIG_ERR_FL=1;//
1308   7                                                                              ELE30_BIG_TM=0;
1309   7                                                                              ELE_Wait_5s=40;//WAIT 20S
1310   7                                                                      }                                       
1311   6                                                              }
1312   5                                                              
1313   5                                      }
1314   4                                      else
1315   4                                      {
1316   5                                              ELE30_BIG_TM=0;
1317   5                                         if(ELE_Wait_5s==0)
1318   5                  ELE30_BIG_ERR_FL=0;                                 
1319   5                                      }
1320   4      
1321   4          //---------------------------5s保护-------（二级保护）-----------------------------------
1322   4                               
1323   4                               if(ELE28_BIG_FL)
1324   4                                      {
1325   5                                      if(DanWei==0||DanWei==1) 
1326   5                                              {                                       
1327   6                                               if(++ELE28_BIG_TM>=90)//0.5s*90=45S
1328   6                                                      {
1329   7                                                              ELE28_BIG_ERR_FL=1;//
1330   7                                                              ELE28_BIG_TM=0;
1331   7                                                                      ELE_Wait_5s=40;
1332   7                                                      }
1333   6                                              }
1334   5                                              
1335   5                                                      if(DanWei==2)
1336   5                                                      {
1337   6                                                        if(++ELE28_BIG_TM>=60)//0.5s*60=30S
1338   6                                                                      {
1339   7                                                                              ELE28_BIG_ERR_FL=1;//
1340   7                                                                              ELE28_BIG_TM=0;
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 23  

1341   7                                                                                      ELE_Wait_5s=40;
1342   7                                                                      }
1343   6                                                      }
1344   5                                                      
1345   5                                                      if(DanWei==3)
1346   5                                                      {
1347   6                                                        if(++ELE28_BIG_TM>=40)//0.5s*120=20S
1348   6                                                                      {
1349   7                                                                              ELE28_BIG_ERR_FL=1;//
1350   7                                                                              ELE28_BIG_TM=0;
1351   7                                                                                      ELE_Wait_5s=40;
1352   7                                                                      }
1353   6                                                      }                               
1354   5                                      }
1355   4                                      else
1356   4                                      {
1357   5                                                ELE28_BIG_TM=0;
1358   5                                         if(ELE_Wait_5s==0)
1359   5                   ELE28_BIG_ERR_FL=0;                                        
1360   5                                      }
1361   4      
1362   4          //----------------------------2s保护-----------------------------------
1363   4             if(ELE50_BIG_FL)
1364   4                                      {
1365   5                                              if(DanWei==0||DanWei==1)
1366   5                {                                             
1367   6                                                      if(++ELE20_BIG_TM>=20)//0.5s*20=10S
1368   6                                                      {
1369   7                                                              ELE20_BIG_ERR_FL=1;//
1370   7                                                              ELE20_BIG_TM=0;
1371   7                                                              ELE_Wait_5s=40;
1372   7                                                      }
1373   6                                        }
1374   5                                                      if(DanWei==2||DanWei==3)
1375   5                                                      {
1376   6                                                        if(++ELE20_BIG_TM>=10)//0.5s*10=5S
1377   6                                                              {
1378   7                                                                      ELE20_BIG_ERR_FL=1;//
1379   7                                                                      ELE20_BIG_TM=0;
1380   7                                                                              ELE_Wait_5s=40;
1381   7                                                              }       
1382   6                                                      }
1383   5                                                                                                      
1384   5                                      }
1385   4                                      else
1386   4                                      {
1387   5                                              ELE20_BIG_TM=0;        
1388   5                                         if(ELE_Wait_5s==0)
1389   5                   ELE20_BIG_ERR_FL=0;                                        
1390   5                                      }
1391   4      
1392   4          //---------------------------------------------
1393   4                               if(ELE12_BIG_FL)                                   //一档堵转生效后  
1394   4                                                       {                     
1395   5                                                                      if(++ELE12_BIG_TM>=5)// 5S/0.5*5=2.5s        // 堵转时间保护设置
1396   5                                                               {
1397   6                                                                          duanlu_sw_fl=1;    //禁止电源开关关机
1398   6                                                                                       ELE25_BIG_ERR_FL=1;//
1399   6                                                                                       ELE12_BIG_TM=0;
1400   6                                                                                      // ELE_Wait_5s=10;//WAIT 30S
1401   6                                                                           duZ_close_fl=1;            //堵转后允许关机标志位
1402   6                                                                       
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 24  

1403   6                                                                                       if(duzhuan_30min_fl==0)
1404   6                                                                                       {
1405   7                                                                                               ELE_Wait_5s=6;        //30s    //0.5s自加一次
1406   7                                                                                               jia_zheng_close_fl=0;
1407   7                                                                                       }
1408   6                                                                                       else
1409   6                                                                                       {
1410   7                                                                                               ELE_Wait_5s=36;            //30min=3600
1411   7                                                                                               jia_zheng_close_fl=1;
1412   7                                                                                       }
1413   6                                                                       
1414   6                                                                        duzhuan_cishu_fl=1;
1415   6                                                                       }
1416   5                                                       }
1417   4                                                       else
1418   4                                                       {
1419   5                                                                      ELE12_BIG_TM=0;
1420   5                                                                      if(ELE_Wait_5s==0)
1421   5                                                                      {
1422   6                                                                        if(jia_zheng_close_fl==0)    //假关机
1423   6                                                                                       {
1424   7                                                                                              if(duZ_close_fl)
1425   7                                                                                              {
1426   8                                                                                                       //POWER_IO=0;     //关机                                                                                       
1427   8                                                                                                       LED_IO=0;      //假关机  
1428   8                                                                                                       LED1_IO=1;
1429   8                                                                                                      jia_close_led_fl=1;
1430   8                                                                                                      if(duzhuan_cishu_fl)     //堵转计数
1431   8                                                                                                      {
1432   9                                                                                                                      duzhuan_cishu_num++;
1433   9                                                                                                                      if(duzhuan_cishu_num>=3)
1434   9                                                                                                                      {
1435  10                                                                                                                               duzhuan_30min_fl=1;
1436  10                                                                                                                      //      duzhuan_cishu_num=0;
1437  10                                                                                                                      }
1438   9                                                                                                                      
1439   9                                                                                                                      duzhuan_cishu_fl=0;
1440   9                                                                                                      }
1441   8                                                                                              }
1442   7                                                                                      }
1443   6                                                                                      else
1444   6                                                                                      {
1445   7                                                                                              POWER_IO=0;     //真关机                                                                                
1446   7                                                                                      }
1447   6                                                                      }                                                                       
1448   5                                                       }
1449   4                                                       
1450   4                                                       
1451   4                                               if(ELE13_BIG_FL)                       //二档堵转生效后
1452   4                                                       {                     
1453   5                                                                      if(++ELE13_BIG_TM>=2)// 5S/0.5*4=2s      // 堵转时间保护设置
1454   5                                                               {
1455   6                                                                        duanlu_sw_fl=1;    //禁止电源开关关机
1456   6                                                                               ELE35_BIG_ERR_FL=1;//
1457   6                                                                        duZ_close_fl=1;            //堵转后允许关机标志位
1458   6                                                                               ELE13_BIG_TM=0;
1459   6                                                                       
1460   6                                                                      if(duzhuan_30min_fl==0)
1461   6                                                                       {
1462   7                                                                        ELE_Wait_5s=6;        //30s    //0.5s自加一次
1463   7                                                                               jia_zheng_close_fl=0;
1464   7                                                                       }
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 25  

1465   6                                                                       else
1466   6                                                                       {
1467   7                                                                               ELE_Wait_5s=36; 
1468   7                                                                               jia_zheng_close_fl=1;
1469   7                                                                       }
1470   6                                                                       
1471   6                                                                       duzhuan_cishu_fl=1;
1472   6                                                               }
1473   5                                                       }
1474   4                                                       else
1475   4                                                       {
1476   5                                                                        ELE13_BIG_TM=0;
1477   5                                                                       if(ELE_Wait_5s==0)       //电流没有了，解除保护计时到了   才允许重启
1478   5                                                                       {
1479   6                                                                               if(jia_zheng_close_fl==0)    //假关机
1480   6                                                                                       {
1481   7                                                                                              if(duZ_close_fl)
1482   7                                                                                              {
1483   8                                                                                                       //POWER_IO=0;     //关机                                                                                       
1484   8                                                                                                       LED_IO=0;      //假关机  
1485   8                                                                                                       LED1_IO=1;
1486   8                                                                                                      jia_close_led_fl=1;
1487   8                                                                                                      if(duzhuan_cishu_fl)     //堵转计数
1488   8                                                                                                      {
1489   9                                                                                                                      duzhuan_cishu_num++;
1490   9                                                                                                                      if(duzhuan_cishu_num>=3)
1491   9                                                                                                                      {
1492  10                                                                                                                               duzhuan_30min_fl=1;
1493  10                                                                                                                      //      duzhuan_cishu_num=0;
1494  10                                                                                                                      }
1495   9                                                                                                                      
1496   9                                                                                                                      duzhuan_cishu_fl=0;
1497   9                                                                                                      }
1498   8                                                                                              }
1499   7                                                                                      }
1500   6                                                                                      else
1501   6                                                                                      {
1502   7                                                                                              POWER_IO=0;     //真关机                                                                                
1503   7                                                                                      }
1504   6                                                                       }
1505   5                                                                                                       
1506   5                                                       }       
1507   4                                                       
1508   4                                                      //-------------------------------- 
1509   4                                                       if(ELE60_BIG_FL)               //60A过流保护生效标志     三档堵转
1510   4                                                       {
1511   5                                                               if(++ELE60_BIG_TM>=1)       //0.5*1=1
1512   5                                                               {
1513   6                                                                      // LED1_IO=0;
1514   6                                                                      duanlu_sw_fl=1;    //禁止电源开关关机
1515   6                                                                      duZ_close_fl=1;            //堵转后允许关机标志位
1516   6                                                                      ELE40_BIG_FL=1;          //灯快闪
1517   6                                                                ELE60_BIG_TM=0;
1518   6                                                                       
1519   6                                                                       if(duzhuan_30min_fl==0)
1520   6                                                                       {
1521   7                                                                        ELE_Wait_5s=6;        //30s    //0.5s自加一次
1522   7                                                                               jia_zheng_close_fl=0;
1523   7                                                                       }
1524   6                                                                       else
1525   6                                                                       {
1526   7                                                                               ELE_Wait_5s=36; 
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 26  

1527   7                                                                               jia_zheng_close_fl=1;
1528   7                                                                       }                                                       
1529   6                                                                       duzhuan_cishu_fl=1;
1530   6                                                               }
1531   5                                                       }
1532   4                                                              else
1533   4                                                              {
1534   5                                                                      ELE60_BIG_TM=0;
1535   5                                                                      if(ELE_Wait_5s==0) 
1536   5                                                                      {
1537   6                                                                         //  ELE40_BIG_FL=0;
1538   6                                                                              if(jia_zheng_close_fl==0)    //假关机
1539   6                                                                              {
1540   7                                                                                      if(duZ_close_fl)
1541   7                                                                                      {
1542   8                                                                                               //POWER_IO=0;     //关机                                                                                       
1543   8                                                                                               LED_IO=0;      //假关机  
1544   8                                                                                               LED1_IO=1;
1545   8                                                                                              jia_close_led_fl=1;
1546   8                                                                                              if(duzhuan_cishu_fl)     //堵转计数
1547   8                                                                                              {
1548   9                                                                                                              duzhuan_cishu_num++;
1549   9                                                                                                              if(duzhuan_cishu_num>=3)
1550   9                                                                                                              {
1551  10                                                                                                                        duzhuan_30min_fl=1;
1552  10                                                                                                                      //duzhuan_cishu_num=0;
1553  10                                                                                                              }
1554   9                                                                                                              
1555   9                                                                                                              duzhuan_cishu_fl=0;
1556   9                                                                                              }
1557   8                                                                                      }
1558   7                                                                        }
1559   6                                                                              else
1560   6                                                                              {
1561   7                                                                                POWER_IO=0;     //关机                                                                                        
1562   7                                                                              }
1563   6                                                                      }                                                                       
1564   5                                                              
1565   5                                                              } 
1566   4                                                              
1567   4                                              //--------------------------------------                
1568   4                                                      if(xianliu_BIG_FL)               //60A过流保护生效标志        限流保护的
1569   4                                                       {
1570   5                                                              // if(++ELE60_BIG_TM>=1)       //0.5*1=1
1571   5                                                              // {
1572   5                                                                      // LED1_IO=0;
1573   5                                                                      duanlu_sw_fl=1;    //禁止电源开关关机
1574   5                                                                      duZ_close_fl=1;            //堵转后允许关机标志位
1575   5                                                                      xianliu_BIG_ERR_FL=1;    //灯快闪
1576   5                                                              //  ELE60_BIG_TM=0;
1577   5                                                                       
1578   5                                                                       if(duzhuan_30min_fl==0)
1579   5                                                                       {
1580   6                                                                        ELE_Wait_5s=60;        //30s    //0.5s自加一次
1581   6                                                                               jia_zheng_close_fl=0;
1582   6                                                                       }
1583   5                                                                       else
1584   5                                                                       {
1585   6                                                                               ELE_Wait_5s=3600; 
1586   6                                                                               jia_zheng_close_fl=1;
1587   6                                                                       }                                                       
1588   5                                                                       duzhuan_cishu_fl=1;
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 27  

1589   5                                                              // }
1590   5                                                       }
1591   4                                                              else
1592   4                                                              {
1593   5                                                              //      ELE60_BIG_TM=0;
1594   5                                                                      if(ELE_Wait_5s==0) 
1595   5                                                                      {
1596   6                                                                         //  ELE40_BIG_FL=0;
1597   6                                                                              if(jia_zheng_close_fl==0)    //假关机
1598   6                                                                              {
1599   7                                                                                      if(duZ_close_fl)
1600   7                                                                                      {
1601   8                                                                                               //POWER_IO=0;     //关机                                                                                       
1602   8                                                                                               LED_IO=0;      //假关机  
1603   8                                                                                               LED1_IO=1;
1604   8                                                                                              jia_close_led_fl=1;
1605   8                                                                                              if(duzhuan_cishu_fl)     //堵转计数
1606   8                                                                                              {
1607   9                                                                                                              duzhuan_cishu_num++;
1608   9                                                                                                              if(duzhuan_cishu_num>=3)
1609   9                                                                                                              {
1610  10                                                                                                                        duzhuan_30min_fl=1;
1611  10                                                                                                                      //duzhuan_cishu_num=0;
1612  10                                                                                                              }
1613   9                                                                                                              
1614   9                                                                                                              duzhuan_cishu_fl=0;
1615   9                                                                                              }
1616   8                                                                                      }
1617   7                                                                        }
1618   6                                                                              else
1619   6                                                                              {
1620   7                                                                                POWER_IO=0;     //关机                                                                                        
1621   7                                                                              }
1622   6                                                                      }                                                                       
1623   5                                                              
1624   5                                                              }
1625   4                                                              
1626   4                                                                                               
1627   4         
1628   4                //-----------------------------------------------------------------
1629   4                                              if(ELE_Wait_5s)
1630   4                                              ELE_Wait_5s--;
1631   4      
1632   4                                              if(VoltageLowWait)
1633   4                                               VoltageLowWait--;            //500ms自减一次                                           
1634   4                              }
1635   3                               
1636   3                                      
1637   3      if(G_S_FL)             //脚踏板
1638   3      {
1639   4              
1640   4        if(G_S_old_FL)
1641   4        {
1642   5            G_S_old_FL=0;
1643   5            G_S_L2H_FL=1;    
1644   5      
1645   5        }
1646   4        
1647   4      // POWER=1;
1648   4      G_S_FL_CT=0;
1649   4      
1650   4        HallLowCT=0;
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 28  

1651   4       if(Stop_FL==0)
1652   4       POWER_ON_IO=1;
1653   4       else
1654   4        POWER_ON_IO=0;
1655   4      
1656   4       }
1657   3       else
1658   3       {
1659   4        G_S_old_FL=1;
1660   4      
1661   4      
1662   4         if(++HallLowCT>15000) //5*60*1000/20=15000   
1663   4                      {
1664   5                              POWER_ON_IO=0;                                                                
1665   5                      }
1666   4      
1667   4       }
1668   3                                                 
1669   3                               if(Voltage_AD<Vol16V)
1670   3                               {
1671   4                                    VoltageLowCT++;                //20ms自加一次 
1672   4                                        if(VoltageLowCT>225)     //    225=4.5s      在这里更改低电检测时间
1673   4                         {            
1674   5                                                          VoltageLowFL=1;
1675   5                            turn_zero_fl=0;
1676   5                            VoltageLowWait=40;
1677   5                          }
1678   4                               }
1679   3                               else
1680   3                                 {
1681   4                                      VoltageLowCT=0;
1682   4                                               if((Voltage_AD>Vol21_6V)/*&&(G_S_FL==0)*/&&(VoltageLowWait==0))
1683   4                                                  VoltageLowFL=0;
1684   4                                 }
1685   3      
1686   3      
1687   3      
1688   3        if(FRONT_CTRL==0)
1689   3                {
1690   4                   if(FrontOFFTime<250)    //250
1691   4              FrontOFFTime++; //??????
1692   4           }
1693   3               else
1694   3            FrontOFFTime=0;
1695   3      
1696   3        if(BACK_CTRL==0)
1697   3                 {
1698   4                 if(BackOFFTime<250) 
1699   4              BackOFFTime++;//??????
1700   4           }
1701   3               else
1702   3            BackOFFTime=0;
1703   3      /////////////////////////////////////////////////
1704   3              if(DelayOffTM>1)
1705   3                                 {
1706   4                   DelayOffTM--;
1707   4                                         RELYDelayTM=2;/*刹车2*20MS后再关继电器*/  //2
1708   4                                 }
1709   3                                 else     //刹车间隔时间完后
1710   3                                 {
1711   4                                 
1712   4                                   if(RELYDelayTM)
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 29  

1713   4                                      RELYDelayTM--;
1714   4                                    else                         
1715   4                                        RELY=0;
1716   4                                                      
1717   4                                                if(DelayOffTM)
1718   4                     {
1719   5                         DelayOffTM=0;
1720   5                        PWM=0;
1721   5                       MoveCtrl();
1722   5                    
1723   5                                                              if(qudiao_shache_FL==0)                 //各保护不起效，才能输出刹车占空比3%
1724   5                                                              {                               
1725   6                      PWM=10;           //1%=2.55     //在这里更改刹车占空比   目前是3%
1726   6                       MoveCtrl();
1727   6                                                              }
1728   5                                                              else     //各保护起效后，停止输出刹车占空比3%
1729   5                                                              {
1730   6                                                                 PWM=0;
1731   6                       MoveCtrl();
1732   6                                                              }
1733   5                                      for(DelayOffTM=0;DelayOffTM<STOP_TM;DelayOffTM++)
1734   5                                      {
1735   6                                               if(G_S_FL&&G_S_L2H_FL)
1736   6                         { 
1737   7                           G_S_L2H_FL=0;
1738   7                           goto ESC_STOP2;
1739   7                          }
1740   6                         
1741   6                      count_500US_CT=0;
1742   6                         while(count_500US_CT<=20)//10MS=20    
1743   6                         {                                                                              
1744   7                            if(G_S_FL&&G_S_L2H_FL)
1745   7                            { 
1746   8                            G_S_L2H_FL=0;
1747   8                            goto ESC_STOP2;
1748   8                            }
1749   7                         }            
1750   6                                                                                      
1751   6                                      }
1752   5      
1753   5                               ESC_STOP2:                 
1754   5                                                                                      DelayOffTM=0;     //先关继电器
1755   5                                                                                      FRONT_CTRL=0;
1756   5                                                                                      BACK_CTRL=0;
1757   5                                               
1758   5                                      
1759   5                                                                       count_500US_CT=0;
1760   5                                                                              while(count_500US_CT<=100)   //100*0.5=50ms  延时1  100
1761   5                                                                                      {                                                       
1762   6                                                                                              if(G_S_FL&&G_S_L2H_FL)
1763   6                                                                                               { 
1764   7                                                                                                       G_S_L2H_FL=0;
1765   7                                                                                                      goto ESC_STOP8;
1766   7                                                                                                      }
1767   6                                                                                      }
1768   5                                               
1769   5                                                                                                      
1770   5                                      
1771   5                                       ESC_STOP8:    
1772   5                                                                               PWM=0;         //再关PWM
1773   5                                                                               MoveCtrl();                                                                                                                            
1774   5                    }  
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 30  

1775   4                                                                               
1776   4                                              FRONT_CTRL=0;
1777   4                                              BACK_CTRL=0;            
1778   4                                              BeginMoveBackTM=0;
1779   4                                              BeginMoveFrontTM=0;
1780   4                                      
1781   4                                  }
1782   3                                                                               
1783   3                                G_S_L2H_FL=0; 
1784   3             }                
1785   2                      
1786   2                 } 
1787   1                       
1788   1      }
1789          
1790          void ADC_DSP(void)
1791          {
1792   1      unsigned char ADtemp;
1793   1      //static          unsigned char ele_ct1 ;
1794   1       ADCF=0;
1795   1       ADtemp=ADCRH;
1796   1              
1797   1      if(AD_CH==5)
1798   1      {
1799   2        AD_CH=7;
1800   2        Enable_ADC_AIN0;    //脚踏板霍尔油门  P17
1801   2        clr_ADCF;
1802   2        set_ADCS; 
1803   2        EADC=0;   
1804   2      
1805   2      
1806   2           Hall_Add+=ADtemp;            
1807   2                 Hall_Add_ct++;
1808   2                 if(Hall_Add_ct>=8)//>=255)   //??32?,???? 64     //平均了8次
1809   2                 {
1810   3                              //      PROT=!PROT;
1811   3                 Hall_Add_ct=0;
1812   3                 Cur_ResultNew=Hall_Add>>3;//??    //除8    //Cur_ResultNew---电流值
1813   3                 Hall_Add=0;  
1814   3                ///////3.3v==>5v=====                 
1815   3       
1816   3              //==============================  
1817   3                  if(POWER_on_TM<POWER_ON_TM)
1818   3                         Cur_ResultNew=0;
1819   3                              
1820   3               if(((Cur_ResultNew>=73)&&(DanWei==1))||((Cur_ResultNew>=73)&&(DanWei3_40==1))||((Cur_ResultNew>=7
             -3)&&(DanWei2_40==1))) //一档    //25A=73    73=1.41V      
1821   3                    {
1822   4                          
1823   4                      ELE12_BIG_ct++;
1824   4                      ELE12_Small_ct=0;
1825   4                      if(ELE12_BIG_ct>5)
1826   4                          ELE12_BIG_FL=1;                //一档堵转生效标志
1827   4                    }
1828   3                    else
1829   3                      {
1830   4                                                                              ELE12_BIG_ct=0;
1831   4                                                                              ELE12_Small_ct++;           
1832   4                                                                              if(ELE12_Small_ct>5)
1833   4                                                                              ELE12_BIG_FL=0;
1834   4                      }  
1835   3                                                                      
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 31  

1836   3                                              if(((Cur_ResultNew>=115)&&(DanWei==2))||((Cur_ResultNew>=115)&&(DanWei3_65==1))) //二档    //35A=100 
             -  1.96V     40A=115=2.25V
1837   3                    {
1838   4                      ELE13_BIG_ct++;
1839   4                      ELE13_Small_ct=0;
1840   4                      if(ELE13_BIG_ct>5)
1841   4                       ELE13_BIG_FL=1;            //二档堵转生效标志
1842   4                    }
1843   3                    else
1844   3                      {                                                               
1845   4                                                                              ELE13_Small_ct++;            
1846   4                                                                              if(ELE13_Small_ct>5)      //30
1847   4                                                                              {
1848   5                                                                                      ELE13_BIG_FL=0;
1849   5                                                                                      ELE13_BIG_ct=0;
1850   5                                                                              }
1851   4                      }       
1852   3      
1853   3            if(Cur_ResultNew > ELE60A/*&&(DanWei==3)*/)//ELE40A)       //60A过流保护    173=3.4V
1854   3                              {               
1855   4                              //LED1_IO=1;
1856   4                                ELE40_BIG_ct++;
1857   4                                ELE40_Small_ct=0;
1858   4                               if(ELE40_BIG_ct>1)                   //三档堵转生效标志
1859   4                               {
1860   5                                       ELE60_BIG_FL=1;                                
1861   5                               }                               
1862   4                              }
1863   3                              else
1864   3                              {                                       
1865   4                                      ELE40_BIG_ct=0;
1866   4                                      ELE40_Small_ct++;                       
1867   4                                      if(ELE40_Small_ct>5)      //    3ms      
1868   4                                       ELE60_BIG_FL=0;
1869   4                              }
1870   3      
1871   3              //------------------------------------------------------        
1872   3       /* if(Cur_ResultNew > ELE60A&&DanWei==3)           //三档堵转保护     50A=2.81V=143
1873   3        {
1874   3                      LED1_IO=~LED1_IO;                                            //700us左右
1875   3                      ELE40_BIG_FL=1;       //保护  灯快闪
1876   3          ELE40_BIG_ct++;
1877   3              ELE40_Small_ct=0;
1878   3       //  if(ELE40_BIG_ct>15)//20=200MS  5=50MS    15--130ms
1879   3        // {
1880   3                        //ELE40_BIG_FL=1;
1881   3                      ELE_Wait_5s=60;        //保护解除要60=30s   0.5s自减一次     120=1min
1882   3              // }
1883   3                       duZ_close_fl=1;      //堵转允许关机标志位
1884   3                      duanlu_sw_fl=1;    //禁止电源开关关机
1885   3        }
1886   3        else
1887   3              {       
1888   3                                                                 
1889   3                ELE40_BIG_ct=0;
1890   3                      ELE40_Small_ct++;                       
1891   3                      if((ELE40_Small_ct>5)&&(ELE_Wait_5s==0))  
1892   3                      {               
1893   3                         ELE40_BIG_FL=0;
1894   3                               if(duZ_close_fl)
1895   3                                        POWER_IO=0;     //关机
1896   3                      }                       
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 32  

1897   3                              
1898   3              }*/
1899   3      
1900   3      //----------------------------------------------------------
1901   3                                                                                                                      
1902   3        if(Cur_ResultNew>ELE_BIG_SET2)
1903   3            {
1904   4                  
1905   4                                      ELE50_BIG_ct++;
1906   4                                      ELE50_Small_ct=0;
1907   4                                      if(ELE50_BIG_ct>5)
1908   4                                      ELE50_BIG_FL=1;
1909   4            }
1910   3            else
1911   3              {            
1912   4                ELE50_BIG_ct=0;
1913   4                  ELE50_Small_ct++;           
1914   4                  if(ELE50_Small_ct>5)
1915   4                      ELE50_BIG_FL=0;
1916   4              }
1917   3        
1918   3        if(Cur_ResultNew>ELE_BIG_SET1)
1919   3          {
1920   4                
1921   4            ELE30_BIG_ct++;
1922   4            ELE30_Small_ct=0;
1923   4            if(ELE30_BIG_ct>10)
1924   4                ELE30_BIG_FL=1;
1925   4          }
1926   3          else
1927   3            {       
1928   4              ELE30_BIG_ct=0;
1929   4                ELE30_Small_ct++;           
1930   4                if(ELE30_Small_ct>5)
1931   4                    ELE30_BIG_FL=0;
1932   4            }
1933   3      
1934   3      
1935   3                if(Cur_ResultNew>ELE_BIG_SET3)
1936   3            {
1937   4                  
1938   4              ELE28_BIG_ct++;
1939   4              ELE28_Small_ct=0;
1940   4             if(ELE28_BIG_ct>5)
1941   4              ELE28_BIG_FL=1;
1942   4            }
1943   3            else
1944   3              {
1945   4                  
1946   4                ELE28_BIG_ct=0;
1947   4                  ELE28_Small_ct++;           
1948   4                  if(ELE28_Small_ct>5)
1949   4                      ELE28_BIG_FL=0;
1950   4              }
1951   3         
1952   3        }
1953   2       }
1954   1        else
1955   1               if(AD_CH==7)
1956   1               {
1957   2                  AD_CH=4;
1958   2            Enable_ADC_AIN1;    //速度开关    P30
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 33  

1959   2            clr_ADCF;
1960   2            set_ADCS; 
1961   2            EADC=0;
1962   2              // HallPWM=ADtemp;
1963   2                       
1964   2                              //---------油门大于4.8V  停止工作，显示故障灯闪4下
1965   2                      
1966   2                      if(ADtemp>HALL_4000MV) 
1967   2                      {
1968   3                        NO_Connet_FL1=1;
1969   3                      }
1970   2                                       
1971   2                if(ADtemp>HALL_1000MV)    //踩下脚踏  1.33v
1972   2                {
1973   3                      
1974   3                      G_S_HighCT_fanjiao=0;
1975   3         //if(FRONT_CTRL==0&&BACK_CTRL==0)    //50ms生效后，判断继电器是否有吸合  没有才允许脚踏生效
1976   3              //      {
1977   3                  if(G_S_HighCT>=100) //10MS   0.5*20     100=50ms    200ms
1978   3                        {
1979   4                      //      if(FRONT_CTRL==0&&BACK_CTRL==0)    //50ms生效后，判断继电器是否有吸合  没有才允许脚踏生效
1980   4                      //              {
1981   4                      if(turn_zero_fl==1)/*&&(G_S_State==0))*/
1982   4                  {
1983   5                                                              if(G_S_State==0)        
1984   5                     G_S_State=1;
1985   5                                                                                                                        
1986   5                    if(G_S_State==2)
1987   5                                                         G_S_FL=1;         //脚踏板生效               
1988   5                                                }     
1989   4                                      //}
1990   4                       //}
1991   4                  }
1992   3                              ADtemp=ADtemp-HALL_1000MV;      //
1993   3                              if(ADtemp>HALL_DV)
1994   3                              ADtemp=HALL_DV;
1995   3      
1996   3                              
1997   3                              if((HIGH_LOWS_PEED_FL)&&(DanWei==3))    //高速档
1998   3                              {
1999   4                                 if(ADtemp<47)           //10%---40%  对应的电压
2000   4                                       {
2001   5                                                      PWM_HallSet=80;       //就是40%
2002   5                                               DanWei3_40=1;
2003   5                                               DanWei3_65=0;
2004   5                                       }                                       
2005   4                                      if(ADtemp>=47&&ADtemp<86)     //40%---65%  对应的电压
2006   4                                      {
2007   5                                  PWM_HallSet=143;        //就是65%
2008   5                                              DanWei3_65=1;
2009   5                                               DanWei3_40=0;
2010   5                                      }
2011   4                                              if(ADtemp>=86)        //大于65%    对应的电压
2012   4                                              {
2013   5                                    PWM_HallSet=ADtemp*PWM_98_DV/HALL_DV;      //有霍尔变速
2014   5                                                       DanWei3_40=0;
2015   5                                                       DanWei3_65=0;
2016   5                                              }
2017   4                              }
2018   3                      
2019   3                       if((HIGH_LOWS_PEED_FL==0)&&(DanWei==2))    //二档  65%
2020   3                       {
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 34  

2021   4                          if(ADtemp<95)       //10%--50%  统一40%
2022   4                                      {
2023   5                                          PWM_HallSet=80;       //就是40%
2024   5                                                DanWei2_40=1;
2025   5                                      }
2026   4                                       if(ADtemp>=95)
2027   4                                       {
2028   5                                         PWM_HallSet=143;        //就是65% 
2029   5                                                DanWei2_40=0;
2030   5                                       }
2031   4                       
2032   4                       }
2033   3                               // PWM_HallSet=143;
2034   3                              // PWM_HallSet=ADtemp*PWM_65_DV/HALL_DV; 
2035   3      
2036   3                              if((HIGH_LOWS_PEED_FL==0)&&(DanWei==1))    //一档   40%
2037   3                                      PWM_HallSet=80;                             
2038   3                              //PWM_HallSet=ADtemp*PWM_40_DV/HALL_DV; 
2039   3      
2040   3                              if((HIGH_LOWS_PEED_FL==0)&&(DanWei==0))    //倒档   40%
2041   3                              PWM_HallSet=ADtemp*PWM_40_DV/HALL_DV; 
2042   3      
2043   3                              PWM_HallSet+=PWM_15;    
2044   3                       
2045   3                }
2046   2                else        //放开脚踏
2047   2                {
2048   3                  if(ADtemp>HALL_0500MV)     //且大于0.5V  小于1.33V  
2049   3                              {
2050   4                G_S_HighCT=0;      
2051   4                NO_Connet_FL1=0;
2052   4                               if(G_S_HighCT_fanjiao>=100)    //50ms   连续50ms为低  才认为是松开脚踏
2053   4                               {
2054   5                                  if((Stop_FL==0)&&(VoltageLowFL==0))
2055   5                       turn_zero_fl=1;
2056   5               
2057   5                                               set_PWMRUN;       //PWM运行使能位开启
2058   5                      G_S_FL=0;
2059   5                G_S_State=0;
2060   5                                              PWM_xianzhi_fl=0;
2061   5                                              xianliu_fl=0;      //   限流进入条件解除
2062   5                              
2063   5                                              DanWei3_40=0;
2064   5                                              DanWei3_65=0;
2065   5                                              DanWei2_40=0;
2066   5                               }                                               
2067   4            }
2068   3                              else       //小于0.5V  故障灯闪    
2069   3                              {                       
2070   4                                  NO_Connet_FL1=1;                    
2071   4                              }
2072   3                                              
2073   3                }
2074   2                              
2075   2               }
2076   1               else
2077   1                if(AD_CH==4)//速度和进退检测      
2078   1               {
2079   2                  AD_CH=6;
2080   2            Enable_ADC_AIN7;     //电压检测   P11
2081   2            clr_ADCF;
2082   2            set_ADCS; 
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 35  

2083   2            EADC=0;
2084   2                 CurDanWei_AD=ADtemp;
2085   2                  volHand_add+=ADtemp;            
2086   2                 volHand_addct++;
2087   2                 if(volHand_addct>=64)//>=255)  
2088   2                 {           
2089   3                 volHand_addct=0;
2090   3                 DanWei_AD=volHand_add>>6;              //档位值
2091   3                 volHand_add=0;  
2092   3                  }
2093   2            
2094   2                }
2095   1                 else
2096   1                if(AD_CH==6)//电压检测
2097   1               {
2098   2                  AD_CH=5;
2099   2            Enable_ADC_AIN4;     //电流检测    P05        
2100   2            clr_ADCF;
2101   2            set_ADCS; 
2102   2            EADC=0;
2103   2            // Voltage_AD=ADtemp;
2104   2      
2105   2                         vol_add+=ADtemp;            
2106   2                 vol_addct++;
2107   2                 if(vol_addct==0)//>=64)//>=255)   //??32?,???? 64
2108   2                 {
2109   3                    
2110   3                 vol_addct=0;
2111   3                 Voltage_AD=vol_add>>8;//??
2112   3                 vol_add=0;  
2113   3                  }
2114   2      
2115   2                }
2116   1      
2117   1      }
2118          
2119          void zidongguangji()
2120          {
2121   1              if(FLAG_NMS)
2122   1              {
2123   2           FLAG_NMS=0;     //4ms自加一次
2124   2              if(jia_close_led_fl==0)
2125   2              {
2126   3                      if(duanlu_sw_fl==0)      //当堵转保护后，禁止手动关电源
2127   3                      {
2128   4                              if(SW_FL)
2129   4                                      {
2130   5                                                      if(SW_IO)
2131   5                                               {
2132   6                                                       SW_yanshi++;
2133   6                                                       if(SW_yanshi>=5)   //按键防抖20ms
2134   6                                                       {                                               
2135   7                                                         if(SW_IO)
2136   7                                                               {
2137   8                                                              POWER_IO=0;     //关机
2138   8                                                                       SW_yanshi=5;
2139   8                                                               }
2140   7                                                 }                  
2141   6                                               }                                                                                                       
2142   5                                      }
2143   4                }
2144   3              }
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 36  

2145   2              
2146   2                      if(jia_close_led_fl)      //当堵转保护计时灯灭后   按一下重新唤醒
2147   2                      {
2148   3                         if(huanxing_fl==0)
2149   3                                      {
2150   4                                                      if(SW_IO)
2151   4                                               {
2152   5                                                       SW_yanshi++;
2153   5                                                       if(SW_yanshi>=5)   //按键防抖20ms
2154   5                                                       {                                               
2155   6                                                         if(SW_IO)
2156   6                                                               {
2157   7                                                                        huanxing_fl=1;                                                        
2158   7                                                           LED_IO=1;      //开指示灯   亮
2159   7                                                                       duZ_close_fl=0;
2160   7                                                                       duanlu_sw_fl=0;
2161   7                                                                        xianliu_BIG_ERR_FL=0;
2162   7                                                                      
2163   7                                                                              ELE40_BIG_FL=0; 
2164   7                                                                              ELE35_BIG_ERR_FL=0; 
2165   7                                                                              ELE25_BIG_ERR_FL=0;   
2166   7                                                                       SW_yanshi=0;
2167   7                                                               }
2168   6                                                 }                  
2169   5                                               }              
2170   4                sw_songtimer=0;                                        
2171   4                                      }
2172   3                                      
2173   3                                      if(huanxing_fl)
2174   3                                      {
2175   4                                         if(SW_IO==0)
2176   4                                               {                       
2177   5                                                                       sw_songtimer++;
2178   5                                                       
2179   5                                                              if(sw_songtimer>=10)    //40ms   
2180   5                                                                      {
2181   6                                                                               jia_close_led_fl=0;
2182   6                                                                               sw_songtimer=0;
2183   6                                                                              huanxing_fl=0;
2184   6                                                                      }
2185   5                                               }
2186   4                                      }
2187   3                                      
2188   3                }
2189   2                      
2190   2                      
2191   2                                      
2192   2               if(SW_IO==0)
2193   2                 {                     
2194   3                                SW_yanshi=0;      //清按键计数
2195   3                             sw_timer++;
2196   3                               
2197   3                          if(sw_timer>=10)    //40ms     //上电40ms后才允许去关机
2198   3                                              {
2199   4                                                      sw_timer=0;
2200   4                                                      SW_FL=1;        
2201   4                                              }
2202   3                                      
2203   3                 //----------------------------------                         
2204   3                         if(G_S_IO==0)
2205   3                         {
2206   4                                      if(STOP_IO)        //不充电时进入待机计时    
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 37  

2207   4                                      {
2208   5                                              if(ELE_Wait_5s==0)     //
2209   5                                              {
2210   6                                  guanji_timer++;
2211   6                          
2212   6                                       if(guanji_timer>=250)
2213   6                                        {
2214   7                                               guanji_timer=0;                                
2215   7                                                      guangji_1stimer++;
2216   7                                                 if(guangji_1stimer>=60)      //1min
2217   7                                                 {
2218   8                                                               guangji_1stimer=0;
2219   8                                                                guangji_1mintimer++;
2220   8                                                                  if(guangji_1mintimer>=10)     //
2221   8                                                                              {
2222   9                                                                               POWER_IO=0;   
2223   9                                                                              }                               
2224   8                                                 }
2225   7                                               }
2226   6                                       }
2227   5                                }
2228   4                         }
2229   3                         else
2230   3                         {                     
2231   4                   guanji_timer=0;
2232   4                                     guangji_1stimer=0;
2233   4                                          guangji_1mintimer=0;
2234   4                         }
2235   3                      }
2236   2      }
2237   1      }
2238          
2239          
2240          //-----------------???-----------------------------
2241          void main(void)
2242          { 
2243   1        init();
2244   1       while(1)
2245   1        {  
2246   2                      
2247   2                      
2248   2                      //--------看门狗设置------
2249   2            TA=0xAA;
2250   2            TA=0x55;
2251   2            WDCON = 0x7; 
2252   2           set_WDTR;
2253   2           set_WDCLR;
2254   2           set_EWDT;         //WDT看门狗使能位   
2255   2          
2256   2                      PICON=0X80;                       //边沿触发和IO选择   P06
2257   2                      PINEN=0X40;                              //使能--下降沿触发
2258   2                      EIE=0X02;
2259   2                                              
2260   2                       zidongguangji();   //自动关机程序
2261   2                      //---------------------------           
2262   2          time_dsp();  
2263   2          MoveCtrl();
2264   2          if(ADCF)
2265   2          ADC_DSP();
2266   2       
2267   2        }
2268   1      }
C51 COMPILER V9.60.0.0   MAIN                                                              04/29/2022 12:00:43 PAGE 38  

2269          
2270          
2271          void init_ISR()  interrupt 7 
2272          {
2273   1          if(PIF==0X40)   //P06 管脚中断标志位   生效位 
2274   1                      {                
2275   2                                      Delay3us();
2276   2                              if(A_DET_IO==0)
2277   2                              {
2278   3                        ELE_InterruptDISP_TM = 20;    //20
2279   3                              ELE_ERR_FL=1;   
2280   3                              TurnHighSpeed_FL=0;
2281   3                              TurnHighSpeed_FL_New=0;                         
2282   3                              PWM5_P03_OUTPUT_DISABLE;
2283   3                              PWM4_P01_OUTPUT_DISABLE;
2284   3                              FLAG_IO_PWM=1;
2285   3                              P03=1;//换为IO    //下桥
2286   3                              P01=0;         //上桥
2287   3                              turn_zero_fl=0;
2288   3                        clr_PWMRUN;                      //PWM运行使能位关闭
2289   3                      // A_DET_FL=0;
2290   3                              PWM=0;     
2291   3                              
2292   3                              //      MoveCtrl();      
2293   3                        qudiao_shache_FL=1;   //各保护起效后，允许--停止刹车占空比输出
2294   3                                      
2295   3                                      PIF=0X00;              //清零
2296   3                              }
2297   2                                PIF=0X00;            //清零
2298   2                      }
2299   1      }
2300          
2301          
2302          
2303          
2304          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   4637    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =     98    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =     67    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)

/*
 * sw_spi.c
 *
 *  Created on: Jan 31, 2024
 *      Author: kzhou
 */
#include "sw_spi.h"

unsigned int Get_24bit_Weight(char channel_gain)
{
	unsigned int weight=0;
	SW_SPI_PWR_ON; //Pull down clk

	while(SW_SPI_DAT_RDY)
	{
		SW_SPI_CLK_H;
//		delay_us(1);
		SW_SPI_CLK_L;
	}

	for(char i = 24; i!=0; i--)
	{
		SW_SPI_CLK_H;
		weight = weight<<1;
	//	delay_us(1);
		SW_SPI_CLK_L;
		if(SW_SPI_DAT_RDY)
		{
		 weight+=1;
		}
		delay_us(1);
	}
	SW_SPI_CLK_H;
//	delay_us(1);
	weight = weight^0x800000;
	SW_SPI_CLK_L;

	//Preserved for channel selection

	return weight;
}

void Get_weight(HX711_Structure* weight_par)		// AKg * AVDDmV/X Kg = Y   A:weight AVDD:sensor power X:max weight of load cell Y:AD reading from module
{													// Example: A Kg * 3.24mV/10Kg => A*128 = 0.324*128AmV = 41.472AmV  => 41.472AmV/AD = 3.24V/0xffffff => AD = 214748.352A(Kg)  A(g) = AD/214.748
	weight_par->gross_weight = Get_24bit_Weight(CHA_128);
	if(weight_par->calibration_flag)
	{
		if(weight_par->gross_weight - weight_par->calibrated_value>0)
			weight_par->gram = (weight_par->gross_weight - weight_par->calibrated_value)/LOAD_CELL_FACTOR;
		else
			weight_par->gram = 0;

		//Kalman  filter
	}
}

void HX711_Calibration(HX711_Structure* weight_par)
{
	  /*******Get gross weight**************/
	  SW_SPI_PWR_OFF;
	  delay_us(200);
	  SW_SPI_PWR_ON;
	  weight_par->calibrated_value = Get_24bit_Weight(CHA_128);
	  delay_us(2000);
	  weight_par->calibrated_value = Get_24bit_Weight(CHA_128);

	  printf("calibration weight:%d", weight_par->calibrated_value);
	  weight_par->calibration_flag = 1; //Calibration done

}

void PWM_Delegation(HX711_Structure* weight_par)
{
	static char dc_pwm;
	if(weight_par->gram>PULL_FORCE_THR)
	{
		HAL_GPIO_WritePin(GPIOC, GPIO_PIN_0, RESET);
		AHBL_ON;
		dc_pwm = dc_pwm>=95? 99:dc_pwm+2;
		if(dc_pwm>20)
			__HAL_TIM_SET_COMPARE(&htim1, TIM_CHANNEL_1, dc_pwm);
	}
	else
	{
		HAL_GPIO_WritePin(GPIOC, GPIO_PIN_0, SET);
		CLOSE_PWM;
		dc_pwm = 0;
		__HAL_TIM_SET_COMPARE(&htim1, TIM_CHANNEL_1, dc_pwm);
	}
}




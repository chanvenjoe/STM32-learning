/*
 * BLDC.c
 *
 *  Created on: Aug 8, 2023
 *      Author: kzhou
 */

#include "BLDC.h"


void BLDC_Driving_test()// The driving sequence is 1-5-4-6-2-3
{
	static int i=1;
	switch(i)
	{
	case 1:
		AHBL_ON;
//		printf("AB\r\n");
		break;
	case 6:
		AHCL_ON;
//		printf("CB\r\n");
		break;
	case 5:
		BHCL_ON;
//		printf("CA\r\n");
		break;
	case 4:
		BHAL_ON;
//		printf("BA\r\n");
		break;
	case 3:
		CHAL_ON;
//		printf("BC\r\n");
		break;
	case 2:
		CHBL_ON;
//		printf("AC\r\n");
		break;
	default:
		CLOSE_ALL;
		break;
	}
	i= i==6? 1:i+1;
}

void BLDC_Phase_switching(MADC_Structure * adc_val)
{
		adc_val->commutation_timeout+=1;
		switch(adc_val->bemf_now)
		{
			case 5:
				AHBL_ON;
				__HAL_TIM_SET_COUNTER(&htim15, 0);//the auto reload is set to 65535
					HAL_TIM_Base_Start(&htim15);
	//			printf("\r\nAB");
				break;
			case 4:
				AHCL_ON;
		//		printf("\r\nAC");
				break;
			case 6:
				BHCL_ON;
		//		printf("\r\nBC");
				break;
			case 2:
				BHAL_ON;
		//		printf("\r\nBA");
				break;
			case 3:
				CHAL_ON;
		//		printf("\r\nCA");
				break;
			case 1:
				CHBL_ON;
				HAL_TIM_Base_Stop(&htim15);
		//		printf("\r\nCB");
				break;
//			default:
//				BLDC_Driving_test();

		}
//		adc_val->commutation_delay = 10000;

}

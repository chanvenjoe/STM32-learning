/*
 * BLDC.c
 *
 *  Created on: Aug 8, 2023
 *      Author: kzhou
 */

#include "BLDC.h"


void BLDC_Driving_test()// The driving sequence is 1-5-4-6-2-3
{
	static int i=1;
	switch(i)
	{
	case 1:
		AHBL_ON;
//		printf("AB\r\n");
		break;
	case 2:
		AHCL_ON;
//		printf("CB\r\n");
		break;
	case 3:
		BHCL_ON;
//		printf("CA\r\n");
		break;
	case 4:
		BHAL_ON;
//		printf("BA\r\n");
		break;
	case 5:
		CHAL_ON;
//		printf("BC\r\n");
		break;
	case 6:
		CHBL_ON;
//		printf("AC\r\n");
		break;
	default:
		break;
	}
	i= i==6? 1:i+1;
}

void BLDC_Phase_switching(MADC_Structure * adc_val)
{
	static char cross_zero_flag=0;
//	adc_val->bemf_last = adc_val->bemf_now;
	adc_val->bemf_now  = adc_val->bemf_pa * 4 + adc_val->bemf_pb * 2 + adc_val->bemf_pc * 1;
	if(adc_val->bemf_now ==0)
		adc_val->bemf_now = 1;
//	adc_val->bemf_now  = adc_val->bemf_now ==0? adc_val->bemf_last : adc_val->bemf_now;
/*	static char count = 0;
	if(adc_val->bemf_now != adc_val->bemf_last)
	{
		count++;
		if(count>5)
		{
			adc_val->bemf_last = adc_val->bemf_now;
			cross_zero_flag = 1;
			printf("\r\ncross0");
		}
	}*/

//	if(cross_zero_flag==1) //filter
//	{
		switch(adc_val->bemf_now)
		{
			case 5:
				AHBL_ON;
				printf("\r\nAB");
				cross_zero_flag = 0;
				break;
			case 4:
				AHCL_ON;
				printf("\r\nAC");
				cross_zero_flag = 0;
				break;
			case 6:
				BHCL_ON;
				printf("\r\nBC");
				cross_zero_flag = 0;
				break;
			case 2:
				BHAL_ON;
				printf("\r\nBA");
				cross_zero_flag = 0;
				break;
			case 3:
				CHAL_ON;
				printf("\r\nCA");
				cross_zero_flag = 0;
				break;
			case 1:
				CHBL_ON;
				printf("\r\nCB");
				cross_zero_flag = 0;
				break;
			default:
				break;

		}
//	}

}
